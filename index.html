<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° RPG PRO: REMASTER</title>
<style>
/* [1. í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì •] */
@font-face { font-family: 'NeoDunggeunmo'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.3/NeoDunggeunmo.woff') format('woff'); font-weight: normal; font-style: normal; }

:root { 
    --bg-dark: #121013; 
    --bg-panel: #222034; 
    --text-main: #e0d8e8; 
    --accent: #f1c40f; 
    --primary: #8e44ad; 
    --success: #2ecc71; 
    --danger: #e74c3c;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; touch-action: manipulation; font-family: 'NeoDunggeunmo', monospace; }

body { 
    background: #000; 
    color: var(--text-main); 
    width: 100vw; 
    height: 100dvh; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column; 
}

/* [2. CRT ëª¨ë‹ˆí„° íš¨ê³¼ (ë ˆíŠ¸ë¡œ í•„í„° - ê²©ìë¬´ëŠ¬ ì œê±°ë¨)] */
#crt-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
    /* ìŠ¤ìº”ë¼ì¸ íš¨ê³¼ ì œê±° */
    /*
    background: linear-gradient(rgba(18, 16, 19, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 6px 100%;
    */
    box-shadow: inset 0 0 60px rgba(0,0,0,0.7); /* ë¹„ë„¤íŒ…(ëª¨ì„œë¦¬ ì–´ë‘¡ê²Œ) íš¨ê³¼ë§Œ ìœ ì§€ */
}

/* [3. ê³µí†µ UI ì»´í¬ë„ŒíŠ¸] */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--bg-dark); }
.active { display: flex; }

/* ì…ì²´ í”½ì…€ ë²„íŠ¼ (CSS ê·¸ë¦¼ìë¡œ ì…ì²´ê° í‘œí˜„) */
.pixel-btn {
    position: relative; display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 15px; margin: 2px;
    background: #e0e0e0; color: #222; font-size: 1rem; text-transform: uppercase;
    border: none; cursor: pointer; image-rendering: pixelated;
    box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.4), inset 4px 4px 0px 0px #fff, 0 4px 0 #000;
    transition: transform 0.1s;
}
.pixel-btn:active { transform: translateY(4px); box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.4), inset 4px 4px 0px 0px #fff, 0 0 0 #000; }
.btn-green { background: #4cd964; color: #000; }
.btn-blue { background: #3498db; color: #fff; }
.btn-red { background: #ff3b30; color: #fff; }

/* 9-Slice íŒ¨ë„ ìŠ¤íƒ€ì¼ (ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë°°ê²½) */
.pixel-panel {
    background: var(--bg-panel); border: 4px solid #000;
    box-shadow: inset 4px 4px 0 #3f3f74, inset -4px -4px 0 #181425;
    position: relative;
}

/* [4. ì „íˆ¬ í™”ë©´ ë ˆì´ì•„ì›ƒ] */
/* ìƒë‹¨ HUD */
#top-hud {
    height: 60px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; 
    z-index: 20; background: rgba(0,0,0,0.6); border-bottom: 4px solid #000;
}
.stage-badge { color: var(--accent); font-size: 1.4rem; text-shadow: 2px 2px 0 #000; }
.timer-container { display: flex; flex-direction: column; align-items: flex-end; width: 120px; }
.timer-bar-bg { width: 100%; height: 10px; background: #333; border: 2px solid #000; margin-top: 4px; }
.timer-bar-fill { height: 100%; background: #f1c40f; width: 100%; transition: width 0.1s linear; }

/* ì „íˆ¬ í•„ë“œ (ë°°ê²½) */
#battle-viewport {
    flex: 1; position: relative; overflow: hidden;
    background: #000; display: flex; justify-content: center; align-items: flex-end;
    /* transition: background 1s; */ /* ë°°ê²½ ì „í™˜ ë¶€ë“œëŸ½ê²Œ */
}
/* í…Œë§ˆë³„ ë°°ê²½ìƒ‰ (ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œë¥¼ ëŒ€ë¹„í•œ í”½ì…€ ì•„íŠ¸í’ ê·¸ë¼ë°ì´ì…˜) */
.bg-forest { background: linear-gradient(to bottom, #3498db 0%, #85c1e9 50%, #2ecc71 50%, #27ae60 100%) !important; }
.bg-desert { background: linear-gradient(to bottom, #e67e22 0%, #f39c12 50%, #f1c40f 50%, #d35400 100%) !important; }
.bg-dungeon { background: linear-gradient(to bottom, #2c3e50 0%, #34495e 60%, #7f8c8d 60%, #95a5a6 100%) !important; }

/* ìºë¦­í„°/ëª¬ìŠ¤í„° */
.unit-container { position: absolute; bottom: 18%; width: 128px; height: 128px; display: flex; justify-content: center; align-items: flex-end; }
#hero-pos { left: 15%; z-index: 10; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5)); }
#mon-pos { right: 15%; z-index: 5; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5)); }
.sprite { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }

/* HP Bar (ì§€ì—° íš¨ê³¼ í¬í•¨) */
.hp-frame { position: absolute; top: -25px; width: 100px; height: 14px; background: #111; border: 2px solid #fff; padding: 2px; }
.hp-fill { height: 100%; background: #e74c3c; width: 100%; position: relative; z-index: 2; transition: width 0.1s; }
.hp-delay { position: absolute; top: 2px; left: 2px; height: calc(100% - 4px); background: #fff; width: 100%; z-index: 1; transition: width 0.5s ease-out 0.2s; }

/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
#control-panel {
    height: 40%; min-height: 280px; display: flex; flex-direction: column; padding: 12px;
    z-index: 30;
}
/* ìŠ¤íƒ¯ ë  */
#stat-ticker {
    display: flex; gap: 15px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; margin-bottom: 10px;
    overflow-x: auto; white-space: nowrap; border: 2px solid rgba(255,255,255,0.1);
}
.stat-item { color: #ccc; font-size: 0.9rem; }
.stat-val { color: #fff; font-weight: bold; margin-left: 4px; }
.pop-stat { color: var(--success); font-weight: bold; font-size: 0.8rem; margin-left:2px; animation: popUp 0.8s forwards; opacity:0; }

/* í€´ì¦ˆ ì˜ì—­ */
#quiz-area { flex: 1; display: flex; flex-direction: column; gap: 10px; }
#quiz-display {
    flex: 1; background: #141414; border: 2px solid #555; padding: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    position: relative; box-shadow: inset 0 0 20px #000;
}
#quiz-text { font-size: 1.3rem; line-height: 1.4; color: #fff; z-index: 2; white-space: pre-wrap; }
#quiz-img { max-height: 120px; max-width: 100%; border: 2px solid #000; margin-bottom: 8px; display: none; }
#input-row { display: flex; gap: 8px; height: 55px; }
#game-input {
    flex: 1; background: #eee; border: 4px solid #000; font-size: 1.4rem; padding: 0 15px;
    font-family: 'NeoDunggeunmo'; outline: none; border-radius: 0;
    box-shadow: inset 4px 4px 5px rgba(0,0,0,0.2);
}
#game-input:focus { background: #fff; border-color: var(--primary); }

/* [5. íŠ¹ìˆ˜ íš¨ê³¼ ë° ì• ë‹ˆë©”ì´ì…˜] */
@keyframes shake { 
    0% { transform: translate(0, 0); } 
    25% { transform: translate(-4px, 4px); } 
    50% { transform: translate(4px, -4px); } 
    75% { transform: translate(-4px, -4px); } 
    100% { transform: translate(0, 0); } 
}
.shake-effect { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

.dmg-text { 
    position: absolute; font-size: 2rem; font-weight: bold; color: #fff; 
    text-shadow: 3px 3px 0 #000; pointer-events: none; z-index: 100; 
    animation: dmgFloat 0.8s ease-out forwards; 
}
.dmg-crit { color: #ff005c; font-size: 2.5rem; text-shadow: 3px 3px 0 #fff, 5px 5px 0 #000; }
@keyframes dmgFloat { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }
@keyframes popUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }

/* [6. ëª¨ë‹¬ ë° ê¸°íƒ€] */
#modal-crop { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:9999; flex-direction:column; }
#toast { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:10px 20px; border:2px solid #fff; opacity:0; pointer-events:none; transition:opacity 0.3s; z-index:10000; }
</style>
</head>
<body>
    <div id="crt-overlay"></div>

    <div id="screen-rpg" class="screen active">
        
        <div id="top-hud">
            <div>
                <div class="stage-badge" id="ui-stage">STAGE 1-1</div>
                <div style="font-size:0.8rem; color:#777;">BATTLE FIELD</div>
            </div>
            <div class="timer-container">
                <span id="ui-timer-text" style="color:#f1c40f; font-weight:bold;">30.0s</span>
                <div class="timer-bar-bg">
                    <div id="ui-timer-bar" class="timer-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="battle-viewport" class="bg-forest">
            <div id="fx-layer" style="position:absolute; width:100%; height:100%; pointer-events:none; z-index:50;"></div>
            
            <div id="hero-pos" class="unit-container">
                <img id="hero-img" class="sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v-black-white/animated/25.gif" alt="Hero">
            </div>

            <div id="mon-pos" class="unit-container">
                <div class="hp-frame">
                    <div id="mon-hp-delay" class="hp-delay"></div>
                    <div id="mon-hp-fill" class="hp-fill"></div>
                </div>
                <img id="mon-img" class="sprite" src="" alt="Monster">
            </div>
        </div>

        <div id="control-panel" class="pixel-panel">
            <div id="stat-ticker">
                <span class="stat-item">âš”ï¸ATK <span id="stat-atk" class="stat-val">10</span><span id="pop-atk" class="pop-stat">+3</span></span>
                <span class="stat-item">ğŸ¹SPD <span id="stat-aspd" class="stat-val">1.0</span><span id="pop-aspd" class="pop-stat">+0.01</span></span>
                <span class="stat-item">âš¡CRI <span id="stat-crit" class="stat-val">5%</span><span id="pop-crit" class="pop-stat">+1%</span></span>
                <span class="stat-item">ğŸ’¥CDM <span id="stat-cdmg" class="stat-val">150%</span><span id="pop-cdmg" class="pop-stat">+5%</span></span>
                <span class="stat-item">ğŸ”¥COMBO <span id="stat-combo" class="stat-val" style="color:var(--accent)">0</span></span>
            </div>

            <div id="quiz-area">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.8rem; color:#888;">MISSION TARGET</span>
                    <button class="pixel-btn" style="padding:4px 8px; font-size:0.7rem;" onclick="showScreen('manage')">âš™ï¸ DATA</button>
                </div>
                
                <div id="quiz-display">
                    <img id="quiz-img">
                    <div id="quiz-text">ì „íˆ¬ë¥¼ ì‹œì‘í•˜ë ¤ë©´<br>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì„¸ìš”.</div>
                    <div id="quiz-feedback"></div>
                </div>

                <div id="input-row">
                    <input id="game-input" type="text" placeholder="ì •ë‹µ ì…ë ¥..." autocomplete="off" onkeypress="if(event.key==='Enter') checkAnswer()">
                    <button class="pixel-btn btn-red" style="width:80px; font-weight:bold; font-size:1.1rem;" onclick="checkAnswer()">HIT!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-manage" class="screen">
        <div style="padding:15px; background:var(--bg-panel); border-bottom:4px solid #000; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:#fff; text-shadow:2px 2px 0 #000;">DATABASE</h2>
            <button class="pixel-btn" onclick="showScreen('rpg')">ğŸ”™ BACK</button>
        </div>
        
        <div style="padding:15px; overflow-y:auto; flex:1; background:#f4f4f4;">
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="pixel-btn btn-green" style="flex:1" onclick="toggleAddMode('text')">ğŸ“ TEXT ADD</button>
                <button class="pixel-btn btn-blue" style="flex:1" onclick="toggleAddMode('image')">ğŸ“· IMAGE ADD</button>
            </div>
            
            <div id="add-text-box" class="pixel-panel" style="display:none; padding:15px; margin-bottom:15px; background:#ddd;">
                <input id="new-q" placeholder="ë¬¸ì œ (Question)" style="width:100%; padding:10px; margin-bottom:5px; border:2px solid #000;">
                <input id="new-a" placeholder="ì •ë‹µ (Answer)" style="width:100%; padding:10px; margin-bottom:5px; border:2px solid #000;">
                <input id="new-desc" placeholder="í•´ì„¤ (Option)" style="width:100%; padding:10px; margin-bottom:5px; border:2px solid #000;">
                <button class="pixel-btn btn-green" style="width:100%" onclick="addTextWord()">SAVE</button>
                <button class="pixel-btn" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="toggleExcel()">ğŸ“‹ EXCEL PASTE</button>
                <div id="excel-area" style="display:none; margin-top:5px">
                    <textarea id="excel-input" placeholder="ë¬¸ì œ [íƒ­] ì •ë‹µ" style="width:100%; height:80px; border:2px solid #000;"></textarea>
                    <button class="pixel-btn btn-blue" style="width:100%; margin-top:5px;" onclick="parseExcel()">BATCH SAVE</button>
                </div>
            </div>

            <div id="add-image-box" class="pixel-panel" style="display:none; padding:15px; margin-bottom:15px; background:#ddd;">
                <div id="p-area-q" style="width:100%; height:150px; background:#222; display:flex; align-items:center; justify-content:center; border:2px dashed #777; margin-bottom:10px;">
                    <img id="preview-q-img" style="display:none; max-width:100%; max-height:100%">
                    <span style="color:#666">NO IMAGE</span>
                </div>
                <button class="pixel-btn btn-blue" onclick="triggerCamera('question')" style="width:100%; margin-bottom:10px">ğŸ“· CAMERA / GALLERY</button>
                <input id="img-a" placeholder="ì •ë‹µ" style="width:100%; padding:10px; margin-bottom:5px; border:2px solid #000;">
                <input id="img-desc" placeholder="í•´ì„¤" style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #000;">
                <button class="pixel-btn btn-green" style="width:100%" onclick="addImageWord()">SAVE</button>
            </div>

            <div style="background:#333; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <span>SAVED DATA</span>
                <button class="pixel-btn btn-red" style="font-size:0.7rem; padding:4px;" onclick="deleteSelected()">DELETE</button>
            </div>
            <div id="word-list" style="background:#fff; color:#000; min-height:200px; padding:5px;"></div>
        </div>
        <input type="file" id="camera-input" style="display:none" accept="image/*" onchange="handleImageFile(event)">
    </div>

    <div id="modal-crop">
        <div style="flex:1; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; touch-action:none" id="crop-container">
            <canvas id="crop-canvas"></canvas>
        </div>
        <div style="height:80px; background:#222; display:flex; justify-content:space-around; align-items:center; border-top:4px solid #fff;">
            <button class="pixel-btn" onclick="rotateImage()">ğŸ”„ ROTATE</button>
            <button class="pixel-btn btn-red" onclick="closeCrop()">CANCEL</button>
            <button class="pixel-btn btn-green" onclick="applyCrop()">âœ‚ï¸ CROP</button>
        </div>
    </div>

    <div id="toast"></div>
<script>
// ============================================================
// [1. ì‹œìŠ¤í…œ ì„¤ì • ë° ë°ì´í„°ë² ì´ìŠ¤]
// ============================================================
let db, vocabulary = [], isDBReady = false;
let rpgData = { stage: 1, subStage: 1, atk: 10, aspd: 1.0, crit: 5, cdmg: 150, combo: 0 };

// [ì‚¬ìš©ì íŒŒì¼ ì„¤ì •]
// GitHub ì €ì¥ì†Œì— ì´ ì´ë¦„ìœ¼ë¡œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
const HERO_IDLE_URL = "./hero.gif";     // ëŒ€ê¸° ëª¨ì…˜
const HERO_ATTACK_URL = "./attack.gif"; // ê³µê²© ëª¨ì…˜

// ëª¬ìŠ¤í„°ëŠ” ì—¬ì „íˆ ë‹¤ì–‘ì„±ì„ ìœ„í•´ PokeAPIë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ,
// ì›í•˜ì‹ ë‹¤ë©´ monster.gif ë“±ì„ ì—…ë¡œë“œí•´ì„œ ê³ ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
const SPRITE_BASE_URL = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/";

const MONSTER_POOLS = {
    forest: ["1", "10", "13", "16", "19", "29", "32", "43", "69"], 
    desert: ["4", "27", "37", "50", "74", "95", "104", "111"], 
    dungeon: ["92", "93", "94", "109", "88", "132", "149", "90"]
};

window.onload = function() { 
    initDB(); 
    loadRPGData(); 
    
    // ì˜ì›… ì´ˆê¸° ì´ë¯¸ì§€ ë¡œë“œ
    const heroImg = document.getElementById('hero-img');
    heroImg.src = HERO_IDLE_URL;

    // [ì¤‘ìš”] ë§Œì•½ êµ¬í•œ ì´ë¯¸ì§€ê°€ 'ì™¼ìª½'ì„ ë³´ê³  ìˆë‹¤ë©´ ì•„ë˜ ì£¼ì„(//)ì„ ì§€ìš°ì„¸ìš”.
    // heroImg.style.transform = "scaleX(-1)"; 
};

function showToast(msg) { 
    const t=document.getElementById('toast'); 
    t.innerText=msg; t.style.opacity=1; t.style.top="20%";
    setTimeout(()=>t.style.opacity=0, 2000); 
}
function showScreen(id) { 
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
    document.getElementById('screen-'+id).classList.add('active'); 
    if(id==='manage') renderWordList();
    if(id==='rpg') { updateStatUI(); if(!attackTimer && isDBReady) initBattle(); }
}

function initDB() {
    const r = indexedDB.open("RpgRemasterDB", 1);
    r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains('vocab')) e.target.result.createObjectStore('vocab', {keyPath:'id', autoIncrement:true}); };
    r.onsuccess = e => { db=e.target.result; loadVocab(); };
}
function loadVocab() { db.transaction(['vocab'],'readonly').objectStore('vocab').getAll().onsuccess = e => { vocabulary = e.target.result||[]; isDBReady=true; nextQuiz(); }; }
function saveToDB(item, cb) { db.transaction(['vocab'],'readwrite').objectStore('vocab').add(item).onsuccess = () => { loadVocab(); if(cb) cb(); }; }
function deleteFromDB(ids) { const tx=db.transaction(['vocab'],'readwrite'); ids.forEach(id=>tx.objectStore('vocab').delete(id)); tx.oncomplete=()=>{ showToast("ë°ì´í„° ì‚­ì œ ì™„ë£Œ"); loadVocab(); renderWordList(); }; }

// ============================================================
// [2. RPG ì—”ì§„ & ë¹„ì£¼ì–¼ ì´í™íŠ¸]
// ============================================================
let battleTimer, attackTimer, timeLeft=30, currentMonHP=100, maxMonHP=100, isBoss=false;

function loadRPGData() {
    const s = localStorage.getItem('rpg_remaster_v10');
    if(s) rpgData = JSON.parse(s);
    updateStatUI(); initBattle();
}
function saveRPGData() { localStorage.setItem('rpg_remaster_v10', JSON.stringify(rpgData)); }

function updateStatUI() {
    document.getElementById('stat-atk').innerText = rpgData.atk;
    document.getElementById('stat-aspd').innerText = rpgData.aspd.toFixed(2);
    document.getElementById('stat-crit').innerText = rpgData.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = rpgData.cdmg + "%";
    document.getElementById('stat-combo').innerText = rpgData.combo;
    document.getElementById('ui-stage').innerText = `STAGE ${rpgData.stage}-${rpgData.subStage}`;
}

function initBattle() {
    clearInterval(battleTimer); clearInterval(attackTimer);
    if(rpgData.subStage === 1) timeLeft = 30;
    
    spawnMonster();
    attackTimer = setInterval(heroAttack, Math.max(300, 1000/rpgData.aspd)); 
    updateTimerUI();
    
    battleTimer = setInterval(() => {
        timeLeft -= 0.1; 
        if(timeLeft < 0) timeLeft = 0;
        updateTimerUI();
        
        if(timeLeft <= 0) { 
            clearInterval(battleTimer); clearInterval(attackTimer);
            showDamageText("TIME OVER!", true);
            showToast("ì‹œê°„ ì´ˆê³¼! ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”");
            setTimeout(() => {
                rpgData.subStage = 1; 
                timeLeft = 30;
                updateStatUI(); 
                saveRPGData(); 
                initBattle(); 
            }, 1500);
        }
    }, 100);
}

function spawnMonster() {
    isBoss = (rpgData.subStage === 5); 
    const themes = ['forest', 'desert', 'dungeon'];
    const th = themes[Math.floor((rpgData.stage-1)/5)%3];
    
    const vp = document.getElementById('battle-viewport');
    vp.className = ""; vp.classList.add('bg-'+th);

    const pool = MONSTER_POOLS[th];
    const id = pool[Math.floor(Math.random()*pool.length)];
    const targetId = isBoss ? "150" : id;
    const monSrc = SPRITE_BASE_URL + targetId + ".gif";
    
    const monImg = document.getElementById('mon-img');
    monImg.style.opacity = 0;
    
    monImg.onerror = function() { 
        this.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${targetId}.png`; 
    };
    
    setTimeout(()=>{ monImg.src = monSrc; monImg.style.opacity = 1; }, 200);

    let hp = 100 * Math.pow(1.1, rpgData.stage-1) * (1 + rpgData.subStage * 0.2);
    if(isBoss) hp *= 3;
    maxMonHP = Math.floor(hp); currentMonHP = maxMonHP;
    updateHPUI(true);
}

function heroAttack() {
    const hImg = document.getElementById('hero-img');
    const hPos = document.getElementById('hero-pos');

    // ê³µê²© ëª¨ì…˜ìœ¼ë¡œ êµì²´
    hImg.src = HERO_ATTACK_URL;
    hPos.style.zIndex = 20; 
    
    // [ì• ë‹ˆë©”ì´ì…˜ ì¡°ì •]
    // ë³¸ì¸ì´ êµ¬í•œ ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶° scale(1.0) ìˆ«ìë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
    // translateX(20px)ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ 20pxë§Œí¼ ëŒì§„í•˜ëŠ” íš¨ê³¼ì…ë‹ˆë‹¤.
    hImg.style.transform = "scale(1.0) translateX(20px)"; 

    // ë°ë¯¸ì§€ íƒ€ì´ë°
    setTimeout(() => {
        let dmg = rpgData.atk;
        let isCrit = Math.random()*100 < rpgData.crit;
        if(isCrit) dmg *= (rpgData.cdmg/100);
        hitMonster(Math.floor(dmg), isCrit);
    }, 200);

    // ë³µê·€ (0.6ì´ˆ í›„ ëŒ€ê¸° ëª¨ì…˜)
    setTimeout(() => {
         hImg.src = HERO_IDLE_URL;
         hPos.style.zIndex = 10;
         // ë³µê·€ ì‹œ transform ì´ˆê¸°í™”
         hImg.style.transform = "scale(1.0) translateX(0)"; 
    }, 600);
}

function hitMonster(dmg, isCrit) {
    currentMonHP = Math.max(0, currentMonHP - dmg);
    updateHPUI(); 

    const m = document.getElementById('mon-img');
    m.style.filter = "brightness(5) sepia(1) hue-rotate(-50deg)"; 
    m.style.transform = "translateX(8px)";
    setTimeout(() => {
        m.style.filter = "drop-shadow(4px 4px 0 rgba(0,0,0,0.5))"; 
        m.style.transform = "translateX(0)";
    }, 100);

    if(isCrit) shakeScreen();
    showDamageText(dmg, isCrit);
    
    if(currentMonHP <= 0) {
        monsterDeath();
    }
}

function monsterDeath() {
    clearInterval(battleTimer); clearInterval(attackTimer);
    const m = document.getElementById('mon-img');
    m.style.transition = "opacity 0.5s, transform 0.5s";
    m.style.opacity = 0; m.style.transform = "scale(0.5)";
    
    showDamageText(isBoss ? "STAGE CLEAR!" : "NEXT!", true);
    
    rpgData.subStage++;
    if(rpgData.subStage > 5) {
        rpgData.subStage = 1;
        rpgData.stage++;
        timeLeft = 30; 
    }
    
    saveRPGData(); updateStatUI();
    setTimeout(() => {
        m.style.transition = "none"; m.style.transform = "scale(1)";
        initBattle();
    }, 1000);
}

// [í•µì‹¬] ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
function updateHPUI(instant = false) {
    const pct = (currentMonHP / maxMonHP) * 100;
    const fill = document.getElementById('mon-hp-fill');
    const delay = document.getElementById('mon-hp-delay');
    
    fill.style.width = pct + '%';
    
    if(instant) {
        delay.style.transition = 'none';
        delay.style.width = pct + '%';
    } else {
        delay.style.transition = 'width 0.5s ease-out 0.2s'; 
        delay.style.width = pct + '%';
    }
}

function updateTimerUI() {
    document.getElementById('ui-timer-text').innerText = timeLeft.toFixed(1) + 's';
    document.getElementById('ui-timer-bar').style.width = (timeLeft/30*100) + '%';
}

function showDamageText(dmg, isCrit) {
    const el = document.createElement('div');
    el.className = isCrit ? 'dmg-text dmg-crit' : 'dmg-text';
    el.innerText = dmg;
    const left = 50 + (Math.random()*20 - 10);
    const top = 30 + (Math.random()*20 - 10);
    el.style.left = left+'%'; el.style.top = top+'%';
    
    document.getElementById('fx-layer').appendChild(el);
    setTimeout(()=>el.remove(), 800);
}

function shakeScreen() {
    const vp = document.getElementById('battle-viewport');
    vp.classList.remove('shake-effect');
    void vp.offsetWidth; 
    vp.classList.add('shake-effect');
}

// ============================================================
// [3. í€´ì¦ˆ ë° ì„±ì¥ ì‹œìŠ¤í…œ]
// ============================================================
let currentQuiz = null;

function nextQuiz() {
    if (vocabulary.length < 1) {
        document.getElementById('quiz-text').innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ ë©”ë‰´ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.";
        return;
    }
    
    let wrongOnes = vocabulary.filter(v => (v.wrongCount || 0) > 0);
    currentQuiz = (wrongOnes.length > 0 && Math.random() < 0.5) 
        ? wrongOnes[Math.floor(Math.random() * wrongOnes.length)]
        : vocabulary[Math.floor(Math.random() * vocabulary.length)];
    
    const imgView = document.getElementById('quiz-img');
    const textView = document.getElementById('quiz-text');
    
    if (currentQuiz.type === 'image') {
        imgView.src = currentQuiz.q; imgView.style.display = 'block';
        textView.innerText = currentQuiz.qText || "";
    } else {
        imgView.style.display = 'none'; textView.innerText = currentQuiz.q;
    }
    
    document.getElementById('game-input').value = "";
    document.getElementById('game-input').focus();
}

function checkAnswer() {
    if (!currentQuiz) return nextQuiz();
    const input = document.getElementById('game-input').value.trim();
    if (!input) return;

    const userAns = input.replace(/\s/g, "").toUpperCase();
    const realAns = currentQuiz.a.replace(/\s/g, "").toUpperCase();
    const isCorrect = (userAns === 'O' || userAns === 'X') ? (realAns.charAt(0) === userAns) : (userAns === realAns);
    const fb = document.getElementById('quiz-feedback');

    if (isCorrect) {
        rpgData.combo++;
        let mult = 1;
        if(rpgData.combo % 5 === 0) { mult = 3; showDamageText("COMBO BONUS!", true); }
        
        applyStatGrowth(mult);
        
        if (currentQuiz.wrongCount > 0) { currentQuiz.wrongCount--; saveToDB(currentQuiz); }
        
        // ì •ë‹µ ì‹œ ì¦‰ì‹œ ê°•ë ¥í•œ ê³µê²©
        heroAttack(); setTimeout(heroAttack, 300); 
        
        fb.innerText = "EXCELLENT!"; fb.style.color = "var(--success)";
        setTimeout(nextQuiz, 200);
    } else {
        rpgData.combo = 0;
        fb.innerHTML = `ë‹µ: ${currentQuiz.a} <small>(${currentQuiz.desc||''})</small>`;
        fb.style.color = "var(--danger)";
        shakeScreen(); 
        
        currentQuiz.wrongCount = (currentQuiz.wrongCount || 0) + 1;
        saveToDB(currentQuiz);
        setTimeout(nextQuiz, 2500);
    }
    saveRPGData(); updateStatUI();
}

function applyStatGrowth(mult) {
    document.querySelectorAll('.pop-stat').forEach(el => {
        el.style.animation = 'none'; void el.offsetWidth; el.style.animation = 'popUp 0.8s forwards';
    });

    for(let i=0; i<mult; i++) {
        const r = Math.random();
        if(r < 0.4) { rpgData.atk += 2; setPop('atk', 2); }
        else if(r < 0.6) { rpgData.aspd = Math.min(5.0, rpgData.aspd + 0.005); setPop('aspd', 0.01); }
        else if(r < 0.8) { rpgData.crit = Math.min(100, rpgData.crit + 0.05); setPop('crit', 0.1); }
        else { rpgData.cdmg += 2; setPop('cdmg', 2); }
    }
}
function setPop(type, val) { document.getElementById('pop-'+type).innerText = "+"+val; }

// ============================================================
// [4. ìœ í‹¸ë¦¬í‹° (ì´ë¯¸ì§€ ì²˜ë¦¬ ë“±)]
// ============================================================
let cropImg=new Image(), cropCanvas=document.getElementById('crop-canvas'), cropCtx=cropCanvas.getContext('2d');
let cropRect={x:0,y:0,w:100,h:100}, dragMode=null, startPos={x:0,y:0}, baseRect={x:0,y:0,w:0,h:0}, currentCropTarget=null;

function handleImageFile(e) { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ cropImg.src=ev.target.result; cropImg.onload=()=>startCropping(); }; r.readAsDataURL(f); }
function startCropping() { document.getElementById('modal-crop').style.display='flex'; const cw=Math.min(window.innerWidth*0.9, cropImg.width); cropRect={x:10,y:10,w:cw,h:cw*0.6}; drawCrop(); }
function drawCrop() {
    const maxW=window.innerWidth, maxH=window.innerHeight*0.7; const scale=Math.min(maxW/cropImg.width, maxH/cropImg.height);
    cropCanvas.width=cropImg.width*scale; cropCanvas.height=cropImg.height*scale;
    cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height); 
    cropCtx.drawImage(cropImg,0,0,cropCanvas.width,cropCanvas.height); 
    cropCtx.fillStyle='rgba(0,0,0,0.6)'; cropCtx.fillRect(0,0,cropCanvas.width,cropCanvas.height);
    const sX=cropRect.x*scale, sY=cropRect.y*scale, sW=cropRect.w*scale, sH=cropRect.h*scale;
    cropCtx.clearRect(sX,sY,sW,sH); cropCtx.drawImage(cropImg,cropRect.x,cropRect.y,cropRect.w,cropRect.h,sX,sY,sW,sH); 
    cropCtx.strokeStyle='#fff'; cropCtx.lineWidth=2; cropCtx.strokeRect(sX,sY,sW,sH);
}
cropCanvas.addEventListener('pointerdown', e=>{ 
    const rect=cropCanvas.getBoundingClientRect(), scale=cropImg.width/cropCanvas.width;
    const cx=e.clientX-rect.left, cy=e.clientY-rect.top; 
    const sX=cropRect.x/scale, sY=cropRect.y/scale, sW=cropRect.w/scale, sH=cropRect.h/scale;
    if(cx>sX && cx<sX+sW && cy>sY && cy<sY+sH) { dragMode='move'; startPos={x:e.clientX, y:e.clientY}; baseRect={...cropRect}; cropCanvas.setPointerCapture(e.pointerId); }
});
cropCanvas.addEventListener('pointermove', e=>{ 
    if(!dragMode) return; 
    const scale=cropImg.width/cropCanvas.width;
    const dx=(e.clientX-startPos.x)*scale, dy=(e.clientY-startPos.y)*scale;
    if(dragMode==='move') { cropRect.x=Math.max(0, Math.min(cropImg.width-cropRect.w, baseRect.x+dx)); cropRect.y=Math.max(0, Math.min(cropImg.height-cropRect.h, baseRect.y+dy)); drawCrop(); }
});
cropCanvas.addEventListener('pointerup', ()=>dragMode=null);

function closeCrop() { document.getElementById('modal-crop').style.display='none'; document.getElementById('camera-input').value=""; }
function applyCrop() { 
    const c=document.createElement('canvas'); c.width=cropRect.w; c.height=cropRect.h; 
    c.getContext('2d').drawImage(cropImg,cropRect.x,cropRect.y,cropRect.w,cropRect.h,0,0,cropRect.w,cropRect.h); 
    const res=c.toDataURL('image/jpeg',0.8); 
    if(currentCropTarget==='question') { document.getElementById('preview-q-img').src=res; document.getElementById('preview-q-img').style.display='block'; }
    closeCrop(); 
}
function rotateImage() { showToast("íšŒì „: ì¶”í›„ ì§€ì›"); }

function toggleAddMode(mode) { 
    document.getElementById('add-text-box').style.display = mode==='text'?'block':'none'; 
    document.getElementById('add-image-box').style.display = mode==='image'?'block':'none'; 
}
function toggleExcel() { const e=document.getElementById('excel-area'); e.style.display = e.style.display==='none'?'block':'none'; }
function addTextWord() { 
    const q=document.getElementById('new-q').value.trim(), a=document.getElementById('new-a').value.trim(), d=document.getElementById('new-desc').value.trim();
    if(q&&a) saveToDB({type:'text',q,a,desc:d,wrongCount:0}, ()=>{ showToast("ë“±ë¡ë¨!"); document.getElementById('new-q').value=""; document.getElementById('new-a').value=""; }); 
}
function addImageWord() {
    const src=document.getElementById('preview-q-img').src, a=document.getElementById('img-a').value.trim(), d=document.getElementById('img-desc').value.trim();
    if(src && src.length>100 && a) saveToDB({type:'image',q:src,qText:'',a,desc:d,wrongCount:0}, ()=>{ showToast("ì´ë¯¸ì§€ ë“±ë¡ë¨!"); closeCrop(); });
}
function renderWordList() { 
    const l=document.getElementById('word-list'); 
    l.innerHTML = vocabulary.length===0 ? "<div style='padding:20px; text-align:center; color:#888;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>" 
    : vocabulary.slice().reverse().map(v=>`<div class="list-item" style="border-bottom:1px solid #ddd; padding:10px; display:flex; align-items:center;">
    <input type="checkbox" class="chk-del" value="${v.id}" style="margin-right:10px; transform:scale(1.5);">
    <div>${v.type==='image'?'<span style="color:blue">[IMAGE]</span>':v.q}<br><small style="color:#666">${v.a}</small></div>
    </div>`).join(''); 
}
function deleteSelected() { 
    const c=document.querySelectorAll('.chk-del:checked'); 
    if(c.length>0 && confirm(c.length+"ê°œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteFromDB(Array.from(c).map(e=>Number(e.value))); 
}
function triggerCamera(target) { currentCropTarget=target; document.getElementById('camera-input').click(); }
function parseExcel() {
    const val = document.getElementById('excel-input').value;
    if(!val) return;
    const lines = val.split('\n');
    let cnt = 0;
    lines.forEach(line => {
        const p = line.split('\t');
        if(p.length >= 2) {
            saveToDB({type:'text', q:p[0].trim(), a:p[1].trim(), wrongCount:0});
            cnt++;
        }
    });
    showToast(cnt + "ê°œ ì¼ê´„ ë“±ë¡ ì™„ë£Œ");
    document.getElementById('excel-input').value = "";
}
</script>
