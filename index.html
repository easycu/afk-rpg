<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° ë§ˆìŠ¤í„°: ë ˆì „ë“œ ë°°í‹€ V2</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
/* --- [1. ê¸°ë³¸ ì„¤ì •] --- */
:root {
    --primary: #FF5252;
    --bg-app: #f0f0f0;
    --text: #333;
    --o-color: #2979FF;
    --x-color: #D32F2F;
    --btn-check: #6200EA; /* ì •ë‹µ í™•ì¸ ë²„íŠ¼ ìƒ‰ */
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }
body { 
    font-family: 'Jua', sans-serif; 
    background: #212121; 
    color: var(--text); 
    width: 100vw; height: 100dvh; 
    display: flex; justify-content: center; align-items: center; 
    overflow: hidden;
}
input, textarea { user-select: text !important; -webkit-user-select: text !important; }

#app-container {
    width: 100%; height: 100%; max-width: 500px; 
    background: var(--bg-app);
    display: flex; flex-direction: column;
    position: relative;
    box-shadow: 0 0 40px rgba(0,0,0,0.6);
}

/* --- [2. ë°°í‹€ í•„ë“œ & UI] --- */
#area-battle { 
    flex: 0 0 40%; /* ë¹„ìœ¨ ì¡°ì • */
    position: relative; 
    background: #f8f8f8; 
    overflow: hidden; 
    display: flex; flex-direction: column;
    border-bottom: 4px solid #333;
}
.stage-info-bar { 
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 8px 15px; 
    display: flex; justify-content: space-between; align-items: center; 
    z-index: 20;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent);
    color: #fff; text-shadow: 1px 1px 0 #000;
}
.battle-field { position: relative; width: 100%; height: 100%; }

/* ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
@keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
@keyframes tackle { 0% { transform: scale(1.4) translate(0, 0); } 50% { transform: scale(1.4) translate(30px, -30px); } 100% { transform: scale(1.4) translate(0, 0); } }
@keyframes damage { 0% { transform: scale(1.2) translate(0, 0); } 20% { transform: scale(1.2) translate(15px, -15px); filter: brightness(5) sepia(1) saturate(0); } 100% { transform: scale(1.2) translate(0, 0); } }

.sprite-wrapper { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; animation: floating 3s ease-in-out infinite; }
.mob-zone { top: 15%; right: 10%; width: 100px; height: 100px; z-index: 5; }
.hero-zone { bottom: 5%; left: 5%; width: 100px; height: 100px; z-index: 10; }
.sprite { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); transition: transform 0.1s; }
#hero-img { transform: scale(1.4) translateY(-5px); transform-origin: bottom center; }
#mob-img { transform: scale(1.2) translateY(-5px); transform-origin: bottom center; }
.sprite.attack { animation: tackle 0.2s ease-out; }
.sprite.hit { animation: damage 0.3s ease-out; }
.shadow { width: 80%; height: 20px; background: rgba(0,0,0,0.15); border-radius: 50%; transform: scaleY(0.5); margin-top: -15px; }

/* ëª¬ìŠ¤í„° HP */
.hp-ui { position: absolute; background: #fff; border: 2px solid #333; border-radius: 8px; padding: 5px; width: 120px; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
.mob-hp-ui { top: 20px; left: 20px; z-index: 4; }
.hp-bar-bg { width: 100%; height: 6px; background: #ddd; border-radius: 4px; overflow: hidden; margin-top: 3px; border:1px solid #999; }
.hp-fill { height: 100%; background: #4CAF50; width: 100%; transition: width 0.2s; }
.hp-fill.low { background: #D32F2F !important; }
.dmg-text { position: absolute; font-weight: 900; color: #fff; font-size: 2rem; text-shadow: 2px 2px 0 #000; z-index: 30; animation: floatUp 0.8s forwards; pointer-events: none; }
@keyframes floatUp { 0%{opacity:1; transform:translateY(0)} 100%{opacity:0; transform:translateY(-50px)} }

/* --- [3. í€´ì¦ˆ ì˜ì—­ (í•µì‹¬ ë³€ê²½)] --- */
#area-stat { background: #37474F; color: #fff; padding: 5px; font-size: 0.8rem; display:flex; justify-content:space-around; border-bottom:2px solid #222; }
#area-quiz { flex: 1; padding: 10px; background: #E0E0E0; display: flex; flex-direction: column; align-items: center; overflow: hidden; position: relative; }

/* ë¬¸ì œ/ì •ë‹µ í‘œì‹œ ì»¨í…Œì´ë„ˆ */
.content-box {
    width: 100%; flex: 1; min-height: 0; 
    background: #fff; border: 3px solid #333; border-radius: 10px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    overflow-y: auto; padding: 10px; margin-bottom: 10px;
    text-align: center; position: relative;
}
.img-display { max-width: 100%; max-height: 200px; object-fit: contain; margin: 5px 0; border: 2px solid #eee; border-radius: 5px; cursor: zoom-in; }
.text-display { font-size: 1.3rem; line-height: 1.5; color: #000; font-weight: bold; width: 100%; white-space: pre-wrap; }
.label-badge { 
    position: absolute; top: 0; left: 0; 
    background: #333; color: #fff; 
    padding: 3px 8px; font-size: 0.8rem; 
    border-bottom-right-radius: 8px; z-index: 5;
}

/* ë²„íŠ¼ ê·¸ë£¹ */
.btn-group-wrapper { flex: 0 0 auto; width: 100%; display: flex; gap: 8px; height: 60px; margin-bottom: 5px; }
.btn-game { flex: 1; border: 2px solid #000; border-radius: 10px; font-size: 1.8rem; color: #fff; font-family: 'Jua'; box-shadow: 2px 4px 0 rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; }
.btn-game:active { transform: translateY(4px); box-shadow: none; }
.btn-o { background: var(--o-color); }
.btn-x { background: var(--x-color); }
.btn-check { background: var(--btn-check); font-size: 1.4rem; }
.btn-next { background: #FFD600; color: #000; font-size: 1.4rem; }

/* ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ */
#modal-zoom {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 10000;
    justify-content: center; align-items: center; flex-direction: column;
}
#modal-img { max-width: 95%; max-height: 80%; object-fit: contain; border: 2px solid #fff; }
#modal-close { margin-top: 20px; padding: 10px 20px; background: #fff; border-radius: 20px; font-weight: bold; font-size: 1.2rem; }

/* ê³µí†µ UI */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; }
.active { display: flex; }
.menu-btn { width: 100%; padding: 12px; margin: 4px 0; border: 2px solid #000; border-radius: 10px; color: #fff; font-size: 1.2rem; font-family: 'Jua'; }
.toast { position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%); background: rgba(0,0,0,0.9); color: #fff; padding: 10px 20px; border-radius: 5px; opacity: 0; z-index: 9999; }
.toast.show { opacity: 1; }
</style>
</head>
<body>

<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#212121;z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;flex-direction:column;">
    <div style="font-size:3rem; margin-bottom:15px; animation:bounce 1s infinite;">âš¡</div>
    <div>ë°°í‹€ ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>

<div id="modal-zoom" onclick="closeModal()">
    <img id="modal-img" src="">
    <div id="modal-close">ë‹«ê¸°</div>
</div>

<div id="toast-container"></div>

<div id="app-container">
    <div id="screen-home" class="screen active" style="background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="background:#fff; width:140px; height:140px; border-radius:50%; display:flex; justify-content:center; align-items:center; border:6px solid #333; box-shadow:5px 5px 0 rgba(0,0,0,0.2); margin-bottom:20px;">
                <span style="font-size:5rem;">ğŸ§¢</span>
            </div>
            <h1 style="color:#D32F2F; font-size:3rem; text-shadow:3px 3px 0 #fff; margin-bottom:5px; -webkit-text-stroke: 1px #333;">ì•”ê¸° ë§ˆìŠ¤í„°</h1>
            <p style="color:#333; font-size:1.2rem; font-weight:bold;">ë ˆì „ë“œ ë°°í‹€ V2</p>
            
            <div style="margin-top:40px; background:#fff; padding:20px 40px; border-radius:10px; border:3px solid #333; box-shadow:5px 5px 0 rgba(0,0,0,0.2);">
                <div style="font-size:1.2rem; color:#333; margin-bottom:5px;">ìµœê³  ê¸°ë¡: <b id="home-best-stage" style="color:#D32F2F;">1-1</b></div>
            </div>
        </div>
        <div style="padding:20px;">
            <button id="btn-start" class="menu-btn" style="background:#FF5252; border-color:#b71c1c;" onclick="startGame()" disabled>ëª¨í—˜ ì‹œì‘</button>
            <button class="menu-btn" style="background:#795548; border-color:#3e2723;" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button>
        </div>
    </div>
    <div id="screen-game" class="screen">
        <div id="area-battle">
            <div class="stage-info-bar">
                <span id="stage-display">STAGE 1-1</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span>â³</span>
                    <div style="width:80px; height:10px; background:rgba(0,0,0,0.5); border-radius:5px; overflow:hidden;">
                        <div id="time-bar" style="height:100%; width:100%; background:#FFD600;"></div>
                    </div>
                </div>
            </div>

            <div class="battle-field">
                <div class="hp-ui mob-hp-ui">
                    <div style="font-size:0.8rem; font-weight:bold; display:flex; justify-content:space-between;">
                        <span>ì•¼ìƒì˜ ë¬¸ì œ</span> <span style="font-size:0.7rem;">Lv.<span id="mob-lv">1</span></span>
                    </div>
                    <div class="hp-bar-bg"><div id="mob-hp" class="hp-fill"></div></div>
                </div>
                <div class="sprite-wrapper mob-zone">
                    <img id="mob-img" class="sprite" src="" alt="Pokemon">
                    <div class="shadow"></div>
                </div>

                <div class="sprite-wrapper hero-zone">
                    <img id="hero-img" class="sprite hero" src="" alt="Player">
                    <div class="shadow" style="width:100%; bottom:10px;"></div>
                </div>
            </div>
        </div>

        <div id="area-stat">
            <div>âš”ï¸ <span id="stat-atk">10</span></div>
            <div>âš¡ <span id="stat-crit">0%</span></div>
            <div>ğŸ’¥ <span id="stat-cdmg">150%</span></div>
            <div>ğŸ’¨ <span id="stat-aspd">1.0</span> <span id="buff-badge" style="display:none; color:#FFD600;">(UP!)</span></div>
        </div>

        <div id="area-quiz">
            <div id="box-question" class="content-box">
                <div class="label-badge">QUESTION</div>
                <div id="q-content-text" class="text-display"></div>
                <img id="q-content-img" class="img-display" style="display:none;" onclick="zoomImage(this.src)">
            </div>
            
            <div id="box-answer" class="content-box" style="display:none; border-color:#2979FF; background:#E3F2FD;">
                <div class="label-badge" style="background:#2979FF;">ANSWER</div>
                <div id="a-content-text" class="text-display" style="color:#1565C0;"></div>
                <img id="a-content-img" class="img-display" style="display:none;" onclick="zoomImage(this.src)">
            </div>

            <div id="btns-ox" class="btn-group-wrapper" style="display:none;">
                <button class="btn-game btn-o" onclick="submitAnswer('O')">O</button>
                <button class="btn-game btn-x" onclick="submitAnswer('X')">X</button>
            </div>

            <div id="btns-check" class="btn-group-wrapper" style="display:none;">
                <button class="btn-game btn-check" onclick="revealAnswer()">âš”ï¸ ì •ë‹µ í™•ì¸ (ê³µê²©)</button>
            </div>

            <div id="btns-judge" class="btn-group-wrapper" style="display:none;">
                <button class="btn-game btn-o" onclick="judgeSelf(true)">âœ… ë§ìŒ</button>
                <button class="btn-game btn-x" onclick="judgeSelf(false)">âŒ í‹€ë¦¼</button>
            </div>

            <div id="btns-next" class="btn-group-wrapper" style="display:none;">
                <button id="btn-next-quiz" class="btn-game btn-next" onclick="manualNextQuiz()">â–¶ ë‹¤ìŒ ë°°í‹€</button>
            </div>
        </div>

        <div id="area-menu" style="flex:0 0 auto; padding:10px; background:#eee; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #ccc;">
            <button class="menu-btn" onclick="stopGame()" style="width:auto; padding:8px 15px; border:1px solid #999; border-radius:5px; background:#fff; color:#333; font-size:1rem; margin:0;">ë„ë§ì¹˜ê¸°</button>
            <button class="menu-btn" onclick="toggleSound()" style="width:auto; padding:8px 15px; border:1px solid #999; border-radius:5px; background:#fff; color:#333; font-size:1rem; margin:0;">ì†Œë¦¬</button>
        </div>
    </div>

    <div id="screen-manage" class="screen" style="padding:20px; overflow-y:auto; background:#ECEFF1;">
        <h2 style="text-align:center; color:#333; margin-bottom:15px;">ë¬¸ì œ ë°ì´í„° ë² ì´ìŠ¤</h2>
        
        <div class="add-box" style="background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; border:2px solid #ccc;">
            <h3 style="margin-bottom:10px; color:#455A64;">ìƒˆ ë¬¸ì œ ë“±ë¡</h3>
            
            <div style="margin-bottom:10px;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">1. ì§ˆë¬¸ (Q)</label>
                <textarea id="new-q-text" placeholder="ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì…ë ¥" style="width:100%; height:50px; padding:5px; border:1px solid #ccc;"></textarea>
                <input type="file" id="new-q-img" accept="image/*" style="margin-top:5px; width:100%;">
            </div>

            <div style="margin-bottom:10px; padding-top:10px; border-top:1px dashed #ccc;">
                <label style="display:block; font-weight:bold; margin-bottom:5px;">2. ì •ë‹µ (A)</label>
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">* 'O' ë˜ëŠ” 'X'ë§Œ ì…ë ¥í•˜ë©´ ìë™ O/X ëª¨ë“œ, ê·¸ ì™¸ëŠ” ìê°€ íŒì • ëª¨ë“œê°€ ë©ë‹ˆë‹¤.</div>
                <textarea id="new-a-text" placeholder="ì •ë‹µ í…ìŠ¤íŠ¸ (ì˜ˆ: O, X, ë˜ëŠ” ìƒì„¸ ë‹µì•ˆ)" style="width:100%; height:50px; padding:5px; border:1px solid #ccc;"></textarea>
                <input type="file" id="new-a-img" accept="image/*" style="margin-top:5px; width:100%;">
            </div>

            <button onclick="addProblem()" class="menu-btn" style="padding:10px; background:#4CAF50; border-color:#2e7d32;">ë“±ë¡ í•˜ê¸°</button>
            
            <button class="menu-btn" style="background:#388E3C; margin-top:5px; padding:10px; font-size:0.9rem; border-color:#1b5e20;" onclick="toggleExcel()">ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡ (O/X ì „ìš©)</button>
            <div id="excel-area" style="display:none; margin-top:10px; background:#E8F5E9; padding:10px; border-radius:5px;">
                <p style="font-size:0.8rem; color:#2E7D32;">[ì§ˆë¬¸] [íƒ­] [O/X] [íƒ­] [í•´ì„¤(ì„ íƒ)]</p>
                <textarea id="excel-input" style="width:100%; height:80px; padding:5px; border:1px solid #A5D6A7;"></textarea>
                <button class="menu-btn" style="margin-top:5px; padding:8px; font-size:0.9rem; background:#4CAF50;" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button>
            </div>
        </div>

        <div style="background:#fff; padding:10px; border-radius:10px; border:2px solid #ccc; margin-bottom:10px;">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="menu-btn" style="flex:1; padding:8px; border:1px solid #999; background:#eee; font-size:0.9rem; color:#333; margin:0;" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                <button class="menu-btn" style="flex:1; padding:8px; border:1px solid #d32f2f; background:#ffcdd2; color:#d32f2f; font-size:0.9rem; margin:0;" onclick="deleteSelected()">ì‚­ì œ</button>
            </div>
            <div id="word-list" style="max-height:300px; overflow-y:auto;"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button class="menu-btn" style="flex:1; padding:10px; background:#fff; color:#333;" onclick="exportJSON()">ë°±ì—… ì €ì¥</button>
            <button class="menu-btn" style="flex:1; padding:10px; background:#fff; color:#333;" onclick="document.getElementById('json-input').click()">ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <button class="menu-btn" style="background:#546E7A; margin-top:20px;" onclick="showScreen('home')">ë©”ì¸ìœ¼ë¡œ</button>
    </div>
</div>
<input type="file" id="json-input" style="display:none" accept=".json" onchange="handleJsonFile(event)">
<script>
// ============================================================
// [1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •]
// ============================================================
// DB ë²„ì „ ë³€ê²½ (êµ¬ì¡°ê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ìƒˆ DB ì‚¬ìš©)
const DB_NAME = "HeroQuizDB_Legend_V4_Hybrid"; 
const DB_VERSION = 1; 
let db;
let vocabulary = [];

let player = {
    atk: 10, crit: 0, cdmg: 150, aspd: 1.0,     
    maxStage: 1, killCount: 0, totalTurns: 0  
};

let gameRunning = false;
let lastTime = 0;
let attackTimer = 0;
let combo = 0;
let comboTimer = null; 
let currentStage = 1;
let subStage = 0; 
let stageTimeLeft = 40; // ì‹œê°„ ì¡°ê¸ˆ ëŠ˜ë¦¼ (ì‚¬ê³  ì‹œê°„ ê³ ë ¤)

let mob = { hp: 100, maxHp: 100, level: 1, isBoss: false };
let currentQuizData = null; // í˜„ì¬ ë¬¸ì œ ë°ì´í„°

const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioCtx();
let isSoundOn = true;

// ============================================================
// [2. ë°ì´í„°ë² ì´ìŠ¤ & ì´ë¯¸ì§€ ìœ í‹¸ë¦¬í‹°]
// ============================================================
window.onload = function() {
    initDB();
    loadPlayerStats();
    setTimeout(() => {
        const loader = document.getElementById('loading-overlay');
        if(loader) {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
            const btn = document.getElementById('btn-start');
            if(btn) btn.disabled = false;
        }
    }, 1000);
};

function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = function(e) {
        db = e.target.result;
        // idë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ëŠ” ì €ì¥ì†Œ ìƒì„±
        if (!db.objectStoreNames.contains('vocab')) {
            db.createObjectStore('vocab', { keyPath: 'id', autoIncrement: true });
        }
    };
    req.onsuccess = function(e) {
        db = e.target.result;
        loadVocabulary();
    };
}

function loadVocabulary() {
    if(!db) return;
    const tx = db.transaction(['vocab'], 'readonly');
    const store = tx.objectStore('vocab');
    store.getAll().onsuccess = function(e) {
        vocabulary = e.target.result || [];
        // ë°ì´í„° ë¬´ê²°ì„± ì²´í¬
        vocabulary.forEach(v => {
            if (typeof v.wrongCount === 'undefined') v.wrongCount = 0;
            if (typeof v.lv === 'undefined') v.lv = 0;
            if (typeof v.nextTurn === 'undefined') v.nextTurn = 0;
            // í•˜ìœ„ í˜¸í™˜ì„± (ì´ë¯¸ì§€ í•„ë“œ ì—†ì„ ê²½ìš°)
            if (!v.qImg) v.qImg = null;
            if (!v.aImg) v.aImg = null;
        });
        updateHomeUI();
        if(document.getElementById('screen-manage').style.display === 'flex') {
            renderWordList();
        }
    };
}

// [ì´ë¯¸ì§€ ìµœì í™” í•¨ìˆ˜] : ì‚¬ì§„ ìš©ëŸ‰ì„ ì¤„ì—¬ì„œ DBì— ì €ì¥
function compressImage(file, maxWidth = 800, quality = 0.7) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                // ë¹„ìœ¨ ìœ ì§€ ë¦¬ì‚¬ì´ì§•
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // JPEG í¬ë§·ìœ¼ë¡œ ì••ì¶•
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}

function savePlayerStats() { localStorage.setItem('hero_stats_legend_v4', JSON.stringify(player)); }
function loadPlayerStats() {
    const data = localStorage.getItem('hero_stats_legend_v4');
    if (data) player = { ...player, ...JSON.parse(data) };
    updateHomeUI();
}
function updateHomeUI() { document.getElementById('home-best-stage').innerText = `${player.maxStage}-1`; }

// ============================================================
// [3. ì „íˆ¬ ì½”ì–´ ë¡œì§]
// ============================================================
function startGame() {
    if (vocabulary.length < 1) return showToast("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤! ë¬¸ì œ ê´€ë¦¬ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.", 'error');
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    showScreen('game');
    document.getElementById('hero-img').src = "player.PNG"; // í”Œë ˆì´ì–´ ì´ë¯¸ì§€(ì—†ìœ¼ë©´ ì—‘ë°•, ìˆë‹¤ë©´ í‘œì‹œ)
    
    currentStage = player.maxStage; 
    startStage(currentStage);
    gameRunning = true;
    lastTime = performance.now();
    
    nextQuiz(); // ì²« ë¬¸ì œ ì¶œì œ (Part 4 í•¨ìˆ˜)
    requestAnimationFrame(gameLoop);
}

function stopGame() {
    gameRunning = false;
    if (comboTimer) clearTimeout(comboTimer);
    combo = 0;
    updateBuffUI();
    savePlayerStats();
    showScreen('home');
}

function startStage(stg) {
    currentStage = stg;
    subStage = 0;
    stageTimeLeft = 40; // ì‹œê°„ ë„‰ë„‰íˆ
    spawnMob();
    updateStatUI();
}

function spawnMob() {
    const isBoss = subStage === 2; // 3ë²ˆì§¸ê°€ ë³´ìŠ¤
    let hp = Math.floor(200 * Math.pow(1.08, currentStage - 1));
    if (isBoss) hp *= 4; 
    
    const level = (currentStage * 3) + subStage + 1;
    mob = { hp: hp, maxHp: hp, level: level, isBoss: isBoss };
    
    // í¬ì¼“ëª¬ ìŠ¤í”„ë¼ì´íŠ¸ ID ê³„ì‚° (ëœë¤ì„± ë¶€ì—¬)
    let mobId;
    if (isBoss) mobId = (currentStage * 10) + 100 + Math.floor(Math.random() * 50);
    else mobId = (currentStage * 5) + (subStage * 2) + Math.floor(Math.random() * 20);
    mobId = (mobId % 898) + 1;

    const mobImg = document.getElementById('mob-img');
    mobImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${mobId}.png`;
    
    document.getElementById('stage-display').innerText = isBoss ? `BOSS STAGE` : `STAGE ${currentStage}-${subStage + 1}`;
    document.getElementById('mob-lv').innerText = level;
    
    if (isBoss) { mobImg.style.transform = "scale(1.5)"; mobImg.style.filter = "drop-shadow(0 0 5px #D32F2F)"; } 
    else { mobImg.style.transform = "scale(1.0)"; mobImg.style.filter = "none"; }
    
    updateMobHpUI();
}

function gameLoop(timestamp) {
    if (!gameRunning) return;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    // ë¬¸ì œ í’€ì´ ì¤‘ì—ëŠ” ì‹œê°„ì´ íë¥´ì§€ë§Œ, ë‹µ í™•ì¸ ë‹¨ê³„(ìê°€íŒì •)ì—ì„œë„ íë¦„ (ì••ë°•ê°)
    // ë‹¨, ë„ˆë¬´ ë¹ ë¥´ë©´ ì‚¬ì§„ ë³¼ ì‹œê°„ì´ ì—†ìœ¼ë¯€ë¡œ ì‹œê°„ì„ ì¡°ê¸ˆ ë” ë„‰ë„‰í•˜ê²Œ ì¡ì•˜ìŒ (40ì´ˆ)
    stageTimeLeft -= dt;
    if (stageTimeLeft <= 0) handleStageFail();
    
    const pct = (stageTimeLeft / 40) * 100;
    const bar = document.getElementById('time-bar');
    bar.style.width = Math.max(0, pct) + "%";
    bar.style.background = stageTimeLeft < 10 ? "#D32F2F" : "#FFD600";
    
    // ê³µê²© ì†ë„ ë¡œì§
    let totalAspd = player.aspd + (combo * 0.15);
    let currentAspd = Math.min(3.0, totalAspd);
    document.getElementById('stat-aspd').innerText = currentAspd.toFixed(1);

    attackTimer += dt;
    if (attackTimer >= (1 / currentAspd)) {
        attackTimer = 0;
        heroAttack();
    }
    requestAnimationFrame(gameLoop);
}

function handleStageFail() {
    showToast("ì‹œê°„ ì´ˆê³¼... ëˆˆì•ì´ ê¹œê¹œí•´ì¡Œë‹¤.", 'error');
    playSound('fail');
    combo = 0;
    updateBuffUI();
    currentStage = Math.max(1, currentStage - 1); // ìŠ¤í…Œì´ì§€ ê°•ë“±
    startStage(currentStage);
}

function heroAttack() {
    // ì‹œê°ì  ì—°ì¶œë§Œ ë‹´ë‹¹ (ì‹¤ì œ ë°ë¯¸ì§€ëŠ” ë¬¸ì œ ë§ì·„ì„ ë•Œ ë“¤ì–´ê°? -> ì•„ë‹˜, ìë™ ê³µê²©ì„)
    // ê¸°íš ì˜ë„: ìë™ ê³µê²©ì€ 'ê¸°ë³¸ ë°ë¯¸ì§€', ë¬¸ì œ ë§ì¶”ë©´ 'í° ë°ë¯¸ì§€/ë²„í”„'
    // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ì§¤ì§¤ì´ ê³µê²©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    
    const hero = document.getElementById('hero-img');
    const mobEl = document.getElementById('mob-img');
    
    hero.classList.remove('attack');
    void hero.offsetWidth; 
    hero.classList.add('attack');
    playSound('attack');
    
    // ê¸°ë³¸ ê³µê²©ë ¥ì˜ 20%ë§Œ ìë™ ê³µê²©ìœ¼ë¡œ ë“¤ì–´ê° (ë¬¸ì œ í’€ì´ê°€ ë©”ì¸)
    const baseDmg = Math.max(1, Math.floor(player.atk * 0.2));
    const result = calculateInfiniteCrit(baseDmg, player.crit, 0);
    
    mob.hp = Math.max(0, mob.hp - result.damage);
    
    setTimeout(() => {
        createDamageText(result.damage, result.tier);
        updateMobHpUI();
        mobEl.classList.remove('hit');
        void mobEl.offsetWidth;
        mobEl.classList.add('hit');
    }, 150); 
    
    checkMobDeath();
}

function checkMobDeath() {
    if (mob.hp <= 0) {
        setTimeout(() => {
            player.killCount++;
            subStage++;
            if (subStage >= 3) { 
                playSound('clear');
                showToast(`STAGE ${currentStage} í´ë¦¬ì–´!`, 'success');
                player.maxStage = Math.max(player.maxStage, currentStage + 1);
                startStage(currentStage + 1);
            } else { spawnMob(); }
        }, 400); 
    }
}

function calculateInfiniteCrit(dmg, critRate, tier) {
    let currentTierCrit = false;
    let chance = critRate - (tier * 100);
    if (chance >= 100 || Math.random() * 100 < chance) currentTierCrit = true;
    
    if (currentTierCrit) {
        let multiplier = player.cdmg / 100; 
        if (chance >= 100) return calculateInfiniteCrit(Math.floor(dmg * multiplier), critRate, tier + 1);
        else return { damage: Math.floor(dmg * multiplier), tier: tier + 1 };
    } else return { damage: dmg, tier: tier };
}

function createDamageText(dmg, tier) {
    const field = document.querySelector('.battle-field');
    const el = document.createElement('div');
    el.className = 'dmg-text';
    el.innerText = dmg.toLocaleString();
    if (tier >= 1) { el.style.color = "#FFD600"; el.innerText += "!"; }
    el.style.right = "15%"; el.style.top = "15%";
    field.appendChild(el);
    setTimeout(() => el.remove(), 800);
}

function updateMobHpUI() {
    const fill = document.getElementById('mob-hp');
    const pct = (mob.hp / mob.maxHp) * 100;
    fill.style.width = pct + "%";
    if(pct < 30) fill.classList.add('low'); else fill.classList.remove('low');
}

function updateStatUI() {
    document.getElementById('stat-atk').innerText = player.atk;
    document.getElementById('stat-crit').innerText = player.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = player.cdmg + "%";
}
// ============================================================
// [4. í€´ì¦ˆ ì‹œìŠ¤í…œ (í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ)]
// ============================================================
function prepareDeck() {
    let eligible = vocabulary.filter(v => v.nextTurn <= player.totalTurns);
    if (eligible.length === 0 && vocabulary.length > 0) {
        vocabulary.sort((a, b) => a.nextTurn - b.nextTurn);
        eligible.push(vocabulary[0]);
    }
    return eligible;
}

function nextQuiz() {
    const deck = prepareDeck();
    if (deck.length === 0) {
        document.getElementById('q-content-text').innerText = "ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.\n[ë¬¸ì œ ê´€ë¦¬]ì—ì„œ ë¬¸ì œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!";
        return;
    }

    const weightedPool = [];
    deck.forEach(v => {
        const weight = Math.max(1, 6 - v.lv); 
        for(let i=0; i<weight; i++) weightedPool.push(v);
    });
    const idx = Math.floor(Math.random() * weightedPool.length);
    currentQuizData = weightedPool[idx];

    renderQuizUI();
}

function renderQuizUI() {
    document.getElementById('box-answer').style.display = 'none';
    document.getElementById('btns-ox').style.display = 'none';
    document.getElementById('btns-check').style.display = 'none';
    document.getElementById('btns-judge').style.display = 'none';
    document.getElementById('btns-next').style.display = 'none';

    const qText = document.getElementById('q-content-text');
    const qImg = document.getElementById('q-content-img');
    
    qText.innerText = currentQuizData.q || "";
    if (currentQuizData.qImg) {
        qImg.src = currentQuizData.qImg;
        qImg.style.display = 'block';
    } else {
        qImg.style.display = 'none';
    }

    const pureAns = currentQuizData.a ? currentQuizData.a.trim().toUpperCase() : "";
    const isAutoOX = (pureAns === 'O' || pureAns === 'X');

    if (isAutoOX) {
        document.getElementById('btns-ox').style.display = 'flex';
    } else {
        document.getElementById('btns-check').style.display = 'flex';
    }
}

function submitAnswer(choice) {
    if (!currentQuizData) return;
    player.totalTurns++; 
    const realAns = currentQuizData.a.trim().toUpperCase();
    if (choice === realAns) handleCorrect();
    else handleWrong(realAns);
}

function revealAnswer() {
    playSound('click');
    const aBox = document.getElementById('box-answer');
    const aText = document.getElementById('a-content-text');
    const aImg = document.getElementById('a-content-img');

    aText.innerText = currentQuizData.a || "";
    if (currentQuizData.aImg) {
        aImg.src = currentQuizData.aImg;
        aImg.style.display = 'block';
    } else {
        aImg.style.display = 'none';
    }
    aBox.style.display = 'flex'; 

    document.getElementById('btns-check').style.display = 'none';
    document.getElementById('btns-judge').style.display = 'flex';
}

function judgeSelf(isCorrect) {
    player.totalTurns++;
    if (isCorrect) handleCorrect();
    else handleWrong("ì§ì ‘ í™•ì¸");
}

function handleCorrect() {
    playSound('correct');
    combo++;
    updateBuffUI();
    
    // ê³µê²© ì²˜ë¦¬
    const result = calculateInfiniteCrit(player.atk * 3, player.crit, 0); 
    mob.hp = Math.max(0, mob.hp - result.damage);
    updateMobHpUI();
    createDamageText(result.damage, result.tier);
    checkMobDeath(); 

    // â˜… [ìŠ¤íƒ¯ ìƒìŠ¹ ë¡œì§] - ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤ â˜…
    const rand = Math.random();
    let msg = "";
    if (rand < 0.4) { 
        player.atk += 2; 
        msg = "ê³µê²©ë ¥â–²"; 
    } else if (rand < 0.7) { 
        player.crit += 0.2; 
        msg = "ì¹˜ëª…íƒ€â–²"; 
    } else { 
        player.cdmg += 2; 
        msg = "ì¹˜ëª…í”¼í•´â–²"; 
    }
    
    // â˜… [ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„] í™”ë©´ ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ â˜…
    updateStatUI(); 
    
    showToast(`ì •ë‹µ! ${msg}`, 'success');

    currentQuizData.lv = Math.min(5, currentQuizData.lv + 1);
    currentQuizData.nextTurn = player.totalTurns + (currentQuizData.lv * 3) + 2; 
    updateWordStats(currentQuizData);
    savePlayerStats();

    showNextButton();
}

function handleWrong(answerText) {
    playSound('wrong');
    combo = 0;
    updateBuffUI();
    
    showToast(`í‹€ë ¸ìŠµë‹ˆë‹¤...`, 'error');
    const screen = document.getElementById('screen-game');
    screen.style.backgroundColor = '#ffcdd2';
    setTimeout(() => screen.style.backgroundColor = '', 300);

    currentQuizData.lv = 0;
    currentQuizData.nextTurn = player.totalTurns; 
    currentQuizData.wrongCount++; 
    updateWordStats(currentQuizData);
    savePlayerStats();

    showNextButton();
}

function updateWordStats(word) {
    const tx = db.transaction(['vocab'], 'readwrite');
    tx.objectStore('vocab').put(word);
}

function showNextButton() {
    document.getElementById('btns-ox').style.display = 'none';
    document.getElementById('btns-check').style.display = 'none';
    document.getElementById('btns-judge').style.display = 'none';
    const nextBtn = document.getElementById('btns-next');
    nextBtn.style.display = 'flex';
    document.getElementById('btn-next-quiz').focus();
}

function manualNextQuiz() {
    playSound('click');
    nextQuiz();
}

function updateBuffUI() {
    const badge = document.getElementById('buff-badge');
    badge.style.display = combo > 0 ? 'inline-block' : 'none';
}

// ============================================================
// [5. ë¬¸ì œ ê´€ë¦¬ (ì´ë¯¸ì§€ ì—…ë¡œë“œ í¬í•¨)]
// ============================================================
async function addProblem() {
    const qText = document.getElementById('new-q-text').value.trim();
    const aText = document.getElementById('new-a-text').value.trim();
    const qFile = document.getElementById('new-q-img').files[0];
    const aFile = document.getElementById('new-a-img').files[0];

    if (!qText && !qFile) return showToast("ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!", 'error');
    if (!aText && !aFile) return showToast("ì •ë‹µì„ ì…ë ¥í•˜ê±°ë‚˜ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!", 'error');

    showToast("ì €ì¥ ì¤‘...", 'info');

    let qImgData = null;
    let aImgData = null;

    try {
        if (qFile) qImgData = await compressImage(qFile);
        if (aFile) aImgData = await compressImage(aFile);
    } catch (e) {
        console.error(e);
        return showToast("ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨", 'error');
    }

    const newItem = {
        q: qText,
        a: aText, 
        qImg: qImgData,
        aImg: aImgData,
        lv: 0,
        nextTurn: 0,
        wrongCount: 0,
        date: Date.now()
    };

    const tx = db.transaction(['vocab'], 'readwrite');
    tx.objectStore('vocab').add(newItem);
    tx.oncomplete = () => {
        showToast("ë¬¸ì œ ë“±ë¡ ì™„ë£Œ!", 'success');
        document.getElementById('new-q-text').value = "";
        document.getElementById('new-a-text').value = "";
        document.getElementById('new-q-img').value = "";
        document.getElementById('new-a-img').value = "";
        loadVocabulary();
    };
}

function renderWordList() {
    const l = document.getElementById('word-list'); 
    l.innerHTML = "";
    if(vocabulary.length===0) { l.innerHTML="<p style='text-align:center;color:#999;padding:10px;'>ë°ì´í„° ì—†ìŒ</p>"; return; }
    
    const sorted = [...vocabulary].sort((a,b) => (b.date || 0) - (a.date || 0));

    sorted.forEach(v => {
        const d = document.createElement('div');
        d.style = "background:#FAFAFA; padding:8px; border-bottom:1px solid #eee; display:flex; gap:5px; align-items:center;";
        let typeBadge = "";
        if (v.qImg || v.aImg) typeBadge = "<span style='color:#E91E63; font-size:0.8rem;'>[ğŸ“·]</span>";
        d.innerHTML = `<input type="checkbox" class="word-check" data-id="${v.id}">
            <div style="flex:1; font-size:0.9rem; overflow:hidden;">
                ${typeBadge} <b>Q:</b> ${v.q || "(ì´ë¯¸ì§€)"} <br>
                <span style="color:#666;"><b>A:</b> ${v.a || "(ì´ë¯¸ì§€)"}</span>
            </div>`;
        l.appendChild(d);
    });
}

function deleteSelected() {
    const chk = document.querySelectorAll('.word-check:checked');
    if(chk.length===0) return showToast("ì„ íƒ í•­ëª© ì—†ìŒ");
    if(!confirm(`${chk.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    const tx = db.transaction(['vocab'], 'readwrite'); 
    const s = tx.objectStore('vocab');
    chk.forEach(c => s.delete(Number(c.dataset.id)));
    tx.oncomplete = () => { showToast("ì‚­ì œ ì™„ë£Œ"); loadVocabulary(); };
}

function selectAll() { const chk = document.querySelectorAll('.word-check'); const all = Array.from(chk).every(c=>c.checked); chk.forEach(c=>c.checked=!all); }

function exportJSON() {
    if(vocabulary.length===0) return showToast("ë°ì´í„° ì—†ìŒ");
    const blob = new Blob([JSON.stringify(vocabulary)], {type: "application/json"});
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = `hero_quiz_backup_${new Date().toISOString().slice(0,10)}.json`; 
    a.click();
}

function handleJsonFile(e) {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        try {
            const d = JSON.parse(ev.target.result);
            if(!Array.isArray(d)) throw new Error();
            if(!confirm(`ì´ ${d.length}ê°œì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)`)) return;
            const tx = db.transaction(['vocab'], 'readwrite'); 
            const s = tx.objectStore('vocab');
            d.forEach(i => { const n={...i}; delete n.id; s.add(n); });
            tx.oncomplete = () => { showToast("ë³µêµ¬ ì™„ë£Œ"); loadVocabulary(); };
        } catch(err) { showToast("íŒŒì¼ ì˜¤ë¥˜", 'error'); }
    };
    r.readAsText(f); e.target.value = "";
}

function toggleExcel() { const el = document.getElementById('excel-area'); el.style.display = el.style.display==='none'?'block':'none'; }
function parseExcel() {
    const v = document.getElementById('excel-input').value.trim();
    if(!v) return showToast("ë‚´ìš© ì—†ìŒ", 'error');
    const lines = v.split(/\r?\n/);
    let count = 0;
    const tx = db.transaction(['vocab'], 'readwrite');
    const s = tx.objectStore('vocab');
    lines.forEach(l => {
        const p = l.split('\t');
        if(p.length >= 2) {
            s.add({ q:p[0].trim(), a:p[1].trim().toUpperCase(), lv:0, nextTurn:0, wrongCount:0, date:Date.now() });
            count++;
        }
    });
    tx.oncomplete = () => { showToast(`${count}ê±´ ë“±ë¡ ì™„ë£Œ`); document.getElementById('excel-input').value=""; toggleExcel(); loadVocabulary(); };
}

// ============================================================
// [6. ìœ í‹¸ë¦¬í‹°]
// ============================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
    const target = document.getElementById('screen-' + id);
    target.style.display = 'flex';
    setTimeout(() => target.classList.add('active'), 10);
    if (id === 'manage') loadVocabulary(); 
}

function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerText = msg;
    if (type === 'error') toast.style.background = "#D32F2F";
    else if (type === 'success') toast.style.background = "#4CAF50";
    container.appendChild(toast);
    requestAnimationFrame(() => { toast.classList.add('show'); });
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2000);
}

function zoomImage(src) {
    if (!src) return;
    document.getElementById('modal-img').src = src;
    document.getElementById('modal-zoom').style.display = 'flex';
}
function closeModal() {
    document.getElementById('modal-zoom').style.display = 'none';
}

const snd = {
    click: (t) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'square'; o.frequency.setValueAtTime(600, t); g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.05); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.05); },
    attack: (t) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'sawtooth'; o.frequency.setValueAtTime(150, t); g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t + 0.1); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.1); },
    correct: (t) => { const g = audioCtx.createGain(); g.gain.value = 0.05; g.connect(audioCtx.destination); [880, 1108].forEach((f, i) => { const o = audioCtx.createOscillator(); o.type = 'square'; o.frequency.value = f; o.connect(g); o.start(t + i * 0.1); o.stop(t + i * 0.1 + 0.08); }); },
    wrong: (t) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'sawtooth'; o.frequency.setValueAtTime(150, t); g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t + 0.1); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.1); },
    clear: (t) => { const g = audioCtx.createGain(); g.gain.value = 0.05; g.connect(audioCtx.destination); [523, 659, 783, 1046, 783, 1046].forEach((f, i) => { const o = audioCtx.createOscillator(); o.type = 'square'; o.frequency.value = f; o.connect(g); o.start(t + i * 0.1); o.stop(t + i * 0.1 + 0.08); }); },
    fail: (t) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t + 0.5); g.gain.value = 0.05; o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.5); }
};
function playSound(type) { if (!isSoundOn || !audioCtx) return; if (audioCtx.state === 'suspended') audioCtx.resume(); snd[type](audioCtx.currentTime); }
function toggleSound() { isSoundOn = !isSoundOn; showToast(isSoundOn ? "ì‚¬ìš´ë“œ ì¼œì§" : "ì‚¬ìš´ë“œ êº¼ì§"); }

window.addEventListener('keydown', (e) => {
    const gameScreen = document.getElementById('screen-game');
    if (gameScreen.style.display !== 'flex') return;
    if (document.getElementById('btns-ox').style.display === 'flex') {
        if (e.key === 'ArrowLeft') submitAnswer('O');
        if (e.key === 'ArrowRight') submitAnswer('X');
    }
    else if (document.getElementById('btns-check').style.display === 'flex') {
        if (e.key === ' ' || e.key === 'Enter') revealAnswer();
    }
    else if (document.getElementById('btns-judge').style.display === 'flex') {
        if (e.key === 'ArrowLeft') judgeSelf(true);
        if (e.key === 'ArrowRight') judgeSelf(false);
    }
    else if (document.getElementById('btns-next').style.display === 'flex') {
        if (e.key === 'Enter' || e.key === ' ') manualNextQuiz();
    }
});
</script>
</body>
</html>
