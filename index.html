<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° RPG PRO: REMASTER</title>
<style>
/* [1. í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì •] */
@font-face { font-family: 'NeoDunggeunmo'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.3/NeoDunggeunmo.woff') format('woff'); font-weight: normal; font-style: normal; }

:root { 
    --bg-dark: #121013; 
    --bg-panel: #222034; 
    --text-main: #e0d8e8; 
    --accent: #f1c40f; 
    --primary: #8e44ad; 
    --success: #2ecc71; 
    --danger: #e74c3c;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; touch-action: manipulation; font-family: 'NeoDunggeunmo', monospace; }

body { 
    background: #000; 
    color: var(--text-main); 
    width: 100vw; 
    height: 100dvh; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column; 
}

/* [2. CRT ëª¨ë‹ˆí„° íš¨ê³¼ (ëˆˆ ì•„í”ˆ ê²©ì ì œê±°ë¨, ë¹„ë„¤íŒ…ë§Œ ìœ ì§€)] */
#crt-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
    box-shadow: inset 0 0 80px rgba(0,0,0,0.7); /* í™”ë©´ í…Œë‘ë¦¬ë¥¼ ì–´ë‘¡ê²Œ í•˜ì—¬ ëª°ì…ê° ì¦ëŒ€ */
}

/* [3. ê³µí†µ UI ì»´í¬ë„ŒíŠ¸] */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--bg-dark); }
.active { display: flex; }

/* ì…ì²´ í”½ì…€ ë²„íŠ¼ (CSS ê·¸ë¦¼ìë¡œ ì…ì²´ê° í‘œí˜„) */
.pixel-btn {
    position: relative; display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 15px; margin: 2px;
    background: #e0e0e0; color: #222; font-size: 1rem; text-transform: uppercase;
    border: none; cursor: pointer; image-rendering: pixelated;
    box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.4), inset 4px 4px 0px 0px #fff, 0 4px 0 #000;
    transition: transform 0.1s;
}
.pixel-btn:active { transform: translateY(4px); box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.4), inset 4px 4px 0px 0px #fff, 0 0 0 #000; }
.btn-green { background: #4cd964; color: #000; }
.btn-blue { background: #3498db; color: #fff; }
.btn-red { background: #ff3b30; color: #fff; }

/* 9-Slice íŒ¨ë„ ìŠ¤íƒ€ì¼ (ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë°°ê²½) */
.pixel-panel {
    background: var(--bg-panel); border: 4px solid #000;
    box-shadow: inset 4px 4px 0 #3f3f74, inset -4px -4px 0 #181425;
    position: relative;
}

/* [4. ì „íˆ¬ í™”ë©´ ë ˆì´ì•„ì›ƒ] */
/* ìƒë‹¨ HUD */
#top-hud {
    height: 60px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; 
    z-index: 20; background: rgba(0,0,0,0.6); border-bottom: 4px solid #000;
}
.stage-badge { color: var(--accent); font-size: 1.4rem; text-shadow: 2px 2px 0 #000; }
.timer-container { display: flex; flex-direction: column; align-items: flex-end; width: 120px; }
.timer-bar-bg { width: 100%; height: 10px; background: #333; border: 2px solid #000; margin-top: 4px; }
.timer-bar-fill { height: 100%; background: #f1c40f; width: 100%; transition: width 0.1s linear; }

/* ì „íˆ¬ í•„ë“œ (ë°°ê²½) */
#battle-viewport {
    flex: 1; position: relative; overflow: hidden;
    background: #000; display: flex; justify-content: center; align-items: flex-end;
}
/* í…Œë§ˆë³„ ë°°ê²½ìƒ‰ (ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œë¥¼ ëŒ€ë¹„í•œ í”½ì…€ ì•„íŠ¸í’ ê·¸ë¼ë°ì´ì…˜) */
.bg-forest { background: linear-gradient(to bottom, #3498db 0%, #85c1e9 50%, #2ecc71 50%, #27ae60 100%) !important; }
.bg-desert { background: linear-gradient(to bottom, #e67e22 0%, #f39c12 50%, #f1c40f 50%, #d35400 100%) !important; }
.bg-dungeon { background: linear-gradient(to bottom, #2c3e50 0%, #34495e 60%, #7f8c8d 60%, #95a5a6 100%) !important; }

/* ìºë¦­í„°/ëª¬ìŠ¤í„° */
.unit-container { position: absolute; bottom: 18%; width: 128px; height: 128px; display: flex; justify-content: center; align-items: flex-end; }
#hero-pos { left: 15%; z-index: 10; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5)); }
#mon-pos { right: 15%; z-index: 5; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5)); }
.sprite { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }

/* HP Bar (ì§€ì—° íš¨ê³¼ í¬í•¨) */
.hp-frame { position: absolute; top: -25px; width: 100px; height: 14px; background: #111; border: 2px solid #fff; padding: 2px; }
.hp-fill { height: 100%; background: #e74c3c; width: 100%; position: relative; z-index: 2; transition: width 0.1s; }
.hp-delay { position: absolute; top: 2px; left: 2px; height: calc(100% - 4px); background: #fff; width: 100%; z-index: 1; transition: width 0.5s ease-out 0.2s; }

/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
#control-panel {
    height: 40%; min-height: 280px; display: flex; flex-direction: column; padding: 12px;
    z-index: 30;
}
/* ìŠ¤íƒ¯ ë  */
#stat-ticker {
    display: flex; gap: 15px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; margin-bottom: 10px;
    overflow-x: auto; white-space: nowrap; border: 2px solid rgba(255,255,255,0.1);
}
.stat-item { color: #ccc; font-size: 0.9rem; }
.stat-val { color: #fff; font-weight: bold; margin-left: 4px; }
.pop-stat { color: var(--success); font-weight: bold; font-size: 0.8rem; margin-left:2px; animation: popUp 0.8s forwards; opacity:0; }

/* í€´ì¦ˆ ì˜ì—­ */
#quiz-area { flex: 1; display: flex; flex-direction: column; gap: 10px; }
#quiz-display {
    flex: 1; background: #141414; border: 2px solid #555; padding: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    position: relative; box-shadow: inset 0 0 20px #000;
}
#quiz-text { font-size: 1.3rem; line-height: 1.4; color: #fff; z-index: 2; white-space: pre-wrap; }
#quiz-img { max-height: 120px; max-width: 100%; border: 2px solid #000; margin-bottom: 8px; display: none; }
#input-row { display: flex; gap: 8px; height: 55px; }
#game-input {
    flex: 1; background: #eee; border: 4px solid #000; font-size: 1.4rem; padding: 0 15px;
    font-family: 'NeoDunggeunmo'; outline: none; border-radius: 0;
    box-shadow: inset 4px 4px 5px rgba(0,0,0,0.2);
}
#game-input:focus { background: #fff; border-color: var(--primary); }

/* [5. íŠ¹ìˆ˜ íš¨ê³¼ ë° ì• ë‹ˆë©”ì´ì…˜] */
@keyframes shake { 
    0% { transform: translate(0, 0); } 
    25% { transform: translate(-4px, 4px); } 
    50% { transform: translate(4px, -4px); } 
    75% { transform: translate(-4px, -4px); } 
    100% { transform: translate(0, 0); } 
}
.shake-effect { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

.dmg-text { 
    position: absolute; font-size: 2rem; font-weight: bold; color: #fff; 
    text-shadow: 3px 3px 0 #000; pointer-events: none; z-index: 100; 
    animation: dmgFloat 0.8s ease-out forwards; 
}
.dmg-crit { color: #ff005c; font-size: 2.5rem; text-shadow: 3px 3px 0 #fff, 5px 5px 0 #000; }
@keyframes dmgFloat { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }
@keyframes popUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }

/* [6. ëª¨ë‹¬ ë° ê¸°íƒ€] */
#modal-crop { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:9999; flex-direction:column; }
#toast { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:10px 20px; border:2px solid #fff; opacity:0; pointer-events:none; transition:opacity 0.3s; z-index:10000; }
</style>
</head>
<body>
    <div id="crt-overlay"></div>

    <div id="screen-rpg" class="screen active">
        
        <div id="top-hud">
            <div>
                <div class="stage-badge" id="ui-stage">STAGE 1-1</div>
                <div style="font-size:0.7rem; color:#888; letter-spacing:1px;">BATTLE FIELD</div>
            </div>
            <div class="timer-container">
                <span id="ui-timer-text" style="color:var(--accent); font-weight:bold; font-size:1.1rem;">30.0s</span>
                <div class="timer-bar-bg">
                    <div id="ui-timer-bar" class="timer-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="battle-viewport" class="bg-forest">
            <div id="fx-layer" style="position:absolute; width:100%; height:100%; pointer-events:none; z-index:50;"></div>
            
            <div id="hero-pos" class="unit-container">
                <img id="hero-img" class="sprite" alt="Hero">
            </div>

            <div id="mon-pos" class="unit-container">
                <div class="hp-frame">
                    <div id="mon-hp-delay" class="hp-delay"></div>
                    <div id="mon-hp-fill" class="hp-fill"></div>
                </div>
                <img id="mon-img" class="sprite" alt="Monster">
            </div>
        </div>

        <div id="control-panel" class="pixel-panel">
            <div id="stat-ticker">
                <span class="stat-item">âš”ï¸ATK <span id="stat-atk" class="stat-val">10</span><span id="pop-atk" class="pop-stat"></span></span>
                <span class="stat-item">ğŸ¹SPD <span id="stat-aspd" class="stat-val">1.00</span><span id="pop-aspd" class="pop-stat"></span></span>
                <span class="stat-item">âš¡CRI <span id="stat-crit" class="stat-val">5.0%</span><span id="pop-crit" class="pop-stat"></span></span>
                <span class="stat-item">ğŸ’¥CDM <span id="stat-cdmg" class="stat-val">150%</span><span id="pop-cdmg" class="pop-stat"></span></span>
                <span class="stat-item" style="border-left:1px solid #444; padding-left:10px;">ğŸ”¥COMBO <span id="stat-combo" class="stat-val" style="color:var(--accent)">0</span></span>
            </div>

            <div id="quiz-area">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.75rem; color:var(--text-dim); border-left:3px solid var(--primary); padding-left:5px;">CURRENT MISSION</span>
                    <button class="pixel-btn" style="padding:4px 8px; font-size:0.7rem; background:#444; color:#fff;" onclick="showScreen('manage')">âš™ï¸ DATABASE</button>
                </div>
                
                <div id="quiz-display">
                    <img id="quiz-img">
                    <div id="quiz-text">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...<br>(ë¬¸ì œê°€ ì—†ë‹¤ë©´ DATABASEì—ì„œ ë“±ë¡í•˜ì„¸ìš”)</div>
                    <div id="quiz-feedback" style="position:absolute; bottom:5px; font-weight:bold;"></div>
                </div>

                <div id="input-row">
                    <input id="game-input" type="text" placeholder="ì…ë ¥ í›„ ENTER" autocomplete="off" onkeypress="if(event.key==='Enter') checkAnswer()">
                    <button class="pixel-btn btn-red" style="width:100px; font-weight:bold; font-size:1.1rem;" onclick="checkAnswer()">HIT!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-manage" class="screen">
        <div style="padding:15px; background:var(--bg-panel); border-bottom:4px solid #000; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:#fff; text-shadow:2px 2px 0 #000; font-size:1.2rem;">DATA MANAGEMENT</h2>
            <button class="pixel-btn" onclick="showScreen('rpg')">ğŸ”™ BATTLE</button>
        </div>
        
        <div style="padding:15px; overflow-y:auto; flex:1; background:#f4f4f4;">
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="pixel-btn btn-green" style="flex:1" onclick="toggleAddMode('text')">ğŸ“ í…ìŠ¤íŠ¸ ì¶”ê°€</button>
                <button class="pixel-btn btn-blue" style="flex:1" onclick="toggleAddMode('image')">ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€</button>
            </div>
            
            <div id="add-text-box" class="pixel-panel" style="display:none; padding:15px; margin-bottom:15px; background:#ddd;">
                <input id="new-q" placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; margin-bottom:8px; border:2px solid #000;">
                <input id="new-a" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; margin-bottom:8px; border:2px solid #000;">
                <input id="new-desc" placeholder="ì •ë‹µ í•´ì„¤ (ì„ íƒ ì‚¬í•­)" style="width:100%; padding:12px; margin-bottom:8px; border:2px solid #000;">
                <button class="pixel-btn btn-green" style="width:100%" onclick="addTextWord()">ì €ì¥í•˜ê¸°</button>
                <button class="pixel-btn" style="width:100%; margin-top:10px; font-size:0.8rem;" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</button>
                <div id="excel-area" style="display:none; margin-top:8px">
                    <textarea id="excel-input" placeholder="ë¬¸ì œ[íƒ­]ì •ë‹µ í˜•ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="width:100%; height:100px; border:2px solid #000; font-size:0.8rem;"></textarea>
                    <button class="pixel-btn btn-blue" style="width:100%; margin-top:5px;" onclick="parseExcel()">ì¼ê´„ ì €ì¥</button>
                </div>
            </div>

            <div id="add-image-box" class="pixel-panel" style="display:none; padding:15px; margin-bottom:15px; background:#ddd;">
                <div id="p-area-q" style="width:100%; height:160px; background:#222; display:flex; align-items:center; justify-content:center; border:2px dashed #777; margin-bottom:10px;">
                    <img id="preview-q-img" style="display:none; max-width:100%; max-height:100%">
                    <span id="img-instruct" style="color:#666">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                </div>
                <button class="pixel-btn btn-blue" onclick="triggerCamera('question')" style="width:100%; margin-bottom:10px">ğŸ“· ì´¬ì˜ ë˜ëŠ” ê°¤ëŸ¬ë¦¬</button>
                <input id="img-a" placeholder="ì •ë‹µ" style="width:100%; padding:12px; margin-bottom:8px; border:2px solid #000;">
                <input id="img-desc" placeholder="í•´ì„¤" style="width:100%; padding:12px; margin-bottom:10px; border:2px solid #000;">
                <button class="pixel-btn btn-green" style="width:100%" onclick="addImageWord()">ì´ë¯¸ì§€ ë¬¸ì œ ì €ì¥</button>
            </div>

            <div style="background:#333; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <span style="font-size:0.9rem;">ë“±ë¡ëœ ë¬¸ì œ ëª©ë¡</span>
                <button class="pixel-btn btn-red" style="font-size:0.7rem; padding:4px 8px;" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
            </div>
            <div id="word-list" style="background:#fff; color:#000; min-height:200px; padding:5px; border:2px solid #333; border-top:none;"></div>
        </div>
        <input type="file" id="camera-input" style="display:none" accept="image/*" onchange="handleImageFile(event)">
    </div>

    <div id="modal-crop">
        <div style="flex:1; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; touch-action:none" id="crop-container">
            <canvas id="crop-canvas"></canvas>
        </div>
        <div style="height:80px; background:#222; display:flex; justify-content:space-around; align-items:center; border-top:4px solid #fff; padding:0 10px;">
            <button class="pixel-btn" onclick="rotateImage()">ğŸ”„ íšŒì „</button>
            <button class="pixel-btn btn-red" onclick="closeCrop()">ì·¨ì†Œ</button>
            <button class="pixel-btn btn-green" onclick="applyCrop()">âœ‚ï¸ ìë¥´ê¸° ì™„ë£Œ</button>
        </div>
    </div>

    <div id="toast"></div>
<script>
// ============================================================
// [1. ì‹œìŠ¤í…œ ì„¤ì • ë° ë°ì´í„°ë² ì´ìŠ¤]
// ============================================================
let db, vocabulary = [], isDBReady = false;
let rpgData = { stage: 1, subStage: 1, atk: 10, aspd: 1.0, crit: 5, cdmg: 150, combo: 0 };

// GitHub ì €ì¥ì†Œì˜ ë¡œì»¬ íŒŒì¼ ê²½ë¡œ
const HERO_IDLE_URL = "./hero.gif";     
const HERO_ATTACK_URL = "./attack.gif"; 

// ëª¬ìŠ¤í„° ì´ë¯¸ì§€ ë² ì´ìŠ¤ URL (PokeAPI)
const SPRITE_BASE_URL = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/";

const MONSTER_POOLS = {
    forest: ["1", "10", "13", "16", "19", "29", "32", "43", "69"], 
    desert: ["4", "27", "37", "50", "74", "95", "104", "111"], 
    dungeon: ["92", "93", "94", "109", "88", "132", "149", "90"]
};

window.onload = function() { 
    initDB(); 
    loadRPGData(); 
    
    const heroImg = document.getElementById('hero-img');
    heroImg.src = HERO_IDLE_URL;
    
    // íŒŒì¼ ë¯¸ì—…ë¡œë“œ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
    heroImg.onerror = function() {
        this.style.display = 'none';
        this.parentElement.innerHTML += "<div style='color:red; font-size:0.7rem; text-align:center;'>GIF íŒŒì¼ì„<br>ì—…ë¡œë“œí•˜ì„¸ìš”</div>";
    };
};

function showToast(msg) { 
    const t=document.getElementById('toast'); 
    t.innerText=msg; t.style.opacity=1; t.style.top="20%";
    setTimeout(()=>t.style.opacity=0, 2000); 
}

function showScreen(id) { 
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
    document.getElementById('screen-'+id).classList.add('active'); 
    if(id==='manage') renderWordList();
    if(id==='rpg') { updateStatUI(); if(!attackTimer && isDBReady) initBattle(); }
}

function initDB() {
    const r = indexedDB.open("RpgRemasterDB", 1);
    r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains('vocab')) e.target.result.createObjectStore('vocab', {keyPath:'id', autoIncrement:true}); };
    r.onsuccess = e => { db=e.target.result; loadVocab(); };
}

function loadVocab() { db.transaction(['vocab'],'readonly').objectStore('vocab').getAll().onsuccess = e => { vocabulary = e.target.result||[]; isDBReady=true; nextQuiz(); }; }
function saveToDB(item, cb) { db.transaction(['vocab'],'readwrite').objectStore('vocab').add(item).onsuccess = () => { loadVocab(); if(cb) cb(); }; }
function deleteFromDB(ids) { const tx=db.transaction(['vocab'],'readwrite'); ids.forEach(id=>tx.objectStore('vocab').delete(id)); tx.oncomplete=()=>{ showToast("ì‚­ì œ ì™„ë£Œ"); loadVocab(); renderWordList(); }; }

// ============================================================
// [2. RPG ì—”ì§„ & ì „íˆ¬ ë¡œì§]
// ============================================================
let battleTimer, attackTimer, timeLeft=30, currentMonHP=100, maxMonHP=100, isBoss=false;

function loadRPGData() {
    const s = localStorage.getItem('rpg_remaster_v10');
    if(s) rpgData = JSON.parse(s);
    updateStatUI(); initBattle();
}

function saveRPGData() { localStorage.setItem('rpg_remaster_v10', JSON.stringify(rpgData)); }

function updateStatUI() {
    document.getElementById('stat-atk').innerText = rpgData.atk;
    document.getElementById('stat-aspd').innerText = rpgData.aspd.toFixed(2);
    document.getElementById('stat-crit').innerText = rpgData.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = rpgData.cdmg + "%";
    document.getElementById('stat-combo').innerText = rpgData.combo;
    document.getElementById('ui-stage').innerText = `STAGE ${rpgData.stage}-${rpgData.subStage}`;
}

function initBattle() {
    clearInterval(battleTimer); clearInterval(attackTimer);
    if(rpgData.subStage === 1) timeLeft = 30;
    
    spawnMonster();
    attackTimer = setInterval(heroAttack, Math.max(300, 1000/rpgData.aspd)); 
    updateTimerUI();
    
    battleTimer = setInterval(() => {
        timeLeft -= 0.1; 
        if(timeLeft < 0) timeLeft = 0;
        updateTimerUI();
        
        if(timeLeft <= 0) { 
            clearInterval(battleTimer); clearInterval(attackTimer);
            showDamageText("TIME OVER!", true);
            showToast("ì‹¤íŒ¨! ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”");
            setTimeout(() => {
                rpgData.subStage = 1; 
                timeLeft = 30;
                updateStatUI(); // ìŠ¤í…Œì´ì§€ í…ìŠ¤íŠ¸ ì¦‰ì‹œ ê°±ì‹ 
                saveRPGData(); 
                initBattle(); 
            }, 1500);
        }
    }, 100);
}

function spawnMonster() {
    isBoss = (rpgData.subStage === 5); 
    const themes = ['forest', 'desert', 'dungeon'];
    const th = themes[Math.floor((rpgData.stage-1)/5)%3];
    document.getElementById('battle-viewport').className = "bg-"+th);

    const pool = MONSTER_POOLS[th];
    const id = pool[Math.floor(Math.random()*pool.length)];
    const targetId = isBoss ? "150" : id;
    const monSrc = SPRITE_BASE_URL + targetId + ".gif";
    
    const monImg = document.getElementById('mon-img');
    monImg.style.opacity = 0;
    monImg.onerror = function() { this.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${targetId}.png`; };
    setTimeout(()=>{ monImg.src = monSrc; monImg.style.opacity = 1; }, 200);

    let hp = 100 * Math.pow(1.1, rpgData.stage-1) * (1 + rpgData.subStage * 0.2);
    if(isBoss) hp *= 3;
    maxMonHP = Math.floor(hp); currentMonHP = maxMonHP;
    updateHPUI(true);
}

function heroAttack() {
    const hImg = document.getElementById('hero-img');
    const hPos = document.getElementById('hero-pos');
    hImg.src = HERO_ATTACK_URL;
    hPos.style.zIndex = 20; 
    hImg.style.transform = "scale(2.0) translateX(20px)";

    setTimeout(() => {
        let dmg = rpgData.atk;
        let isCrit = Math.random()*100 < rpgData.crit;
        if(isCrit) dmg *= (rpgData.cdmg/100);
        hitMonster(Math.floor(dmg), isCrit);
    }, 200);

    setTimeout(() => {
         hImg.src = HERO_IDLE_URL;
         hPos.style.zIndex = 10;
         hImg.style.transform = "scale(2.0) translateX(0)"; 
    }, 600);
}

function hitMonster(dmg, isCrit) {
    currentMonHP = Math.max(0, currentMonHP - dmg);
    updateHPUI(); 
    const m = document.getElementById('mon-img');
    m.style.filter = "brightness(5) sepia(1)"; 
    m.style.transform = "translateX(8px)";
    setTimeout(() => { m.style.filter = "none"; m.style.transform = "translateX(0)"; }, 100);
    if(isCrit) shakeScreen();
    showDamageText(dmg, isCrit);
    if(currentMonHP <= 0) monsterDeath();
}

function monsterDeath() {
    clearInterval(battleTimer); clearInterval(attackTimer);
    const m = document.getElementById('mon-img');
    m.style.transition = "opacity 0.5s"; m.style.opacity = 0;
    rpgData.subStage++;
    if(rpgData.subStage > 5) { rpgData.subStage = 1; rpgData.stage++; timeLeft = 30; }
    saveRPGData(); updateStatUI();
    setTimeout(() => { initBattle(); }, 1000);
}

function updateHPUI(instant = false) {
    const pct = (currentMonHP / maxMonHP) * 100;
    document.getElementById('mon-hp-fill').style.width = pct + '%';
    const delay = document.getElementById('mon-hp-delay');
    if(instant) { delay.style.transition = 'none'; delay.style.width = pct + '%'; }
    else { delay.style.transition = 'width 0.5s ease-out 0.2s'; delay.style.width = pct + '%'; }
}

function updateTimerUI() {
    document.getElementById('ui-timer-text').innerText = timeLeft.toFixed(1) + 's';
    document.getElementById('ui-timer-bar').style.width = (timeLeft/30*100) + '%';
}

function showDamageText(dmg, isCrit) {
    const el = document.createElement('div');
    el.className = isCrit ? 'dmg-text dmg-crit' : 'dmg-text';
    el.innerText = dmg;
    el.style.left = (40 + Math.random()*20)+'%'; el.style.top = (30 + Math.random()*20)+'%';
    document.getElementById('fx-layer').appendChild(el);
    setTimeout(()=>el.remove(), 800);
}

function shakeScreen() {
    const vp = document.getElementById('battle-viewport');
    vp.classList.add('shake-effect');
    setTimeout(()=>vp.classList.remove('shake-effect'), 300);
}

// ============================================================
// [3. í€´ì¦ˆ ë° ì‹œìŠ¤í…œ ìœ í‹¸ë¦¬í‹°]
// ============================================================
function nextQuiz() {
    if (vocabulary.length < 1) { document.getElementById('quiz-text').innerText = "ë¬¸ì œë¥¼ ë“±ë¡í•˜ì„¸ìš”!"; return; }
    currentQuiz = vocabulary[Math.floor(Math.random() * vocabulary.length)];
    const imgView = document.getElementById('quiz-img');
    const textView = document.getElementById('quiz-text');
    if (currentQuiz.type === 'image') { imgView.src = currentQuiz.q; imgView.style.display = 'block'; textView.innerText = ""; }
    else { imgView.style.display = 'none'; textView.innerText = currentQuiz.q; }
    document.getElementById('game-input').value = ""; document.getElementById('game-input').focus();
}

function checkAnswer() {
    if (!currentQuiz) return;
    const input = document.getElementById('game-input').value.trim();
    if (!input) return;
    const isCorrect = input.toUpperCase() === currentQuiz.a.toUpperCase();
    if (isCorrect) {
        rpgData.combo++; applyStatGrowth(rpgData.combo % 5 === 0 ? 3 : 1);
        heroAttack(); setTimeout(nextQuiz, 200);
    } else {
        rpgData.combo = 0; showToast("ì˜¤ë‹µ: " + currentQuiz.a); setTimeout(nextQuiz, 1500);
    }
    saveRPGData(); updateStatUI();
}

function applyStatGrowth(mult) {
    for(let i=0; i<mult; i++) {
        const r = Math.random();
        if(r < 0.4) rpgData.atk += 2;
        else if(r < 0.6) rpgData.aspd += 0.01;
        else if(r < 0.8) rpgData.crit += 0.1;
        else rpgData.cdmg += 2;
    }
}

// ì´ë¯¸ì§€ ê´€ë¦¬ ë° ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
function toggleAddMode(mode) { document.getElementById('add-text-box').style.display = mode==='text'?'block':'none'; document.getElementById('add-image-box').style.display = mode==='image'?'block':'none'; }
function addTextWord() { 
    const q=document.getElementById('new-q').value, a=document.getElementById('new-a').value;
    if(q&&a) saveToDB({type:'text',q,a,wrongCount:0}, ()=>{ showToast("ì €ì¥ë¨"); nextQuiz(); }); 
}
function renderWordList() { 
    const l = document.getElementById('word-list');
    l.innerHTML = vocabulary.map(v=>`<div class='list-item'><input type='checkbox' class='chk-del' value='${v.id}'> ${v.q} (${v.a})</div>`).join('');
}
</script>
</body>
</html>
