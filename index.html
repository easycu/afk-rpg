<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° ë§ˆìŠ¤í„°: íŠ¸ë ˆì´ë„ˆì˜ ê¸¸</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
/* --- [1. ê¸°ë³¸ í…Œë§ˆ & ë ˆì´ì•„ì›ƒ] --- */
:root {
    --primary: #FF5252;     /* ë ˆë“œ ì»¬ëŸ¬ */
    --primary-dark: #C62828;
    --accent: #FFD600;      /* ì „ê¸°/ê°•ì¡° */
    --bg-app: #ECEFF1;      /* ì•± ë°°ê²½ */
    --text: #37474F;
    --o-color: #2979FF;     /* Oë²„íŠ¼ íŒŒë‘ */
    --x-color: #D32F2F;     /* Xë²„íŠ¼ ë¹¨ê°• */
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; }

body { 
    font-family: 'Jua', sans-serif; 
    background: #263238; /* PC ë°°ê²½ (ì–´ë‘¡ê²Œ) */
    color: var(--text); 
    width: 100vw; height: 100dvh; 
    display: flex; justify-content: center; align-items: center; 
    overflow: hidden;
}

#app-container {
    width: 100%; height: 100%; max-width: 500px; /* ëª¨ë°”ì¼ ë¹„ìœ¨ ê³ ì • */
    background: var(--bg-app);
    display: flex; flex-direction: column;
    position: relative;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

/* --- [2. ì „íˆ¬ í™”ë©´ (Battle Field)] --- */
#area-battle { 
    flex: 0 0 42%; /* í™”ë©´ì˜ ì•½ 40% ì°¨ì§€ */
    position: relative; 
    /* ë°°í‹€ ë°°ê²½: í•˜ëŠ˜ê³¼ í’€ë°­ */
    background: linear-gradient(to bottom, #81D4FA 50%, #A5D6A7 50%);
    overflow: hidden; 
    display: flex; flex-direction: column; 
    border-bottom: 4px solid #455A64;
}

/* ìƒë‹¨ ìŠ¤í…Œì´ì§€ ì •ë³´ */
.stage-info-bar { 
    padding: 10px 15px; 
    display: flex; justify-content: space-between; align-items: center; 
    background: rgba(0,0,0,0.1); color: #fff; 
    font-size: 1.1rem; text-shadow: 1px 1px 0 rgba(0,0,0,0.3); z-index: 10;
}

/* ìºë¦­í„° ë°°ì¹˜ êµ¬ì—­ */
.battle-field { 
    flex: 1; width: 100%; 
    display: flex; justify-content: space-between; align-items: flex-end; 
    padding: 0 8% 25px 8%; /* ì¢Œìš° ì—¬ë°± */
    position: relative;
}

/* â˜… ë„íŠ¸ ê·¸ë˜í”½ ìµœì í™” (í•µì‹¬) â˜… */
.sprite-wrapper { 
    position: relative; 
    width: 130px; height: 130px; 
    display: flex; justify-content: center; align-items: flex-end;
}

.sprite { 
    width: 100%; height: 100%; 
    object-fit: contain; 
    position: relative; z-index: 5;
    
    /* ì´ë¯¸ì§€ë¥¼ íë¦¬ì§€ ì•Šê³  ë„íŠ¸ ê·¸ëŒ€ë¡œ ì„ ëª…í•˜ê²Œ í™•ëŒ€ */
    image-rendering: pixelated; 
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
    
    transition: transform 0.1s;
}

/* ê·¸ë¦¼ì */
.shadow { 
    position: absolute; bottom: 5px; 
    width: 90px; height: 25px; 
    background: rgba(0,0,0,0.25); 
    border-radius: 50%; z-index: 1; 
}

/* ìºë¦­í„°ë³„ í¬ê¸° ì¡°ì • */
#hero-img { 
    transform: scale(1.4) translateY(-5px); 
    transform-origin: bottom center;
}
#mob-img { 
    transform: scale(1.2) translateY(-5px); 
    transform-origin: bottom center;
}

/* ì• ë‹ˆë©”ì´ì…˜ */
.sprite.attack { animation: tackle 0.15s; } 
.sprite.hit { animation: blinkRed 0.3s; }

@keyframes tackle { 0%{transform:translateX(0) scale(1.4)} 50%{transform:translateX(25px) scale(1.4)} 100%{transform:translateX(0) scale(1.4)} }
@keyframes blinkRed { 0%,100%{filter:none} 50%{filter:sepia(1) hue-rotate(-50deg) saturate(5)} }

/* ì²´ë ¥ë°” */
.hp-bar-box { 
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
    width: 80px; height: 10px; 
    background: #546E7A; border: 2px solid #fff; border-radius: 5px; 
    overflow: hidden; z-index: 10;
    box-shadow: 0 2px 0 rgba(0,0,0,0.2);
}
.hp-fill { height: 100%; background: #4CAF50; width: 100%; transition: width 0.2s; }
.hp-fill.low { background: #FF5252 !important; }

/* ë°ë¯¸ì§€ í…ìŠ¤íŠ¸ */
.dmg-text { 
    position: absolute; font-weight: 900; color: #fff; font-size: 2rem; 
    text-shadow: 2px 2px 0 #000; z-index: 20; 
    animation: floatUp 0.8s forwards; pointer-events: none;
    font-family: 'Jua';
}
@keyframes floatUp { 0%{opacity:1; transform:translateY(0)} 100%{opacity:0; transform:translateY(-60px)} }

/* --- [3. í•˜ë‹¨ UI & í€´ì¦ˆ] --- */
#area-stat { 
    background: #37474F; color: #fff; 
    display: flex; justify-content: space-around; align-items: center;
    padding: 8px; font-size: 0.9rem; border-bottom: 2px solid #263238;
}
.stat-val { color: #69F0AE; font-weight: bold; }

#area-quiz { 
    flex: 1; padding: 15px; background: #fff; 
    display: flex; flex-direction: column; align-items: center;
}
#q-text-container {
    flex: 1; width: 100%; margin-bottom: 15px; padding: 20px;
    background: #FAFAFA; border: 2px solid #EEE; border-radius: 15px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.03);
}
#q-text { font-size: 1.35rem; text-align: center; word-break: keep-all; line-height: 1.5; color: #333; }

.ox-btn-group { width: 100%; display: flex; gap: 15px; height: 75px; margin-bottom: 10px; }
.btn-ox {
    flex: 1; border: none; border-radius: 15px;
    font-size: 2.5rem; color: #fff; font-family: 'Jua';
    box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: 0.1s;
}
.btn-ox:active { transform: translateY(5px); box-shadow: none; }
.btn-o { background: var(--o-color); }
.btn-x { background: var(--x-color); }

/* --- [4. ê³µí†µ UI ìš”ì†Œ] --- */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; }
.active { display: flex; }
.menu-btn { 
    width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 12px;
    font-size: 1.2rem; font-family: 'Jua'; color: #fff; 
    box-shadow: 0 4px 0 rgba(0,0,0,0.2); 
}
.menu-btn:active { transform: translateY(4px); box-shadow: none; }
.btn-game { background: var(--primary); }
.btn-review { background: #FF9800; }
.btn-manage { background: #795548; }

.toast { 
    position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%); 
    background: rgba(0,0,0,0.85); color: #fff; padding: 10px 25px; 
    border-radius: 25px; opacity: 0; transition: 0.3s; z-index: 9999; text-align: center; 
}
.toast.show { opacity: 1; transform: translate(-50%, 0); }
</style>
</head>
<body>
<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#263238;z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;flex-direction:column;">
    <div style="font-size:3rem; margin-bottom:10px; animation:bounce 1s infinite;">âš¡</div>
    <div>ë°°í‹€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<style>@keyframes bounce {0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)}}</style>
<div id="toast-container"></div>

<div id="app-container">
    <div id="screen-home" class="screen active" style="background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="background:#fff; width:130px; height:130px; border-radius:50%; display:flex; justify-content:center; align-items:center; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:20px; border:5px solid #FF5252;">
                <span style="font-size:4.5rem;">ğŸ§¢</span>
            </div>
            <h1 style="color:#C62828; font-size:2.8rem; text-shadow:2px 2px 0 #fff; margin-bottom:5px;">ì•”ê¸° ë§ˆìŠ¤í„°</h1>
            <p style="color:#D32F2F; font-size:1.2rem; opacity:0.8; font-weight:bold;">íŠ¸ë ˆì´ë„ˆì˜ ê¸¸</p>
            
            <div style="margin-top:30px; background:rgba(255,255,255,0.7); padding:15px 30px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                <div style="font-size:1.2rem; color:#5D4037; margin-bottom:5px;">ìµœê³  ìŠ¤í…Œì´ì§€: <b id="home-best-stage" style="color:#D32F2F;">1-1</b></div>
                <div style="font-size:1.1rem; color:#8D6E63;">í¬ì¼“ëª¬ í¬íšìˆ˜: <b id="home-kill-count">0</b>ë§ˆë¦¬</div>
            </div>
        </div>
        <div style="padding:20px;">
            <button id="btn-start" class="menu-btn btn-game" onclick="startGame()" disabled>âš”ï¸ ëª¨í—˜ ë– ë‚˜ê¸°</button>
            <button class="menu-btn btn-review" onclick="startReview()">ğŸ“• ì˜¤ë‹µ ë„ê°</button>
            <button class="menu-btn btn-manage" onclick="showScreen('manage')">âš™ï¸ ë¬¸ì œ ë°ì´í„° ê´€ë¦¬</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="area-battle">
            <div class="stage-info-bar">
                <span id="stage-display" style="background:rgba(0,0,0,0.3); padding:4px 12px; border-radius:15px;">STAGE 1-1</span>
                <div class="timer-container" style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.2rem;">â±ï¸</span>
                    <div style="width:100px; height:12px; background:rgba(0,0,0,0.3); border-radius:6px; border:1px solid rgba(255,255,255,0.5); overflow:hidden;">
                        <div id="time-bar" style="height:100%; width:100%; background:#FFD600;"></div>
                    </div>
                    <div id="time-text" style="width:45px; text-align:right; font-weight:bold;">30.0s</div>
                </div>
            </div>

            <div class="battle-field">
                <div class="sprite-wrapper">
                    <div class="hp-bar-box"><div id="hero-hp" class="hp-fill"></div></div>
                    <img id="hero-img" class="sprite hero" src="" alt="Trainer">
                    <div class="shadow"></div>
                </div>
                <div class="sprite-wrapper">
                    <div class="hp-bar-box"><div id="mob-hp" class="hp-fill"></div></div>
                    <img id="mob-img" class="sprite" src="" alt="Pokemon">
                    <div class="shadow"></div>
                </div>
            </div>
        </div>

        <div id="area-stat">
            <div class="stat-box">ê³µê²©ë ¥ <span id="stat-atk" class="stat-val">10</span></div>
            <div class="stat-box">ì¹˜ëª…íƒ€ <span id="stat-crit" class="stat-val">0%</span></div>
            <div class="stat-box">ì¹˜ëª…í”¼í•´ <span id="stat-cdmg" class="stat-val">150%</span></div>
            <div class="stat-box">
                <span id="buff-badge" style="display:none; background:#FF5252; color:#fff; padding:2px 5px; border-radius:5px; font-size:0.7rem; margin-right:5px;">COMBO!</span>
                ê³µì† <span id="stat-aspd" class="stat-val">1.0</span>
            </div>
        </div>

        <div id="area-quiz">
            <div id="q-text-container">
                <div id="q-text">ë¡œë”© ì¤‘...</div>
            </div>
            
            <div class="ox-btn-group" id="ox-buttons">
                <button class="btn-ox btn-o" onclick="submitAnswer('O')">O</button>
                <button class="btn-ox btn-x" onclick="submitAnswer('X')">X</button>
            </div>

            <div id="q-feedback" style="height:30px; font-size:1.2rem; font-weight:bold; margin-bottom:5px; color:#333; text-shadow:1px 1px 0 #fff;"></div>
            
            <div id="q-desc-display" style="display:none; width:100%; padding:15px; background:#E3F2FD; border-radius:10px; color:#1565C0; font-size:1rem; margin-bottom:10px; overflow-y:auto; border:2px solid #90CAF9; line-height:1.4;"></div> 
            
            <button id="btn-next-quiz" style="display:none; width:100%; padding:15px; background:#FFD600; color:#3E2723; border-radius:15px; font-size:1.3rem; box-shadow:0 4px 0 #F57F17; animation:pulse 1s infinite;" onclick="manualNextQuiz()">ğŸ”œ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ!</button>
        </div>

        <div id="area-menu" style="padding:10px; background:#ECEFF1; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #CFD8DC;">
            <button class="small-btn" onclick="stopGame()" style="padding:8px 15px; border-radius:8px; border:none; background:#B0BEC5; color:#455A64; font-family:'Jua';">ğŸ  ë„ë§ê°€ê¸°</button>
            <button class="small-btn" onclick="toggleSound()" style="padding:8px 15px; border-radius:8px; border:none; background:#B0BEC5; color:#455A64; font-family:'Jua';">ğŸ”Š ì†Œë¦¬ ì„¤ì •</button>
        </div>
    </div>

    <div id="screen-review" class="screen" style="padding:20px; background:#FFF3E0;">
        <h2 style="text-align:center; color:#EF6C00; margin-bottom:5px;">ğŸ“• ì˜¤ë‹µ ë„ê°</h2>
        <p id="review-status" style="text-align:center; color:#8D6E63; margin-bottom:20px;">ë³µìŠµí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        
        <div class="review-card" style="flex:1; background:#fff; border-radius:15px; padding:20px; display:flex; flex-direction:column; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
            <div style="text-align:center; margin-bottom:15px;">
                <span id="review-badge" style="background:#FF5252; color:#fff; padding:5px 10px; border-radius:8px; font-size:0.9rem;">3ë²ˆ í‹€ë¦¼</span>
            </div>
            <div id="review-q-container" style="flex:1; display:flex; align-items:center; justify-content:center; border:2px dashed #FFCC80; border-radius:10px; padding:15px; margin-bottom:15px;">
                <div id="review-q-text" style="font-size:1.2rem; text-align:center; line-height:1.4;">ë¬¸ì œ</div>
            </div>
            
            <div id="review-ox-btns" class="ox-btn-group">
                <button class="btn-ox btn-o" onclick="submitReview('O')">O</button>
                <button class="btn-ox btn-x" onclick="submitReview('X')">X</button>
            </div>
            
            <div id="review-feedback" style="text-align:center; font-weight:bold; height:30px; font-size:1.1rem; margin-bottom:10px;"></div>
            <div id="review-desc" style="display:none; height:100px; overflow-y:auto; background:#F5F5F5; padding:10px; border-radius:8px; font-size:0.9rem; margin-bottom:10px;"></div>
            
            <button id="btn-review-next" onclick="nextReview()" style="display:none; width:100%; padding:15px; background:#EF6C00; color:#fff; border-radius:12px; font-size:1.1rem;">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
        <button class="menu-btn" style="background:#8D6E63; margin-top:15px;" onclick="stopReview()">ğŸ  ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="screen-manage" class="screen" style="padding:20px; overflow-y:auto; background:#ECEFF1;">
        <h2 style="text-align:center; color:#455A64; margin-bottom:15px;">âš™ï¸ ë¬¸ì œ ë°ì´í„° ê´€ë¦¬</h2>
        
        <div class="add-box" style="background:#fff; padding:15px; border-radius:15px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <textarea id="new-q" placeholder="ë¬¸ì œ ë‚´ìš© ì…ë ¥" style="width:100%; height:70px; margin-bottom:10px; padding:10px; border:1px solid #CFD8DC; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:10px;">
                <label style="font-size:1.2rem; display:flex; align-items:center; gap:5px;"><input type="radio" name="new-a-radio" value="O" checked> <span style="color:#2979FF; font-weight:bold;">O</span></label>
                <label style="font-size:1.2rem; display:flex; align-items:center; gap:5px;"><input type="radio" name="new-a-radio" value="X"> <span style="color:#D32F2F; font-weight:bold;">X</span></label>
            </div>
            <textarea id="new-desc" placeholder="í•´ì„¤ ì…ë ¥ (ì„ íƒ)" style="width:100%; height:50px; margin-bottom:10px; padding:10px; border:1px solid #CFD8DC; border-radius:8px; resize:none;"></textarea>
            <button onclick="addTextWord()" class="menu-btn btn-game" style="padding:10px; font-size:1rem;">âœš ë¬¸ì œ ì¶”ê°€</button>
            <button class="menu-btn" style="background:#388E3C; margin-top:5px; padding:10px; font-size:1rem;" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</button>
            
            <div id="excel-area" style="display:none; margin-top:10px; background:#E8F5E9; padding:10px; border-radius:8px;">
                <p style="font-size:0.8rem; color:#2E7D32;">[ë¬¸ì œ] [O/X] [í•´ì„¤] (íƒ­ êµ¬ë¶„)</p>
                <textarea id="excel-input" style="width:100%; height:80px; padding:5px;"></textarea>
                <button class="menu-btn btn-game" style="margin-top:5px; padding:8px; font-size:0.9rem;" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button>
            </div>
        </div>

        <div style="background:#fff; padding:10px; border-radius:15px; margin-bottom:10px;">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="small-btn" style="flex:1; background:#90A4AE; color:#fff; padding:8px; border:none; border-radius:5px;" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                <button class="small-btn" style="flex:1; background:#FF5252; color:#fff; padding:8px; border:none; border-radius:5px;" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
            </div>
            <div id="word-list" style="max-height:250px; overflow-y:auto;"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button class="small-btn" style="flex:1; padding:10px; background:#78909C; color:#fff; border:none; border-radius:8px;" onclick="exportJSON()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
            <button class="small-btn" style="flex:1; padding:10px; background:#78909C; color:#fff; border:none; border-radius:8px;" onclick="document.getElementById('json-input').click()">ğŸ“‚ ë°ì´í„° ë³µêµ¬</button>
        </div>
        <button class="menu-btn" style="background:#546E7A; margin-top:20px;" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
    </div>
</div>
<input type="file" id="json-input" style="display:none" accept=".json" onchange="handleJsonFile(event)">
<script>
// ============================================================
// [1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •]
// ============================================================
const DB_NAME = "HeroQuizDB_Trainer_v1"; // DB ì´ë¦„ ë³€ê²½ (ì¶©ëŒ ë°©ì§€)
const DB_VERSION = 1; 
let db;
let vocabulary = [];

// í”Œë ˆì´ì–´ ìŠ¤íƒ¯ (ê¸°ë³¸ê°’)
let player = {
    atk: 10,       // ê³µê²©ë ¥
    crit: 0,       // ì¹˜ëª…íƒ€ìœ¨ (%)
    cdmg: 150,     // ì¹˜ëª…íƒ€ í”¼í•´ (%)
    aspd: 1.0,     // ê³µê²© ì†ë„
    maxStage: 1,   // ìµœê³  ìŠ¤í…Œì´ì§€
    killCount: 0,  // í¬íš(ì²˜ì¹˜) ìˆ˜
    totalTurns: 0  // [ì‹œìŠ¤í…œ] ì‹œê°„ì¶• (ë¼ì´íŠ¸ë„ˆ ì‹œìŠ¤í…œ)
};

// ê²Œì„ ìƒíƒœ ë³€ìˆ˜
let gameRunning = false;
let lastTime = 0;
let attackTimer = 0;
let combo = 0;
let comboTimer = null; 
let currentStage = 1;
let subStage = 0; 
let stageTimeLeft = 30;
let mob = { hp: 100, maxHp: 100, isBoss: false };

// í€´ì¦ˆ ë° ì˜¤ë‹µë…¸íŠ¸ í
let currentQuizData = null;
let reviewQueue = [];
let currentReviewData = null;

// ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioCtx();
let isSoundOn = true;

// ============================================================
// [2. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”]
// ============================================================
window.onload = function() {
    initDB();
    loadPlayerStats();
    
    // ë¡œë”© í™”ë©´ ì²˜ë¦¬
    setTimeout(() => {
        const loader = document.getElementById('loading-overlay');
        if(loader) {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
            
            const btnStart = document.getElementById('btn-start');
            if(btnStart) btnStart.disabled = false;
        }
    }, 1500);
};

function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = function(e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains('vocab')) {
            db.createObjectStore('vocab', { keyPath: 'id', autoIncrement: true });
        }
    };
    req.onsuccess = function(e) {
        db = e.target.result;
        loadVocabulary();
    };
}

function loadVocabulary() {
    if(!db) return;
    const tx = db.transaction(['vocab'], 'readonly');
    const store = tx.objectStore('vocab');
    store.getAll().onsuccess = function(e) {
        vocabulary = e.target.result || [];
        // ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬
        vocabulary.forEach(v => {
            if (typeof v.wrongCount === 'undefined') v.wrongCount = 0;
            if (typeof v.lv === 'undefined') v.lv = 0;
            if (typeof v.nextTurn === 'undefined') v.nextTurn = 0;
        });
        updateHomeUI();
        if(document.getElementById('screen-manage').style.display === 'flex') {
            renderWordList();
        }
    };
}

function savePlayerStats() {
    localStorage.setItem('hero_stats_trainer', JSON.stringify(player));
}
function loadPlayerStats() {
    const data = localStorage.getItem('hero_stats_trainer');
    if (data) player = { ...player, ...JSON.parse(data) };
    updateHomeUI();
}

function updateHomeUI() {
    document.getElementById('home-best-stage').innerText = `${player.maxStage}-1`; 
    document.getElementById('home-kill-count').innerText = player.killCount;
}

// ============================================================
// [3. ê²Œì„ ë¡œì§ (ì „íˆ¬ & ì´ë¯¸ì§€ ë¡œë“œ)]
// ============================================================
function startGame() {
    if (vocabulary.length < 1) return showToast("ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ëª¨í—˜ì„ ë– ë‚  ìˆ˜ ì—†ì–´ìš”!", 'error');
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    prepareDeck(); 
    showScreen('game');

    // [ì´ë¯¸ì§€ ì„¤ì • 1] í”Œë ˆì´ì–´ (ì§€ìš°/ë ˆë“œ ë’·ëª¨ìŠµ)
    // Pokemon Showdownì˜ íŠ¸ë ˆì´ë„ˆ ìŠ¤í”„ë¼ì´íŠ¸ ì‚¬ìš© (ë§¤ìš° ê¹”ë”í•¨)
    const heroImg = document.getElementById('hero-img');
    heroImg.src = "https://play.pokemonshowdown.com/sprites/trainers-back/red.png";
    
    currentStage = player.maxStage; 
    startStage(currentStage);
    gameRunning = true;
    lastTime = performance.now();
    
    nextQuiz(); 
    requestAnimationFrame(gameLoop);
}

function stopGame() {
    gameRunning = false;
    if (comboTimer) clearTimeout(comboTimer);
    combo = 0;
    updateBuffUI();
    savePlayerStats();
    showScreen('home');
}

function startStage(stg) {
    currentStage = stg;
    subStage = 0;
    stageTimeLeft = 30;
    spawnMob();
    updateStatUI();
}

function spawnMob() {
    const isBoss = subStage === 2; // 3ë²ˆì§¸ ë§ˆë‹¤ ë³´ìŠ¤
    let hp = Math.floor(200 * Math.pow(1.08, currentStage - 1));
    if (isBoss) hp *= 3.5; 
    
    mob = { hp: hp, maxHp: hp, isBoss: isBoss };
    
    // [ì´ë¯¸ì§€ ì„¤ì • 2] ëª¬ìŠ¤í„° (í¬ì¼“ëª¬ ë„íŠ¸)
    // ê³µì‹: ìŠ¤í…Œì´ì§€ê°€ ë†’ì„ìˆ˜ë¡ ë„ê° ë²ˆí˜¸ê°€ ë†’ì€ í¬ì¼“ëª¬ ë“±ì¥
    let mobId;
    if (isBoss) {
        // ë³´ìŠ¤: 3ë‹¨ ì§„í™”ì²´ ëŠë‚Œ (ë²ˆí˜¸ë¥¼ í¬ê²Œ ì¡ìŒ)
        mobId = (currentStage * 10) + 100 + Math.floor(Math.random() * 50);
    } else {
        // ì¼ë°˜: ìŠ¤í…Œì´ì§€ ë¹„ë¡€ + ëœë¤
        let base = (currentStage * 5) + (subStage * 2);
        mobId = base + Math.floor(Math.random() * 20);
    }
    
    // ë„ê° ë²ˆí˜¸ ë²”ìœ„ ì œí•œ (1 ~ 898)
    if (mobId > 898) mobId = (mobId % 898) + 1;
    if (mobId < 1) mobId = 1;

    const mobImg = document.getElementById('mob-img');
    // PokeAPI ê¸°ë³¸ ìŠ¤í”„ë¼ì´íŠ¸ (ì •ì§€ ì´ë¯¸ì§€, ë„íŠ¸ ìŠ¤íƒ€ì¼)
    mobImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${mobId}.png`;
    
    // ë³´ìŠ¤ ì—°ì¶œ
    if (isBoss) {
        mobImg.style.transform = "scale(1.5) translateY(-10px)";
        mobImg.style.filter = "drop-shadow(0 0 5px #D32F2F)";
    } else {
        mobImg.style.transform = "scale(1.2) translateY(-5px)";
        mobImg.style.filter = "none";
    }
    
    document.getElementById('stage-display').innerText = `STAGE ${currentStage}-${subStage + 1}`;
    updateMobHpUI();
}

function gameLoop(timestamp) {
    if (!gameRunning) return;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    stageTimeLeft -= dt;
    if (stageTimeLeft <= 0) handleStageFail();
    
    // íƒ€ì´ë¨¸ UI
    const pct = (stageTimeLeft / 30) * 100;
    const bar = document.getElementById('time-bar');
    bar.style.width = Math.max(0, pct) + "%";
    bar.style.background = stageTimeLeft < 5 ? "#FF5252" : "#FFD600";
    
    const timeText = document.getElementById('time-text');
    if(timeText) {
        timeText.innerText = Math.max(0, stageTimeLeft).toFixed(1) + "s";
        timeText.style.color = stageTimeLeft < 5 ? "#FF5252" : "#333";
    }

    // ê³µê²© ì†ë„ ê³„ì‚° (ì½¤ë³´ ë³´ë„ˆìŠ¤)
    let totalAspd = player.aspd + (combo * 0.15);
    let currentAspd = Math.min(3.0, totalAspd); // ìµœëŒ€ ê³µì† ì œí•œ
    document.getElementById('stat-aspd').innerText = currentAspd.toFixed(1);

    attackTimer += dt;
    if (attackTimer >= (1 / currentAspd)) {
        attackTimer = 0;
        heroAttack();
    }
    requestAnimationFrame(gameLoop);
}

function handleStageFail() {
    showToast("ëˆˆì•ì´ ê¹œê¹œí•´ì¡Œë‹¤... (ì‹œê°„ì´ˆê³¼)", 'error');
    playSound('fail');
    if (comboTimer) clearTimeout(comboTimer);
    combo = 0;
    updateBuffUI();
    currentStage = Math.max(1, currentStage - 1);
    startStage(currentStage);
}

function heroAttack() {
    const hero = document.querySelector('.sprite.hero');
    hero.classList.remove('attack');
    void hero.offsetWidth; // ë¦¬í”Œë¡œìš°
    hero.classList.add('attack');
    
    playSound('attack');
    
    const result = calculateInfiniteCrit(player.atk, player.crit, 0);
    mob.hp = Math.max(0, mob.hp - result.damage);
    
    createDamageText(result.damage, result.tier);
    updateMobHpUI();
    
    const mobEl = document.getElementById('mob-img');
    mobEl.classList.remove('hit');
    void mobEl.offsetWidth;
    mobEl.classList.add('hit');
    
    if (mob.hp <= 0) {
        player.killCount++;
        subStage++;
        if (subStage >= 3) { 
            playSound('clear');
            showToast(`STAGE ${currentStage} í´ë¦¬ì–´!`, 'success');
            player.maxStage = Math.max(player.maxStage, currentStage + 1);
            startStage(currentStage + 1);
        } else {
            spawnMob();
        }
    }
}

function calculateInfiniteCrit(dmg, critRate, tier) {
    let currentTierCrit = false;
    let chance = critRate - (tier * 100);
    if (chance >= 100 || Math.random() * 100 < chance) currentTierCrit = true;
    
    if (currentTierCrit) {
        let multiplier = player.cdmg / 100; 
        if (chance >= 100) return calculateInfiniteCrit(Math.floor(dmg * multiplier), critRate, tier + 1);
        else return { damage: Math.floor(dmg * multiplier), tier: tier + 1 };
    } else return { damage: dmg, tier: tier };
}

function createDamageText(dmg, tier) {
    const field = document.querySelector('.battle-field');
    const el = document.createElement('div');
    el.className = 'dmg-text';
    el.innerText = dmg.toLocaleString();
    
    if (tier >= 1) {
        el.style.color = "#FFD600"; // í¬ë¦¬í‹°ì»¬ ë…¸ë€ìƒ‰
        el.style.fontSize = "2.5rem";
        el.innerText += "!";
    }
    
    const x = 60 + (Math.random() * 20 - 10);
    const y = 40 + (Math.random() * 20 - 10);
    el.style.left = x + "%"; 
    el.style.top = y + "%";
    
    field.appendChild(el);
    setTimeout(() => el.remove(), 800);
}

function updateMobHpUI() {
    const fill = document.getElementById('mob-hp');
    const pct = (mob.hp / mob.maxHp) * 100;
    fill.style.width = pct + "%";
    
    // ì²´ë ¥ ë‚®ìœ¼ë©´ ë¹¨ê°„ìƒ‰
    if(pct < 30) fill.classList.add('low');
    else fill.classList.remove('low');
}

function updateStatUI() {
    document.getElementById('stat-atk').innerText = player.atk;
    document.getElementById('stat-crit').innerText = player.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = player.cdmg + "%";
}

// ============================================================
// [4. í€´ì¦ˆ ì‹œìŠ¤í…œ (Leitner System)]
// ============================================================
function prepareDeck() {
    let eligible = vocabulary.filter(v => v.nextTurn <= player.totalTurns);
    if (eligible.length === 0 && vocabulary.length > 0) {
        vocabulary.sort((a, b) => a.nextTurn - b.nextTurn);
        eligible.push(vocabulary[0]);
    }
    return eligible;
}

function nextQuiz() {
    const deck = prepareDeck();
    if (deck.length === 0) {
        document.getElementById('q-text').innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ ë©”ë‰´ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
        return;
    }
    
    // ê°€ì¤‘ì¹˜ ëœë¤
    const weightedPool = [];
    deck.forEach(v => {
        const weight = Math.max(1, 6 - v.lv); 
        for(let i=0; i<weight; i++) weightedPool.push(v);
    });

    const idx = Math.floor(Math.random() * weightedPool.length);
    currentQuizData = weightedPool[idx];

    // UI ë¦¬ì…‹
    document.getElementById('ox-buttons').style.display = 'flex'; 
    document.getElementById('btn-next-quiz').style.display = 'none'; 
    document.getElementById('q-feedback').innerText = "";
    document.getElementById('q-desc-display').style.display = 'none';
    
    document.getElementById('q-text').innerText = currentQuizData.q;
}

function manualNextQuiz() {
    playSound('click'); 
    nextQuiz();
}

function submitAnswer(choice) {
    if (!currentQuizData) return;
    if (document.getElementById('btn-next-quiz').style.display === 'block') return;

    const realAns = currentQuizData.a.trim().toUpperCase();
    player.totalTurns++; 

    if (choice === realAns) {
        // [ì •ë‹µ]
        handleCorrect();
        currentQuizData.lv = Math.min(5, currentQuizData.lv + 1);
        currentQuizData.nextTurn = player.totalTurns + (currentQuizData.lv * 3) + 2; 
    } else {
        // [ì˜¤ë‹µ]
        handleWrong();
        currentQuizData.lv = 0;
        currentQuizData.nextTurn = player.totalTurns; 
        currentQuizData.wrongCount++; 
    }

    updateWordStats(currentQuizData);
    savePlayerStats();
}

function updateWordStats(word) {
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    store.put(word);
}

function showResultUI() {
    const descDisplay = document.getElementById('q-desc-display');
    if (currentQuizData.desc && currentQuizData.desc.trim() !== "") {
        descDisplay.style.display = 'block';
        descDisplay.innerText = "ğŸ’¡ " + currentQuizData.desc;
    } else {
        descDisplay.style.display = 'none';
    }
    document.getElementById('ox-buttons').style.display = 'none';
    const nextBtn = document.getElementById('btn-next-quiz');
    nextBtn.style.display = 'block';
    nextBtn.focus();
}

function handleCorrect() {
    playSound('correct');
    combo++;
    updateBuffUI();
    resetComboTimer(); 

    // ëœë¤ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤
    const rand = Math.random();
    let msg = "";
    if (rand < 0.4) { player.atk += 2; msg = "ê³µê²©ë ¥â–²"; } 
    else if (rand < 0.7) { player.crit += 0.2; msg = "ì¹˜ëª…íƒ€â–²"; } 
    else { player.cdmg += 2; msg = "ì¹˜ëª…í”¼í•´â–²"; }
    
    updateStatUI();
    heroAttack(); // ì¶”ê°€ ê³µê²©

    const fb = document.getElementById('q-feedback');
    fb.style.color = "#2979FF";
    fb.innerText = `íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! (${msg})`;
    
    showResultUI(); 
}

function handleWrong() {
    playSound('wrong');
    combo = 0;
    updateBuffUI();
    if (comboTimer) clearTimeout(comboTimer);

    const fb = document.getElementById('q-feedback');
    fb.style.color = "#D32F2F";
    fb.innerText = `ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤... (ì •ë‹µ: ${currentQuizData.a})`;
    
    showResultUI(); 
}

function updateBuffUI() {
    const badge = document.getElementById('buff-badge');
    if (combo > 0) {
        badge.style.display = 'inline-block';
        badge.innerText = `${combo} COMBO!`;
    } else {
        badge.style.display = 'none';
    }
}

function resetComboTimer() {
    if (comboTimer) clearTimeout(comboTimer);
    comboTimer = setTimeout(() => {
        if (combo > 0) {
            showToast("ì½¤ë³´ê°€ ëŠê²¼ë‹¤!", 'info');
            combo = 0;
            updateBuffUI();
        }
    }, 8000); 
}

// ============================================================
// [5. í™”ë©´ ê´€ë¦¬ ë° ìœ í‹¸]
// ============================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
    });
    const target = document.getElementById('screen-' + id);
    target.style.display = 'flex';
    setTimeout(() => target.classList.add('active'), 10);
    
    if (id === 'manage') loadVocabulary(); 
}

function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerText = msg;
    if (type === 'error') toast.style.background = "#D32F2F";
    if (type === 'success') toast.style.background = "#388E3C";
    container.appendChild(toast);
    
    requestAnimationFrame(() => { toast.classList.add('show'); });
    setTimeout(() => { 
        toast.classList.remove('show'); 
        setTimeout(() => toast.remove(), 300); 
    }, 2000);
}

// [ì‚¬ìš´ë“œ íš¨ê³¼ (8bit ìŠ¤íƒ€ì¼)]
const snd = {
    click: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(600, t);
        g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.05);
    },
    attack: (t) => { // í½! ì†Œë¦¬
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'sawtooth'; o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(10, t + 0.1);
        g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t + 0.1);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.1);
    },
    correct: (t) => { // ë ë§!
        const g = audioCtx.createGain(); g.gain.value = 0.05; g.connect(audioCtx.destination);
        [880, 1108].forEach((f, i) => { 
            const o = audioCtx.createOscillator(); o.type = 'square'; o.frequency.value = f;
            o.connect(g); o.start(t + i * 0.1); o.stop(t + i * 0.1 + 0.08);
        });
    },
    wrong: (t) => { // ë¡.
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'sawtooth'; o.frequency.setValueAtTime(150, t); 
        g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t + 0.1);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.1);
    },
    clear: (t) => { // ìŠ¹ë¦¬ íŒ¡íŒŒë ˆ
        const g = audioCtx.createGain(); g.gain.value = 0.05; g.connect(audioCtx.destination);
        [523, 659, 783, 1046, 783, 1046].forEach((f, i) => {
            const o = audioCtx.createOscillator(); o.type = 'square'; o.frequency.value = f;
            o.connect(g); o.start(t + i * 0.1); o.stop(t + i * 0.1 + 0.08);
        });
    },
    fail: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t + 0.5);
        g.gain.value = 0.05; o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.5);
    }
};

function playSound(type) {
    if (!isSoundOn || !audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    snd[type](audioCtx.currentTime);
}

function toggleSound() {
    isSoundOn = !isSoundOn;
    showToast(isSoundOn ? "ì‚¬ìš´ë“œ ì¼œì§" : "ì‚¬ìš´ë“œ êº¼ì§");
}

// í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤
window.addEventListener('keydown', (e) => {
    if (document.getElementById('screen-game').style.display === 'flex') {
        if (e.key === 'ArrowLeft') submitAnswer('O');
        if (e.key === 'ArrowRight') submitAnswer('X');
        if (e.key === 'Enter' && document.getElementById('btn-next-quiz').style.display === 'block') manualNextQuiz();
    }
});

// ============================================================
// [6. ì˜¤ë‹µ ë…¸íŠ¸ & ë°ì´í„° ê´€ë¦¬]
// ============================================================
// (ì˜¤ë‹µë…¸íŠ¸/ì—‘ì…€íŒŒì‹±/ë°±ì—… ê¸°ëŠ¥ì€ ë¶„ëŸ‰ìƒ ì´ì „ ë²„ì „ê³¼ ë¡œì§ ë™ì¼)
function startReview() {
    if (vocabulary.length === 0) return showToast("ë°ì´í„° ì—†ìŒ", 'error');
    reviewQueue = vocabulary.filter(v => v.wrongCount > 0);
    if (reviewQueue.length === 0) return showToast("ì˜¤ë‹µ ì—†ìŒ! ì™„ë²½í•´ìš”.", 'success');
    reviewQueue.sort((a, b) => b.wrongCount - a.wrongCount);
    showScreen('review');
    document.getElementById('review-status').innerText = `ë³µìŠµ ëŒ€ê¸°: ${reviewQueue.length}ê°œ`;
    nextReview();
}
function stopReview() { showScreen('home'); }
function nextReview() {
    if (reviewQueue.length === 0) { alert("ë³µìŠµ ì™„ë£Œ!"); stopReview(); return; }
    currentReviewData = reviewQueue.shift();
    document.getElementById('review-q-text').innerText = currentReviewData.q;
    document.getElementById('review-badge').innerText = `${currentReviewData.wrongCount}íšŒ í‹€ë¦¼`;
    document.getElementById('review-ox-btns').style.display = 'flex';
    document.getElementById('btn-review-next').style.display = 'none';
    document.getElementById('review-feedback').innerText = "";
    document.getElementById('review-desc').style.display = 'none';
}
function submitReview(choice) {
    if(!currentReviewData) return;
    const realAns = currentReviewData.a.trim().toUpperCase();
    const fb = document.getElementById('review-feedback');
    if (choice === realAns) {
        playSound('correct'); fb.style.color = "#2979FF"; fb.innerText = "ì •ë‹µ!";
    } else {
        playSound('wrong'); fb.style.color = "#D32F2F"; fb.innerText = `ë•¡! ì •ë‹µ: ${realAns}`;
        currentReviewData.wrongCount++; updateWordStats(currentReviewData);
    }
    if (currentReviewData.desc) {
        const d = document.getElementById('review-desc'); d.style.display = 'block'; d.innerText = currentReviewData.desc;
    }
    document.getElementById('review-ox-btns').style.display = 'none';
    document.getElementById('btn-review-next').style.display = 'block';
}

// ì—‘ì…€ ë° ë°ì´í„° ê´€ë¦¬
function toggleExcel() { const el = document.getElementById('excel-area'); el.style.display = el.style.display==='none'?'block':'none'; }
function escapeHtml(t) { if(!t)return t; return t.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }
function addTextWord() {
    const q = document.getElementById('new-q').value.trim();
    const d = document.getElementById('new-desc').value.trim();
    const radios = document.getElementsByName('new-a-radio');
    let a = 'O'; for(let r of radios) if(r.checked) a = r.value;
    if (!q) return showToast("ë¬¸ì œ ì…ë ¥ í•„ìš”", 'error');
    saveToDB({ type:'text', q:escapeHtml(q), a:a, desc:escapeHtml(d), lv:0, nextTurn:0, wrongCount:0 });
    document.getElementById('new-q').value = ""; document.getElementById('new-desc').value = "";
}
function parseExcel() {
    const v = document.getElementById('excel-input').value.trim();
    if(!v) return showToast("ë‚´ìš© ì—†ìŒ", 'error');
    const lines = v.split(/\r?\n/).filter(l=>l.trim()!=="");
    let c = 0; const tx = db.transaction(['vocab'], 'readwrite'); const s = tx.objectStore('vocab');
    lines.forEach(l => {
        let p = l.split('\t'); if(p.length<2) p = l.split(/ {2,}/);
        if(p.length>=2) {
            let a = p[1].trim().toUpperCase(); if(a==='0')a='X'; if(a==='1')a='O';
            if(p[0] && (a==='O'||a==='X')) {
                s.add({ type:'text', q:escapeHtml(p[0].trim()), a:a, desc:escapeHtml(p[2]?p[2].trim():""), lv:0, nextTurn:0, wrongCount:0 });
                c++;
            }
        }
    });
    tx.oncomplete = () => { showToast(`${c}ê°œ ë“±ë¡ë¨`, 'success'); document.getElementById('excel-input').value=""; toggleExcel(); loadVocabulary(); };
}
function saveToDB(d) { const tx=db.transaction(['vocab'],'readwrite'); tx.objectStore('vocab').add(d); tx.oncomplete=()=>{showToast("ë“±ë¡ ì™„ë£Œ"); loadVocabulary();}; }
function renderWordList() {
    const l = document.getElementById('word-list'); l.innerHTML = "";
    if(vocabulary.length===0) { l.innerHTML="<p style='text-align:center;color:#999;padding:10px;'>ë°ì´í„° ì—†ìŒ</p>"; return; }
    vocabulary.forEach(v => {
        const d = document.createElement('div');
        d.style = "background:#FAFAFA; padding:8px; border-bottom:1px solid #eee; display:flex; gap:5px; align-items:center;";
        d.innerHTML = `<input type="checkbox" class="word-check" data-id="${v.id}">
            <div style="flex:1; font-size:0.9rem;">
                <b style="color:${v.a==='O'?'#2979FF':'#D32F2F'}">[${v.a}]</b> ${v.q}
            </div>`;
        l.appendChild(d);
    });
}
function deleteSelected() {
    const chk = document.querySelectorAll('.word-check:checked');
    if(chk.length===0) return showToast("ì„ íƒ í•­ëª© ì—†ìŒ");
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const tx = db.transaction(['vocab'], 'readwrite'); const s = tx.objectStore('vocab');
    chk.forEach(c => s.delete(Number(c.dataset.id)));
    tx.oncomplete = () => { showToast("ì‚­ì œ ì™„ë£Œ"); loadVocabulary(); };
}
function selectAll() { const chk = document.querySelectorAll('.word-check'); const all = Array.from(chk).every(c=>c.checked); chk.forEach(c=>c.checked=!all); }
function exportJSON() {
    if(vocabulary.length===0) return showToast("ë°ì´í„° ì—†ìŒ");
    const blob = new Blob([JSON.stringify(vocabulary)], {type: "application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `quiz_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
}
function handleJsonFile(e) {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        try {
            const d = JSON.parse(ev.target.result);
            if(!Array.isArray(d)) throw new Error();
            if(!confirm("ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const tx = db.transaction(['vocab'], 'readwrite'); const s = tx.objectStore('vocab');
            d.forEach(i => { const n={...i}; delete n.id; if(!n.lv)n.lv=0; if(!n.nextTurn)n.nextTurn=0; if(!n.wrongCount)n.wrongCount=0; s.add(n); });
            tx.oncomplete = () => { showToast("ë³µêµ¬ ì™„ë£Œ"); loadVocabulary(); };
        } catch(err) { showToast("íŒŒì¼ ì˜¤ë¥˜", 'error'); }
    };
    r.readAsText(f); e.target.value = "";
}
</script>
</body>
</html>
