<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° ìš©ì‚¬: íƒ€ì„ì–´íƒ RPG</title>
<style>
/* --- [1. ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
:root { --p: #2e7d32; --s: #66bb6a; --bg: #f1f8e9; --text: #1b5e20; --danger: #e53935; --gold: #fdd835; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; touch-action: manipulation; }
body { font-family: -apple-system, 'Pretendard', sans-serif; background: var(--bg); color: var(--text); width: 100vw; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
button { cursor: pointer; font-family: inherit; }
input, textarea { user-select: text; -webkit-user-select: text; }

/* --- [2. ê³µí†µ UI] --- */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--bg); position: relative; }
.active { display: flex; }
.menu-btn { width: 100%; padding: 14px; margin: 5px 0; border: none; border-radius: 12px; color: #fff; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
.menu-btn:active { transform: scale(0.98); }
.btn-game { background: var(--p); }
.btn-manage { background: #795548; }
.btn-blue { background: #1976d2; }
.small-btn { padding: 6px 12px; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-size: 0.8rem; color: #555; font-weight: bold; }

/* ëª¨ë‹¬/íŒì—… */
.toast { position: fixed; bottom: 20%; left: 50%; transform: translate(-50%, 20px); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; }
.toast.show { opacity: 1; transform: translate(-50%, 0); }
#img-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; overflow:auto; }
#img-modal img { margin: auto; display: block; max-width: 100%; transition: transform 0.2s; transform-origin: center center; }

/* ìë¥´ê¸° ëª¨ë‹¬ */
#crop-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; display:none; flex-direction:column; z-index:9500; }
#crop-area { flex:1; position:relative; overflow:hidden; background:#222; touch-action:none; display:flex; justify-content:center; align-items:center; }
#crop-canvas { max-width:100%; max-height:100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

/* --- [3. ê²Œì„ í™”ë©´: ì±„íŒ…ì•± ë ˆì´ì•„ì›ƒ] --- */
#area-battle { height: 25%; flex-shrink: 0; position: relative; background: linear-gradient(to bottom, #81c784, #a5d6a7); overflow: hidden; display: flex; flex-direction: column; align-items: center; border-bottom: 4px solid var(--text); }

.stage-info-bar { width: 100%; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); color: #fff; font-weight: bold; font-size: 0.9rem; z-index: 10; }
.time-bar-bg { width: 50%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden; }
.time-bar-fill { height: 100%; width: 100%; background: #fff; transition: width 0.1s linear; }

.battle-field { flex: 1; width: 100%; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 15% 10px 15%; position: relative; }
.sprite { font-size: 3rem; position: relative; transition: transform 0.1s; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
.sprite.hero { transform: scaleX(-1); }
.sprite.hit { animation: shake 0.2s; filter: brightness(2) sepia(1) hue-rotate(-50deg); }
.sprite.attack { animation: lunge 0.15s; }

.hp-bar-box { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 50px; height: 5px; background: #333; border-radius: 3px; overflow: hidden; }
.hp-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.2s; }
.dmg-text { position: absolute; font-weight: 900; color: #fff; font-size: 1.2rem; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 20; white-space: nowrap; text-shadow: -1px -1px 0 #000; }

#area-stat { height: 30px; flex-shrink: 0; background: #263238; color: #fff; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 0.8rem; border-bottom: 1px solid #444; }
.stat-val { font-weight: bold; font-family: monospace; color: var(--s); }
.buff-badge { background: var(--danger); color: #fff; border-radius: 4px; padding: 1px 4px; font-size: 0.6rem; animation: pulse 1s infinite; display: none; }

#area-quiz { flex: 1; display: flex; flex-direction: column; background: #fff; overflow: hidden; position: relative; }
#quiz-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; }
#q-image-container { width: 100%; margin-bottom: 10px; display: none; text-align: center; }
#q-image { max-width: 100%; max-height: 250px; border-radius: 8px; border: 1px solid #ddd; cursor: zoom-in; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
#q-text { font-size: 1.1rem; font-weight: bold; text-align: center; margin-bottom: 10px; line-height: 1.5; width: 100%; white-space: pre-wrap; color: #333; }
#q-feedback { font-weight: bold; margin: 10px 0; min-height: 20px; text-align: center; }

#explanation-area { width: 100%; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 10px; margin-top: 10px; display: none; text-align: left; font-size: 0.95rem; line-height: 1.4; }
#ex-img-view { max-width: 100%; border-radius: 5px; margin-top: 5px; cursor: zoom-in; }

#quiz-input-bar { flex-shrink: 0; padding: 10px; background: #f9f9f9; border-top: 1px solid #ddd; display: flex; gap: 8px; align-items: center; }
#q-input { flex: 1; padding: 12px; font-size: 1.1rem; border: 2px solid #ccc; border-radius: 20px; outline: none; transition: 0.2s; }
#q-input:focus { border-color: var(--p); background: #fff; }
#btn-submit { padding: 0 20px; height: 48px; background: var(--p); color: #fff; border: none; border-radius: 20px; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
#btn-submit:active { transform: scale(0.95); }

#area-menu { height: 50px; flex-shrink: 0; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }

/* --- [4. ê´€ë¦¬ í™”ë©´] --- */
#screen-manage { padding: 15px; overflow-y: auto; }
.add-box { display:none; background:#fff; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd; }
textarea { width:100%; border-radius:5px; border:1px solid #ccc; padding:8px; margin-bottom:5px; font-family:inherit; resize:none; }
.ex-box { border-top: 1px dashed #ccc; margin-top: 10px; padding-top: 10px; }

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-3px)} 50%{transform:translateX(3px)} 75%{transform:translateX(-3px)} 100%{transform:translateX(0)} }
@keyframes lunge { 0%{transform:scaleX(-1) translateX(0)} 50%{transform:scaleX(-1) translateX(10px)} 100%{transform:scaleX(-1) translateX(0)} }
@keyframes floatUp { 0%{opacity:1; transform:translate(-50%,0) scale(1)} 100%{opacity:0; transform:translate(-50%,-30px) scale(1.2)} }
@keyframes pulse { 0%{opacity:1} 50%{opacity:0.6} 100%{opacity:1} }
</style>
</head>
<body>

<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;font-weight:bold;flex-direction:column;">
    <div style="font-size:2rem;margin-bottom:10px;">âš”ï¸</div>
    <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>
<div id="toast-container"></div>

<div id="img-modal" onclick="closeImgModal()">
    <div style="position:absolute; top:20px; right:20px; color:#fff; font-size:2rem; cursor:pointer;">&times;</div>
    <img id="img-modal-target" onclick="event.stopPropagation(); toggleZoom(this)">
    <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:#fff; font-size:0.9rem;">í´ë¦­í•˜ì—¬ í™•ëŒ€/ì¶•ì†Œ</div>
</div>

<div id="crop-modal">
    <div style="padding:10px 15px; display:flex; justify-content:space-between; align-items:center; background:#111; color:#fff;">
        <h3 style="margin:0; font-size:1rem;">ì´ë¯¸ì§€ ìë¥´ê¸°</h3>
        <div>
            <button class="small-btn" style="background:#333; color:#fff; border:none;" onclick="rotateImage()">ğŸ”„ íšŒì „</button>
            <button class="small-btn" style="background:#d32f2f; color:#fff; border:none;" onclick="closeCrop()">ì·¨ì†Œ</button>
            <button class="small-btn" style="background:#388e3c; color:#fff; border:none; font-weight:bold;" onclick="applyCrop()">ì™„ë£Œ</button>
        </div>
    </div>
    <div id="crop-area">
        <canvas id="crop-canvas"></canvas>
    </div>
    <div style="padding:10px; background:#111; text-align:center; color:#aaa; font-size:0.8rem;">
        ì˜ì—­ ë“œë˜ê·¸ë¡œ ì´ë™ / ìš°ì¸¡ í•˜ë‹¨ í•¸ë“¤(â¬œ)ë¡œ í¬ê¸° ì¡°ì ˆ
    </div>
</div>

<div id="screen-home" class="screen active">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <div style="font-size:5rem;margin-bottom:10px;">ğŸ›¡ï¸</div>
        <h1 style="color:var(--text);margin-bottom:5px;">ì•”ê¸° ìš©ì‚¬</h1>
        <p style="color:#666;font-size:0.9rem;">íƒ€ì„ì–´íƒ RPG</p>
        <div style="background:#fff;padding:15px;border-radius:15px;margin:30px 0;width:80%;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>ìµœê³  ìŠ¤í…Œì´ì§€</span><b style="color:var(--p)" id="home-best-stage">1-1</b></div>
            <div style="display:flex;justify-content:space-between;"><span>ì´ ì²˜ì¹˜</span><b id="home-kill-count">0</b></div>
        </div>
    </div>
    <div style="padding:20px;">
        <button id="btn-start" class="menu-btn btn-game" onclick="startGame()" disabled>ê²Œì„ ì‹œì‘ (ë¡œë”© ì¤‘)</button>
        <button class="menu-btn btn-manage" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <div id="area-battle">
        <div class="stage-info-bar"><span id="stage-display">STAGE 1-1</span><div class="time-bar-bg"><div id="time-bar" class="time-bar-fill"></div></div></div>
        <div class="battle-field">
            <div style="position:relative; text-align:center;"><div class="hp-bar-box"><div id="hero-hp" class="hp-fill"></div></div><div class="sprite hero">âš”ï¸</div></div>
            <div style="position:relative; text-align:center;"><div class="hp-bar-box"><div id="mob-hp" class="hp-fill"></div></div><div id="mob-sprite" class="sprite">ğŸ‘¾</div></div>
        </div>
    </div>
    <div id="area-stat">
        <div class="stat-box">ATK <span id="stat-atk" class="stat-val">10</span></div>
        <div class="stat-box">CRIT <span id="stat-crit" class="stat-val">0%</span></div>
        <div class="stat-box">CDMG <span id="stat-cdmg" class="stat-val">150%</span></div>
        <div class="stat-box" style="position:relative">ASPD <span id="stat-aspd" class="stat-val">1.0</span><div class="buff-badge" id="buff-badge">FAST!</div></div>
    </div>
    <div id="area-quiz">
        <div id="quiz-content">
            <div id="q-image-container"><img id="q-image" onclick="openImgModal(this.src)"></div>
            <div id="q-text">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="q-feedback"></div>
            <div id="explanation-area">
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">ğŸ’¡ í•´ì„¤</div>
                <div id="ex-text-view"></div>
                <img id="ex-img-view" onclick="openImgModal(this.src)">
            </div>
            <div style="height:20px;"></div>
        </div>
        <div id="quiz-input-bar">
            <input type="text" id="q-input" placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off">
            <button id="btn-submit" onclick="submitAnswer()">ì…ë ¥</button>
        </div>
    </div>
    <div id="area-menu">
        <button class="small-btn" onclick="stopGame()">ğŸ  í™ˆ</button>
        <span style="font-size:0.8rem; color:#888;">ìë™ ì „íˆ¬ ì¤‘</span>
        <button class="small-btn" onclick="toggleSound()">ğŸ”Š ì†Œë¦¬</button>
    </div>
</div>

<div id="screen-manage" class="screen">
    <h2 style="margin-bottom:15px; color:var(--text);">ë¬¸ì œ ê´€ë¦¬</h2>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="menu-btn btn-game" style="flex:1; margin:0; padding:10px;" onclick="toggleAddMode('text')">í…ìŠ¤íŠ¸ ë¬¸ì œ</button>
        <button class="menu-btn btn-blue" style="flex:1; margin:0; padding:10px;" onclick="toggleAddMode('image')">ì´ë¯¸ì§€ ë¬¸ì œ</button>
    </div>
    
    <div id="add-text-box" class="add-box">
        <textarea id="new-q" placeholder="ë¬¸ì œ ë‚´ìš©" style="height:60px;"></textarea>
        <textarea id="new-a" placeholder="ì •ë‹µ (O/X ë“±)" style="height:40px;"></textarea>
        <div class="ex-box">
            <textarea id="new-ex-text" placeholder="(ì„ íƒ) í•´ì„¤/ì„¤ëª… ì…ë ¥" style="height:50px; background:#f9f9f9;"></textarea>
        </div>
        <button onclick="addTextWord()" class="menu-btn btn-game" style="padding:10px; margin-top:5px;">ë“±ë¡</button>
        
        <button class="menu-btn" style="background:var(--excel); margin-top:10px; padding:10px; font-size:0.9rem;" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</button>
        <div id="excel-area" style="display:none; margin-top:5px; padding:10px; background:#f1f8e9; border-radius:5px;">
            <p style="font-size:0.8rem; color:#555; margin-bottom:5px;">ë³µì‚¬ í˜•ì‹: <b>[ë¬¸ì œ] [ì •ë‹µ] [í•´ì„¤]</b> (íƒ­ìœ¼ë¡œ êµ¬ë¶„)</p>
            <textarea id="excel-input" placeholder="ì‚¬ê³¼    Apple    ì‚¬ê³¼ëŠ” ë§›ìˆë‹¤" style="height:80px;"></textarea>
            <button class="menu-btn btn-game" style="margin-top:5px; padding:8px; font-size:0.9rem;" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button>
        </div>
    </div>

    <div id="add-image-box" class="add-box">
        <button onclick="document.getElementById('camera-input').click()" class="menu-btn btn-blue" style="padding:10px; margin-bottom:5px;">ğŸ“· ì‚¬ì§„ ì´¬ì˜/ì„ íƒ</button>
        <img id="preview-q-img" style="max-width:100%; display:none; margin-bottom:5px; border:2px solid var(--p);">
        
        <textarea id="img-q-text" placeholder="(ì„ íƒ) ë¬¸ì œ í…ìŠ¤íŠ¸" style="height:40px;"></textarea>
        <textarea id="img-a" placeholder="ì •ë‹µ" style="height:40px;"></textarea>
        
        <div class="ex-box">
            <button onclick="document.getElementById('ex-img-input').click()" class="small-btn" style="margin-bottom:5px;">ğŸ“· í•´ì„¤ ì´ë¯¸ì§€ ì¶”ê°€</button>
            <img id="preview-ex-img" style="max-width:100%; max-height:100px; display:none; margin-bottom:5px;">
            <textarea id="img-ex-text" placeholder="(ì„ íƒ) í•´ì„¤ í…ìŠ¤íŠ¸" style="height:50px; background:#f9f9f9;"></textarea>
        </div>

        <button onclick="addImageWord()" class="menu-btn btn-game" style="padding:10px; margin-top:5px;">ë“±ë¡</button>
    </div>

    <div style="margin-top:20px; display:flex; gap:5px; flex-wrap:wrap;">
        <button class="small-btn" style="flex:1; background:#eee;" onclick="toggleSelectAll()">ì „ì²´ ì„ íƒ</button>
        <button class="small-btn" style="flex:1; color:var(--danger); border-color:var(--danger);" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
    </div>
    <div style="margin-top:5px; display:flex; gap:5px;">
        <button class="small-btn" style="flex:1;" onclick="exportJSON()">ë°±ì—…</button>
        <button class="small-btn" style="flex:1;" onclick="document.getElementById('json-input').click()">ë³µêµ¬</button>
    </div>

    <div id="word-list" style="margin-top:15px; border-top:1px solid #eee;"></div>
    <div style="height:50px;"></div> <button class="menu-btn" style="background:#8d6e63; margin-top:10px;" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
</div>

<input type="file" id="camera-input" style="display:none" accept="image/*" onchange="handleImageFile(event, 'q')">
<input type="file" id="ex-img-input" style="display:none" accept="image/*" onchange="handleImageFile(event, 'ex')">
<input type="file" id="json-input" style="display:none" accept=".json" onchange="handleJsonFile(event)">
<script>
// ============================================================
// [1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •]
// ============================================================
const DB_NAME = "HeroQuizDB";
const DB_VERSION = 2; // DB êµ¬ì¡° ë³€ê²½(í•´ì„¤ ì¶”ê°€)ì„ ìœ„í•´ ë²„ì „ ì—…
let db;
let vocabulary = [];

// í”Œë ˆì´ì–´ ìŠ¤íƒ¯
let player = {
    atk: 10,       // ê³µê²©ë ¥
    crit: 0,       // ì¹˜ëª…íƒ€ìœ¨ (%)
    cdmg: 150,     // ì¹˜ëª…íƒ€ í”¼í•´ (%)
    aspd: 1.0,     // ê³µê²© ì†ë„
    maxStage: 1,   // ìµœê³  ìŠ¤í…Œì´ì§€
    killCount: 0   // ì´ ì²˜ì¹˜ ìˆ˜
};

// ê²Œì„ ìƒíƒœ
let gameRunning = false;
let lastTime = 0;
let attackTimer = 0;
let combo = 0;
let comboTimer = null;
let currentStage = 1;
let subStage = 0; 
let stageTimeLeft = 30;
let mob = { hp: 100, maxHp: 100, isBoss: false };

// ì´ë¯¸ì§€ ìë¥´ê¸° ê´€ë ¨ ë³€ìˆ˜
let cropImg = new Image();
let cropCtx = null;
// ìë¥´ê¸° ì˜ì—­ (x,y,w,h) + ë“œë˜ê·¸ ìƒíƒœ
let cropRect = { x: 0, y: 0, w: 200, h: 200 };
let isDragging = false;
let dragMode = null; // 'move' ë˜ëŠ” 'resize'
let lastX = 0, lastY = 0;
let rotationAngle = 0;

// ì´ë¯¸ì§€ ì²˜ë¦¬ìš© ì„ì‹œ ë³€ìˆ˜
let currentTargetType = 'q'; // 'q'(ë¬¸ì œ) ë˜ëŠ” 'ex'(í•´ì„¤)

// ì˜¤ë””ì˜¤
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioCtx();
let isSoundOn = true;

// ============================================================
// [2. ë°ì´í„°ë² ì´ìŠ¤ & ì €ì¥ì†Œ]
// ============================================================
window.onload = function() {
    initDB();
    loadPlayerStats();
    
    // ìë¥´ê¸° ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    const cvs = document.getElementById('crop-canvas');
    if(cvs) cropCtx = cvs.getContext('2d');
};

function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    
    req.onupgradeneeded = function(e) {
        db = e.target.result;
        // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ë³´ì¡´í•˜ë©´ì„œ êµ¬ì¡° ì—…ê·¸ë ˆì´ë“œ
        if (!db.objectStoreNames.contains('vocab')) {
            db.createObjectStore('vocab', { keyPath: 'id', autoIncrement: true });
        }
    };
    
    req.onsuccess = function(e) {
        db = e.target.result;
        loadVocabulary();
    };
    
    req.onerror = function(e) {
        console.error("DB Error", e);
        alert("ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    };
}

function loadVocabulary() {
    const tx = db.transaction(['vocab'], 'readonly');
    const store = tx.objectStore('vocab');
    store.getAll().onsuccess = function(e) {
        vocabulary = e.target.result || [];
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-start').innerText = "ê²Œì„ ì‹œì‘";
        updateHomeUI();
        
        // ê´€ë¦¬ í™”ë©´ì´ë©´ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
        if(document.getElementById('screen-manage').classList.contains('active')) {
            renderWordList();
        }
    };
}

function savePlayerStats() {
    localStorage.setItem('hero_stats_v5', JSON.stringify(player));
}
function loadPlayerStats() {
    const data = localStorage.getItem('hero_stats_v5');
    if (data) player = { ...player, ...JSON.parse(data) };
    updateHomeUI();
}

function updateHomeUI() {
    document.getElementById('home-best-stage').innerText = `1-${player.maxStage}`;
    document.getElementById('home-kill-count').innerText = player.killCount;
}

// ============================================================
// [3. ì „íˆ¬ ë©”ì¸ ë¡œì§]
// ============================================================
function startGame() {
    if (vocabulary.length < 1) return showToast("ë¬¸ì œê°€ ìµœì†Œ 1ê°œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤!", 'error');
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    document.getElementById('screen-home').classList.remove('active');
    document.getElementById('screen-game').classList.add('active');
    
    currentStage = player.maxStage; 
    startStage(currentStage);
    gameRunning = true;
    lastTime = performance.now();
    nextQuiz(); 
    requestAnimationFrame(gameLoop);
}

function stopGame() {
    gameRunning = false;
    savePlayerStats();
    document.getElementById('screen-game').classList.remove('active');
    document.getElementById('screen-home').classList.add('active');
    updateHomeUI();
}

function startStage(stg) {
    currentStage = stg;
    if(currentStage < 1) currentStage = 1;
    subStage = 0;
    stageTimeLeft = 30;
    spawnMob();
    updateStatUI();
}

function spawnMob() {
    const isBoss = subStage === 2;
    let hp = Math.floor(200 * Math.pow(1.07, currentStage - 1));
    if (isBoss) hp *= 3; 

    mob = { hp: hp, maxHp: hp, isBoss: isBoss };
    
    const sprite = document.getElementById('mob-sprite');
    sprite.innerText = isBoss ? "ğŸ‘¹" : "ğŸ‘¾";
    sprite.style.transform = isBoss ? "scale(1.5)" : "scale(1)";
    document.getElementById('stage-display').innerText = `STAGE 1-${currentStage} (${subStage+1}/3)`;
    updateMobHpUI();
}

function gameLoop(timestamp) {
    if (!gameRunning) return;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    stageTimeLeft -= dt;
    if (stageTimeLeft <= 0) handleStageFail();
    
    const pct = (stageTimeLeft / 30) * 100;
    const bar = document.getElementById('time-bar');
    bar.style.width = pct + "%";
    bar.style.background = stageTimeLeft < 5 ? "#e53935" : "#fff";

    let currentAspd = player.aspd + (Math.min(2.5, combo * 0.1));
    if (combo === 0) currentAspd = player.aspd;
    document.getElementById('stat-aspd').innerText = currentAspd.toFixed(1);

    attackTimer += dt;
    if (attackTimer >= (1 / currentAspd)) {
        attackTimer = 0;
        heroAttack();
    }
    requestAnimationFrame(gameLoop);
}

function handleStageFail() {
    showToast("ì‹œê°„ ì´ˆê³¼! ìŠ¤í…Œì´ì§€ ê°•ë“±", 'error');
    playSound('fail');
    currentStage--;
    if (currentStage < 1) currentStage = 1;
    startStage(currentStage);
}

function heroAttack() {
    const hero = document.querySelector('.sprite.hero');
    hero.classList.remove('attack');
    void hero.offsetWidth;
    hero.classList.add('attack');
    playSound('attack');

    const result = calculateInfiniteCrit(player.atk, player.crit, 0);
    
    mob.hp -= result.damage;
    if (mob.hp < 0) mob.hp = 0;
    
    createDamageText(result.damage, result.tier);
    updateMobHpUI();
    
    const mobEl = document.getElementById('mob-sprite');
    mobEl.classList.remove('hit');
    void mobEl.offsetWidth;
    mobEl.classList.add('hit');

    if (mob.hp <= 0) {
        player.killCount++;
        subStage++;
        if (subStage >= 3) {
            playSound('clear');
            player.maxStage = Math.max(player.maxStage, currentStage + 1);
            startStage(currentStage + 1);
        } else {
            spawnMob();
        }
    }
}

function calculateInfiniteCrit(dmg, critRate, tier) {
    let currentTierCrit = false;
    let chance = critRate - (tier * 100);
    
    if (chance >= 100) currentTierCrit = true; 
    else if (Math.random() * 100 < chance) currentTierCrit = true;

    if (currentTierCrit) {
        let multiplier = player.cdmg / 100; 
        if (chance >= 100) return calculateInfiniteCrit(Math.floor(dmg * multiplier), critRate, tier + 1);
        else return { damage: Math.floor(dmg * multiplier), tier: tier + 1 };
    } else {
        return { damage: dmg, tier: tier };
    }
}

function createDamageText(dmg, tier) {
    const field = document.querySelector('.battle-field');
    const el = document.createElement('div');
    el.className = 'dmg-text';
    el.innerText = dmg.toLocaleString();
    if (tier === 0) { el.style.color = "#fff"; el.style.fontSize = "1.2rem"; } 
    else if (tier === 1) { el.classList.add('crit-text'); el.innerText += "!"; } 
    else { el.classList.add('jin-crit-text'); el.innerText += ` (ì§„${tier-1})!`; }

    const x = 50 + (Math.random() * 40 - 20);
    const y = 40 + (Math.random() * 20 - 10);
    el.style.left = x + "%";
    el.style.top = y + "%";
    field.appendChild(el);
    setTimeout(() => el.remove(), 800);
}

function updateMobHpUI() {
    document.getElementById('mob-hp').style.width = ((mob.hp / mob.maxHp) * 100) + "%";
}

function updateStatUI() {
    document.getElementById('stat-atk').innerText = player.atk;
    document.getElementById('stat-crit').innerText = player.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = player.cdmg + "%";
    if(player.crit >= 100) document.getElementById('stat-crit').style.color = "#e040fb"; 
    else document.getElementById('stat-crit').style.color = "#66bb6a";
}
/* [íŒŒíŠ¸ 2 ë] */
// ============================================================
// [4. í€´ì¦ˆ ì‹œìŠ¤í…œ (ë¬¸ì œ í‘œì‹œ ë° ì •ë‹µ ì²˜ë¦¬)]
// ============================================================
let currentQuizData = null;

function nextQuiz() {
    if (vocabulary.length === 0) {
        document.getElementById('q-text').innerText = "ë¬¸ì œ ê´€ë¦¬ ë©”ë‰´ì—ì„œ\në¬¸ì œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!";
        return;
    }

    // ëœë¤ ë¬¸ì œ ì„ íƒ
    const idx = Math.floor(Math.random() * vocabulary.length);
    currentQuizData = vocabulary[idx];

    // UI ì´ˆê¸°í™”
    const qText = document.getElementById('q-text');
    const qImgContainer = document.getElementById('q-image-container');
    const qImg = document.getElementById('q-image');
    
    // ì´ì „ í•´ì„¤/í”¼ë“œë°± ìˆ¨ê¸°ê¸°
    document.getElementById('q-feedback').innerText = "";
    document.getElementById('explanation-area').style.display = 'none';
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
    document.getElementById('q-input').value = "";
    document.getElementById('q-input').focus();

    // ë¬¸ì œ íƒ€ì…ì— ë”°ë¥¸ í‘œì‹œ
    if (currentQuizData.type === 'image') {
        qImgContainer.style.display = 'block';
        qImg.src = currentQuizData.q;
        qText.innerText = currentQuizData.qText || ""; 
    } else {
        qImgContainer.style.display = 'none';
        qText.innerText = currentQuizData.q;
    }
}

function submitAnswer() {
    if (!currentQuizData) return;
    const input = document.getElementById('q-input').value.trim();
    if (!input) return;

    // ì •ë‹µ ì²´í¬ (ê³µë°±ì œê±°, ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
    const userAns = input.replace(/\s/g, "").toUpperCase();
    const realAns = currentQuizData.a.replace(/\s/g, "").toUpperCase();
    
    let isCorrect = (userAns === realAns);

    if (isCorrect) handleCorrect();
    else handleWrong();
}

// ì—”í„°í‚¤ ì…ë ¥ ì§€ì›
document.getElementById('q-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') submitAnswer();
});

function handleCorrect() {
    playSound('correct');
    
    // 1. ì½¤ë³´ ë° ë²„í”„
    combo++;
    updateBuffUI();
    resetComboTimer();

    // 2. ìŠ¤íƒ¯ ë³´ìƒ
    const rand = Math.random();
    let msg = "";
    if (rand < 0.4) { player.atk += 2; msg = "âš”ï¸ATK +2"; }
    else if (rand < 0.7) { player.crit += 0.1; msg = "âš¡CRIT +0.1%"; }
    else { player.cdmg += 1; msg = "ğŸ’ªCDMG +1%"; }
    
    updateStatUI();
    savePlayerStats();
    heroAttack(); 

    // 3. í”¼ë“œë°± ë° í•´ì„¤ í‘œì‹œ
    const fb = document.getElementById('q-feedback');
    fb.style.color = "var(--p)";
    fb.innerText = `ì •ë‹µ! (${msg})`;
    
    showExplanation();

    // í•´ì„¤ì´ ìˆìœ¼ë©´ ì¡°ê¸ˆ ë” ê¸¸ê²Œ ë³´ì—¬ì¤Œ (1.5ì´ˆ), ì—†ìœ¼ë©´ 0.6ì´ˆ ë’¤ ë„˜ì–´ê°
    const delay = (currentQuizData.exText || currentQuizData.exImg) ? 1500 : 600;
    setTimeout(nextQuiz, delay); 
}

function handleWrong() {
    playSound('wrong');
    
    combo = 0;
    updateBuffUI();
    if (comboTimer) clearTimeout(comboTimer);

    const fb = document.getElementById('q-feedback');
    fb.style.color = "var(--danger)";
    fb.innerText = `ì˜¤ë‹µ! ì •ë‹µ: ${currentQuizData.a}`;
    
    document.getElementById('q-input').value = "";
    
    showExplanation();
    
    // í‹€ë ¸ì„ ë• í•´ì„¤ ì½ì„ ì‹œê°„ 3ì´ˆ ë¶€ì—¬ (í•´ì„¤ ì—†ìœ¼ë©´ 1.5ì´ˆ)
    const delay = (currentQuizData.exText || currentQuizData.exImg) ? 3000 : 1500;
    setTimeout(nextQuiz, delay);
}

function showExplanation() {
    // í•´ì„¤ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
    if (!currentQuizData.exText && !currentQuizData.exImg) return;

    const exArea = document.getElementById('explanation-area');
    const exText = document.getElementById('ex-text-view');
    const exImg = document.getElementById('ex-img-view');

    exArea.style.display = 'block';
    
    // í…ìŠ¤íŠ¸ í•´ì„¤
    if (currentQuizData.exText) {
        exText.style.display = 'block';
        exText.innerText = currentQuizData.exText;
    } else {
        exText.style.display = 'none';
    }

    // ì´ë¯¸ì§€ í•´ì„¤
    if (currentQuizData.exImg) {
        exImg.style.display = 'block';
        exImg.src = currentQuizData.exImg;
    } else {
        exImg.style.display = 'none';
    }
    
    // í•´ì„¤ì´ ë³´ì¼ ë•Œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë ¤ì¤Œ
    const content = document.getElementById('quiz-content');
    content.scrollTop = content.scrollHeight;
}

function updateBuffUI() {
    const badge = document.getElementById('buff-badge');
    if (combo > 0) {
        badge.style.display = 'inline-block';
        const bonus = Math.min(1.5, combo * 0.1); 
        const totalSpd = (player.aspd + bonus).toFixed(1);
        badge.innerText = `${combo}ì½¤ë³´ (${totalSpd})`;
    } else {
        badge.style.display = 'none';
    }
}

function resetComboTimer() {
    if (comboTimer) clearTimeout(comboTimer);
    comboTimer = setTimeout(() => {
        if (combo > 0) {
            showToast("ì½¤ë³´ ì¢…ë£Œ", 'info');
            combo = 0;
            updateBuffUI();
        }
    }, 5000); 
}

// ============================================================
// [5. ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ]
// ============================================================
function toggleSound() {
    isSoundOn = !isSoundOn;
    showToast(isSoundOn ? "ì‚¬ìš´ë“œ ON" : "ì‚¬ìš´ë“œ OFF");
}

const snd = {
    attack: (t) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(150, t);
        o.frequency.exponentialRampToValueAtTime(0.01, t + 0.1);
        g.gain.setValueAtTime(0.1, t);
        g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t + 0.1);
    },
    correct: (t) => {
        const g = audioCtx.createGain();
        g.gain.value = 0.1;
        g.connect(audioCtx.destination);
        [523.25, 659.25, 783.99].forEach((f, i) => { 
            const o = audioCtx.createOscillator();
            o.type = 'sine'; o.frequency.value = f;
            o.connect(g); o.start(t + i * 0.05); o.stop(t + i * 0.05 + 0.1);
        });
    },
    wrong: (t) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(100, t);
        o.frequency.linearRampToValueAtTime(50, t + 0.3);
        g.gain.setValueAtTime(0.1, t);
        g.gain.linearRampToValueAtTime(0, t + 0.3);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t + 0.3);
    },
    fail: (t) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'triangle';
        o.frequency.setValueAtTime(300, t);
        o.frequency.linearRampToValueAtTime(100, t + 1);
        g.gain.value = 0.1;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t + 1);
    }
};

function playSound(type) {
    if (!isSoundOn || !audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const t = audioCtx.currentTime;
    if (snd[type]) snd[type](t);
}
/* [íŒŒíŠ¸ 3 ë] */
// ============================================================
// [6. ê´€ë¦¬ì ê¸°ëŠ¥: ë©”ë‰´ ë° ì—‘ì…€]
// ============================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    
    // ê´€ë¦¬ í™”ë©´ ì§„ì… ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    if (id === 'manage') renderWordList();
}

function toggleAddMode(mode) {
    document.getElementById('add-text-box').style.display = mode === 'text' ? 'block' : 'none';
    document.getElementById('add-image-box').style.display = mode === 'image' ? 'block' : 'none';
}

function toggleExcel() {
    const el = document.getElementById('excel-area');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/[&<>"']/g, function(m) {
        return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m];
    });
}

function addTextWord() {
    const q = document.getElementById('new-q').value.trim();
    const a = document.getElementById('new-a').value.trim();
    const exText = document.getElementById('new-ex-text').value.trim(); // í•´ì„¤
    
    if (!q || !a) return showToast("ë¬¸ì œì™€ ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”", 'error');
    
    // í•´ì„¤(exText)ë„ ê°™ì´ ì €ì¥
    saveToDB({ type: 'text', q: escapeHtml(q), a: escapeHtml(a), exText: escapeHtml(exText) });
    
    document.getElementById('new-q').value = "";
    document.getElementById('new-a').value = "";
    document.getElementById('new-ex-text').value = "";
}

function parseExcel() {
    const val = document.getElementById('excel-input').value.trim();
    if (!val) return showToast("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", 'error');
    
    const lines = val.split('\n');
    let count = 0;
    
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');

    lines.forEach(line => {
        // [ë¬¸ì œ] [ì •ë‹µ] [í•´ì„¤(ì˜µì…˜)]
        const parts = line.split('\t');
        if (parts.length >= 2) {
            const q = parts[0].trim();
            const a = parts[1].trim();
            const ex = parts[2] ? parts[2].trim() : "";
            
            if (q && a) {
                store.add({ 
                    type: 'text', 
                    q: escapeHtml(q), 
                    a: escapeHtml(a),
                    exText: escapeHtml(ex) // í•´ì„¤ ì €ì¥
                });
                count++;
            }
        }
    });

    tx.oncomplete = function() {
        showToast(`${count}ê°œ ì¼ê´„ ë“±ë¡ ì™„ë£Œ!`, 'success');
        document.getElementById('excel-input').value = "";
        toggleExcel();
        renderWordList(); // ì¦‰ì‹œ ëª©ë¡ ê°±ì‹ 
    };
}

// ============================================================
// [7. ì´ë¯¸ì§€ ìë¥´ê¸° ì‹œìŠ¤í…œ (í¬ê¸° ì¡°ì ˆ í¬í•¨)]
// ============================================================
function handleImageFile(e, type) {
    const file = e.target.files[0];
    if (!file) return;
    
    currentTargetType = type; // 'q' ë˜ëŠ” 'ex'
    
    const reader = new FileReader();
    reader.onload = function(ev) {
        cropImg.src = ev.target.result;
    };
    reader.readAsDataURL(file);

    cropImg.onload = function() {
        startCropping();
    };
    e.target.value = ""; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
}

function startCropping() {
    document.getElementById('crop-modal').style.display = 'flex';
    rotationAngle = 0;
    
    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
    const container = document.getElementById('crop-area');
    const canvas = document.getElementById('crop-canvas');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    // ì´ˆê¸° ìë¥´ê¸° ì˜ì—­ (ì¤‘ì•™, 200x200)
    const cw = canvas.width;
    const ch = canvas.height;
    cropRect = { 
        x: (cw - 200) / 2, 
        y: (ch - 200) / 2, 
        w: 200, 
        h: 200 
    };
    
    drawCropCanvas();
}

function drawCropCanvas() {
    if (!cropCtx) return;
    const canvas = document.getElementById('crop-canvas');
    const cw = canvas.width;
    const ch = canvas.height;
    
    // ë°°ê²½ (ì–´ë‘¡ê²Œ)
    cropCtx.fillStyle = "#222";
    cropCtx.fillRect(0, 0, cw, ch);

    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (íšŒì „ ì ìš©)
    cropCtx.save();
    cropCtx.translate(cw/2, ch/2);
    cropCtx.rotate(rotationAngle * Math.PI / 180);
    
    // ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ìº”ë²„ìŠ¤ì— ë§ì¶¤ (ì—¬ë°± ë‚¨ê¹€)
    const scale = Math.min(cw / cropImg.width, ch / cropImg.height) * 0.9; 
    const dw = cropImg.width * scale;
    const dh = cropImg.height * scale;
    
    cropCtx.drawImage(cropImg, -dw/2, -dh/2, dw, dh);
    cropCtx.restore();

    // ìë¥´ê¸° ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
    cropCtx.strokeStyle = "#fff";
    cropCtx.lineWidth = 2;
    cropCtx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);

    // í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ê·¸ë¦¬ê¸° (ìš°ì¸¡ í•˜ë‹¨)
    const handleSize = 20;
    cropCtx.fillStyle = "#fff";
    cropCtx.fillRect(cropRect.x + cropRect.w - handleSize/2, cropRect.y + cropRect.h - handleSize/2, handleSize, handleSize);

    // ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ (ì„ íƒ ì˜ì—­ ë°–)
    cropCtx.fillStyle = "rgba(0,0,0,0.6)";
    // ìƒ, í•˜, ì¢Œ, ìš°
    cropCtx.fillRect(0, 0, cw, cropRect.y);
    cropCtx.fillRect(0, cropRect.y + cropRect.h, cw, ch - (cropRect.y + cropRect.h));
    cropCtx.fillRect(0, cropRect.y, cropRect.x, cropRect.h);
    cropCtx.fillRect(cropRect.x + cropRect.w, cropRect.y, cw - (cropRect.x + cropRect.w), cropRect.h);
}

// í„°ì¹˜/ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ì´ë™ ë° í¬ê¸° ì¡°ì ˆ)
const cropCanvas = document.getElementById('crop-canvas');
cropCanvas.addEventListener('touchstart', dragStart, {passive: false});
cropCanvas.addEventListener('touchmove', dragMove, {passive: false});
cropCanvas.addEventListener('touchend', dragEnd);
cropCanvas.addEventListener('mousedown', dragStart);
cropCanvas.addEventListener('mousemove', dragMove);
cropCanvas.addEventListener('mouseup', dragEnd);

function dragStart(e) {
    e.preventDefault();
    isDragging = true;
    const pt = getPoint(e);
    lastX = pt.x;
    lastY = pt.y;
    
    // í•¸ë“¤ í„°ì¹˜ íŒì • (ìš°ì¸¡ í•˜ë‹¨)
    const hx = cropRect.x + cropRect.w;
    const hy = cropRect.y + cropRect.h;
    const dist = Math.sqrt(Math.pow(pt.x - hx, 2) + Math.pow(pt.y - hy, 2));

    if (dist < 30) {
        dragMode = 'resize';
    } else if (pt.x > cropRect.x && pt.x < hx && pt.y > cropRect.y && pt.y < hy) {
        dragMode = 'move';
    } else {
        isDragging = false;
        dragMode = null;
    }
}

function dragMove(e) {
    if (!isDragging) return;
    e.preventDefault();
    const pt = getPoint(e);
    const dx = pt.x - lastX;
    const dy = pt.y - lastY;
    
    if (dragMode === 'move') {
        cropRect.x += dx;
        cropRect.y += dy;
    } else if (dragMode === 'resize') {
        cropRect.w += dx;
        cropRect.h += dy;
        // ìµœì†Œ í¬ê¸° ì œí•œ (50px)
        if (cropRect.w < 50) cropRect.w = 50;
        if (cropRect.h < 50) cropRect.h = 50;
    }
    
    lastX = pt.x;
    lastY = pt.y;
    drawCropCanvas();
}

function dragEnd() {
    isDragging = false;
    dragMode = null;
}

function getPoint(e) {
    if (e.touches) {
        const rect = e.target.getBoundingClientRect();
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    }
    return { x: e.offsetX, y: e.offsetY };
}

function rotateImage() {
    rotationAngle = (rotationAngle + 90) % 360;
    drawCropCanvas();
}

function closeCrop() {
    document.getElementById('crop-modal').style.display = 'none';
}

function applyCrop() {
    // í˜„ì¬ ìº”ë²„ìŠ¤ í™”ë©´ ê·¸ëŒ€ë¡œ ìº¡ì²˜ (WYSIWYG)
    const canvas = document.getElementById('crop-canvas');
    const tempCvs = document.createElement('canvas');
    tempCvs.width = cropRect.w;
    tempCvs.height = cropRect.h;
    const tCtx = tempCvs.getContext('2d');
    
    tCtx.drawImage(canvas, 
        cropRect.x, cropRect.y, cropRect.w, cropRect.h, 
        0, 0, cropRect.w, cropRect.h
    );
    
    // ê³ í™”ì§ˆ ì €ì¥ì„ ìœ„í•´ 0.9 í’ˆì§ˆ ì‚¬ìš©
    const finalBase64 = tempCvs.toDataURL('image/jpeg', 0.9);
    
    // ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
    let previewId = currentTargetType === 'q' ? 'preview-q-img' : 'preview-ex-img';
    const preview = document.getElementById(previewId);
    preview.src = finalBase64;
    preview.style.display = 'block';
    preview.dataset.base64 = finalBase64;
    
    closeCrop();
}

function addImageWord() {
    const qPreview = document.getElementById('preview-q-img');
    const qBase64 = qPreview.dataset.base64;
    
    // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
    if (!qBase64) return showToast("ë©”ì¸ ì´ë¯¸ì§€(ë¬¸ì œ)ê°€ í•„ìš”í•©ë‹ˆë‹¤", 'error');
    
    const qText = document.getElementById('img-q-text').value.trim();
    const a = document.getElementById('img-a').value.trim();
    const exText = document.getElementById('img-ex-text').value.trim();
    
    // í•´ì„¤ ì´ë¯¸ì§€ (ì„ íƒ)
    const exPreview = document.getElementById('preview-ex-img');
    const exBase64 = exPreview.dataset.base64 || null;

    if (!a) return showToast("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”", 'error');

    saveToDB({ 
        type: 'image', 
        q: qBase64, 
        qText: escapeHtml(qText), 
        a: escapeHtml(a),
        exText: escapeHtml(exText),
        exImg: exBase64
    });
    
    // ì´ˆê¸°í™”
    qPreview.src = ""; qPreview.style.display = "none"; delete qPreview.dataset.base64;
    exPreview.src = ""; exPreview.style.display = "none"; delete exPreview.dataset.base64;
    
    document.getElementById('img-q-text').value = "";
    document.getElementById('img-a').value = "";
    document.getElementById('img-ex-text').value = "";
}

// ì¤Œ ëª¨ë‹¬ ê´€ë ¨
function openImgModal(src) {
    if (!src) return;
    const modal = document.getElementById('img-modal');
    const img = document.getElementById('img-modal-target');
    img.src = src;
    img.style.transform = "scale(1)"; // ì¤Œ ì´ˆê¸°í™”
    modal.style.display = "flex";
}
function closeImgModal() {
    document.getElementById('img-modal').style.display = "none";
}
function toggleZoom(img) {
    if (img.style.transform === "scale(2)") {
        img.style.transform = "scale(1)";
        img.style.cursor = "zoom-in";
    } else {
        img.style.transform = "scale(2)";
        img.style.cursor = "zoom-out";
    }
}
/* [íŒŒíŠ¸ 4 ë] */
// ============================================================
// [8. ë°ì´í„°ë² ì´ìŠ¤ ë³´ì¡° ë° ìœ í‹¸ë¦¬í‹°]
// ============================================================
function saveToDB(item) {
    const tx = db.transaction(['vocab'], 'readwrite');
    tx.objectStore('vocab').add(item);
    tx.oncomplete = function() {
        // í…ìŠ¤íŠ¸ ë¬¸ì œ ë“±ë¡ ì‹œì—” í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        if(item.type === 'text') showToast("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
        else if(item.type === 'image') showToast("ì´ë¯¸ì§€ ë¬¸ì œ ë“±ë¡ ì™„ë£Œ!", 'success');
        
        loadVocabulary(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        // (ì£¼ì˜) loadVocabulary ì•ˆì—ì„œ renderWordListë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    }
}

function renderWordList() {
    const listEl = document.getElementById('word-list');
    listEl.innerHTML = "";

    if (vocabulary.length === 0) {
        listEl.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
    }

    // ìµœì‹ ìˆœ ì •ë ¬
    const sorted = [...vocabulary].reverse();
    
    sorted.forEach(item => {
        const div = document.createElement('div');
        div.style.background = "#fff";
        div.style.borderBottom = "1px solid #eee";
        div.style.padding = "10px";
        div.style.display = "flex";
        div.style.alignItems = "center";
        
        let content = "";
        let badge = "";
        
        // í•´ì„¤ ì—¬ë¶€ í‘œì‹œ
        if (item.exText || item.exImg) {
            badge = `<span style="font-size:0.7rem; background:#e8f5e9; color:#2e7d32; padding:2px 4px; border-radius:4px; margin-left:5px;">í•´ì„¤ë³´ìœ </span>`;
        }

        if (item.type === 'image') {
            content = `<div style="flex:1;">
                <span style="font-size:0.8rem; color:#1976d2;">[ì´ë¯¸ì§€]</span>${badge}
                <div style="font-weight:bold; margin-top:2px;">${item.qText ? item.qText : '(ì´ë¯¸ì§€ ë¬¸ì œ)'}</div>
                <div style="font-size:0.8rem; color:#555;">ë‹µ: ${item.a}</div>
            </div>
            <img src="${item.q}" style="width:50px; height:50px; object-fit:cover; border-radius:4px; margin-right:10px; border:1px solid #eee;">`;
        } else {
            content = `<div style="flex:1;">
                <div style="font-weight:bold;">${item.q} ${badge}</div>
                <div style="font-size:0.8rem; color:#555;">ë‹µ: ${item.a}</div>
            </div>`;
        }

        div.innerHTML = `<input type="checkbox" class="del-chk" value="${item.id}" style="margin-right:15px; transform:scale(1.3);">${content}`;
        listEl.appendChild(div);
    });
}

// ì „ì²´ ì„ íƒ / í•´ì œ í† ê¸€ ê¸°ëŠ¥
function toggleSelectAll() {
    const chks = document.querySelectorAll('.del-chk');
    if (chks.length === 0) return;
    
    // í•˜ë‚˜ë¼ë„ ì²´í¬ ì•ˆ ëœ ê²Œ ìˆìœ¼ë©´ -> ëª¨ë‘ ì²´í¬
    // ëª¨ë‘ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ -> ëª¨ë‘ í•´ì œ
    const allChecked = Array.from(chks).every(c => c.checked);
    
    chks.forEach(chk => {
        chk.checked = !allChecked;
    });
}

function deleteSelected() {
    const chks = document.querySelectorAll('.del-chk:checked');
    if (chks.length === 0) return showToast("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.", 'error');
    if (!confirm(`${chks.length}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    
    chks.forEach(chk => store.delete(Number(chk.value)));

    tx.oncomplete = function() {
        showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
        loadVocabulary(); // ëª©ë¡ ê°±ì‹  í¬í•¨ë¨
    };
}

function exportJSON() {
    if (vocabulary.length === 0) return showToast("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", 'error');
    
    // ë°ì´í„° ìš©ëŸ‰ì´ í´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì••ì¶• ëŒ€ì‹  ê·¸ëŒ€ë¡œ ë‚´ë³´ëƒ„ (Base64 ì´ë¯¸ì§€ í¬í•¨)
    const dataStr = JSON.stringify(vocabulary, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `quiz_backup_v5_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function handleJsonFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data)) throw new Error("ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
            
            if (!confirm(`ì´ ${data.length}ê°œì˜ ë¬¸ì œë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë°ì´í„° ë’¤ì— ì¶”ê°€ë©ë‹ˆë‹¤)`)) return;

            const tx = db.transaction(['vocab'], 'readwrite');
            const store = tx.objectStore('vocab');
            let count = 0;
            
            data.forEach(item => {
                // ê¸°ì¡´ ID ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ID ì‚­ì œ í›„ ì¬ë“±ë¡
                delete item.id; 
                store.add(item);
                count++;
            });
            
            tx.oncomplete = function() {
                showToast(`${count}ê°œ ë³µêµ¬ ì™„ë£Œ!`, 'success');
                loadVocabulary();
            };
        } catch (err) { 
            alert("íŒŒì¼ ì˜¤ë¥˜: " + err); 
        }
    };
    reader.readAsText(file);
    e.target.value = "";
}

function showToast(msg, type='normal') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = 'toast show';
    el.innerText = msg;
    if (type === 'error') el.style.background = "rgba(229, 57, 53, 0.9)";
    else if (type === 'success') el.style.background = "rgba(67, 160, 71, 0.9)";
    container.appendChild(el);
    setTimeout(() => { 
        el.classList.remove('show'); 
        setTimeout(() => el.remove(), 300); 
    }, 2000);
}
</script>
</body>
</html>
