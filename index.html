<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>ì•”ê¸° ìš©ì‚¬: Final OX</title>
<style>
/* --- [1. ê¸°ë³¸ ì„¤ì • & ì•± ë ˆì´ì•„ì›ƒ] --- */
:root { --p: #2e7d32; --s: #66bb6a; --bg: #f1f8e9; --text: #1b5e20; --danger: #e53935; --gold: #fdd835; --excel: #1b5e20; --o-color: #1976d2; --x-color: #d32f2f; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; touch-action: manipulation; }
body { 
    font-family: -apple-system, 'Pretendard', sans-serif; 
    background: var(--bg); color: var(--text); 
    width: 100vw; height: 100dvh; 
    overflow: hidden; display: flex; flex-direction: column; 
}
button { cursor: pointer; font-family: inherit; }
textarea { user-select: text; -webkit-user-select: text; font-size: 16px !important; }

/* --- [2. ê³µí†µ UI] --- */
.screen { display: none; width: 100%; height: 100%; flex-direction: column; background: var(--bg); position: relative; }
.active { display: flex; }
.menu-btn { width: 100%; padding: 12px; margin: 4px 0; border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.menu-btn:active { transform: scale(0.98); }
.btn-game { background: var(--p); }
.btn-manage { background: #795548; }
.btn-review { background: #ef6c00; } /* ì˜¤ë‹µë…¸íŠ¸ ì£¼í™©ìƒ‰ */
.toast { position: fixed; bottom: 40%; left: 50%; transform: translate(-50%, 20px); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; text-align: center; }
.toast.show { opacity: 1; transform: translate(-50%, 0); }

/* --- [3. ê²Œì„ í™”ë©´ UI] --- */
#area-battle { 
    flex: 0 0 25%; flex-shrink: 0;
    position: relative; 
    background: linear-gradient(to bottom, #81c784, #a5d6a7); 
    overflow: hidden; 
    display: flex; flex-direction: column; 
    border-bottom: 2px solid var(--text); 
}
.stage-info-bar { 
    width: 100%; padding: 5px 10px; 
    display: flex; justify-content: space-between; align-items: center; 
    background: rgba(0,0,0,0.15); color: #fff; 
    font-weight: bold; font-size: 0.9rem; z-index: 10; 
}
.timer-container { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-left: 10px; }
.time-bar-bg { width: 100%; max-width: 150px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
.time-bar-fill { height: 100%; width: 100%; background: #fff; transition: width 0.1s linear; }
#time-text { font-family: monospace; font-size: 0.9rem; width: 45px; text-align: right; }

.battle-field { 
    flex: 1; width: 100%; 
    display: flex; justify-content: space-between; align-items: flex-end; 
    padding: 0 12% 10px 12%; position: relative; 
}
.sprite { font-size: 3rem; position: relative; transition: transform 0.1s; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2)); }
.sprite.hero { transform: scaleX(-1); }
.sprite.hit { animation: shake 0.2s; filter: brightness(2) sepia(1) hue-rotate(-50deg); }
.sprite.attack { animation: lunge 0.15s; }
.hp-bar-box { 
    position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
    width: 60px; height: 5px; background: #333; border-radius: 3px; overflow: hidden; 
}
.hp-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.2s; }
.dmg-text { position: absolute; font-weight: 900; color: #fff; font-size: 1.2rem; text-shadow: -1px -1px 0 #000; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 20; white-space: nowrap;}
.crit-text { color: var(--gold) !important; font-size: 1.5rem !important; }

#area-stat { 
    flex: 0 0 6%; flex-shrink: 0;
    background: #263238; color: #fff; 
    display: flex; align-items: center; justify-content: space-around; 
    padding: 0 5px; font-size: 0.75rem; border-bottom: 1px solid #444; 
}
.stat-box { text-align: center; display:flex; flex-direction:column; justify-content:center; }
.stat-label { color: #cfd8dc; font-size: 0.65rem; margin-bottom: 0px; }
.stat-val { font-weight: bold; font-family: monospace; font-size: 0.85rem; color: var(--s); }
.buff-badge { position:absolute; top:-15px; left:50%; transform:translateX(-50%); background: var(--danger); color: #fff; border-radius: 3px; padding: 1px 4px; font-size: 0.6rem; animation: pulse 1s infinite; display: none; }

/* (4) í€´ì¦ˆ í™”ë©´ (ê²Œì„ìš©) */
#area-quiz { 
    flex: 1; padding: 10px 15px; background: #fff; 
    display: flex; flex-direction: column; align-items: center; overflow: hidden; 
}
#q-text-container {
    flex: 1; width: 100%; margin-bottom: 10px; overflow-y: auto; 
    display: flex; align-items: center; justify-content: center;
    border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa;
}
#q-text { font-size: 1.1rem; font-weight: bold; text-align: center; line-height: 1.5; width: 100%; white-space: pre-wrap; }
.ox-btn-group { flex: 0 0 auto; width: 100%; display: flex; gap: 15px; margin-bottom: 10px; height: 80px; }
.btn-ox {
    flex: 1; border: none; border-radius: 12px;
    font-size: 2.5rem; font-weight: 900; color: #fff;
    box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s;
}
.btn-ox:active { transform: translateY(4px); box-shadow: none; }
.btn-o { background: var(--o-color); }
.btn-x { background: var(--x-color); }
#q-desc-display { 
    display: none; flex: 0.8; width: 100%; 
    padding: 10px; background: #e3f2fd; border-radius: 8px; 
    color: #1565c0; font-size: 0.95rem; line-height: 1.4;
    overflow-y: auto; white-space: pre-wrap; text-align: left; margin-bottom: 10px;
}
#q-feedback { flex: 0 0 auto; height: 24px; margin-bottom: 5px; font-size: 1rem; font-weight: bold; text-align: center; }
#btn-next-quiz { 
    display: none; width: 100%; flex: 0 0 auto; padding: 12px; 
    background: #FF9800; color: #fff; border: none; border-radius: 10px; 
    font-weight: bold; font-size: 1.1rem; animation: pulse 1s infinite;
}
#area-menu { 
    flex: 0 0 8%; min-height: 40px; flex-shrink: 0;
    background: #f5f5f5; border-top: 1px solid #ddd; 
    display: flex; align-items: center; justify-content: space-between; padding: 0 10px; 
}
.small-btn { padding: 6px 10px; background: #fff; border: 1px solid #ccc; border-radius: 6px; font-size: 0.75rem; color: #555; }

/* (5) ì˜¤ë‹µ ë…¸íŠ¸ í™”ë©´ (ë³„ë„ íŒì—… ìŠ¤íƒ€ì¼) */
#screen-review {
    background: #fff5e6; /* ì—°í•œ ì£¼í™© ë°°ê²½ */
    padding: 20px;
}
.review-header {
    flex: 0 0 auto; margin-bottom: 20px; text-align: center;
}
.review-card {
    flex: 1; display: flex; flex-direction: column; 
    background: #fff; border-radius: 15px; padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;
    overflow: hidden;
}
.wrong-badge {
    background: var(--danger); color: #fff; padding: 4px 8px; border-radius: 4px;
    font-size: 0.8rem; font-weight: bold; display: inline-block; margin-bottom: 10px;
}

/* ê´€ë¦¬ì ëª¨ë‹¬ ë“± */
#excel-area { display:none; width:100%; background:#f9f9f9; padding:10px; border:2px dashed var(--excel); border-radius:10px; margin-bottom:10px; }

@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }
@keyframes lunge { 0%{transform:scaleX(-1) translateX(0)} 50%{transform:scaleX(-1) translateX(15px)} 100%{transform:scaleX(-1) translateX(0)} }
@keyframes floatUp { 0%{opacity:1; transform:translate(-50%,0) scale(1)} 100%{opacity:0; transform:translate(-50%,-50px) scale(1.2)} }
@keyframes pulse { 0%{opacity:1} 50%{opacity:0.6} 100%{opacity:1} }
</style>
</head>
<body>
<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;font-weight:bold;flex-direction:column;">
    <div style="font-size:2rem;margin-bottom:10px;">âš”ï¸</div>
    <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>
<div id="toast-container"></div>

<div id="screen-home" class="screen active">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <div style="font-size:4rem;margin-bottom:10px;">ğŸ›¡ï¸</div>
        <h1 style="color:var(--text);margin-bottom:5px;">ì•”ê¸° ìš©ì‚¬</h1>
        <p style="color:#666;font-size:0.9rem;">Final OX</p>
        <div style="background:#fff;padding:15px;border-radius:15px;margin:30px 0;width:80%;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>ìµœê³  ìŠ¤í…Œì´ì§€</span><b style="color:var(--p)" id="home-best-stage">1-1</b></div>
            <div style="display:flex;justify-content:space-between;"><span>ì´ ì²˜ì¹˜</span><b id="home-kill-count">0</b></div>
        </div>
    </div>
    <div style="padding:20px;">
        <button id="btn-start" class="menu-btn btn-game" onclick="startGame()" disabled>ê²Œì„ ì‹œì‘ (ë¡œë”© ì¤‘)</button>
        <button class="menu-btn btn-review" onclick="startReview()">ğŸ“• ì˜¤ë‹µ ë…¸íŠ¸</button>
        <button class="menu-btn btn-manage" onclick="showScreen('manage')">ë¬¸ì œ ê´€ë¦¬</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <div id="area-battle">
        <div class="stage-info-bar">
            <span id="stage-display">STAGE 1-1</span>
            <div class="timer-container">
                <div class="time-bar-bg"><div id="time-bar" class="time-bar-fill"></div></div>
                <div id="time-text">30.0s</div>
            </div>
        </div>
        <div class="battle-field">
            <div style="position:relative; text-align:center;"><div class="hp-bar-box"><div id="hero-hp" class="hp-fill"></div></div><div class="sprite hero">âš”ï¸</div></div>
            <div style="position:relative; text-align:center;"><div class="hp-bar-box"><div id="mob-hp" class="hp-fill"></div></div><div id="mob-sprite" class="sprite">ğŸ‘¾</div></div>
        </div>
    </div>
    <div id="area-stat">
        <div class="stat-box"><div class="stat-label">ê³µê²©ë ¥</div><div id="stat-atk" class="stat-val">10</div></div>
        <div class="stat-box"><div class="stat-label">ì¹˜ëª…íƒ€</div><div id="stat-crit" class="stat-val">0%</div></div>
        <div class="stat-box"><div class="stat-label">ì¹˜ëª…í”¼í•´</div><div id="stat-cdmg" class="stat-val">150%</div></div>
        <div class="stat-box" style="position:relative"><div class="buff-badge" id="buff-badge">FAST!</div><div class="stat-label">ê³µê²©ì†ë„</div><div id="stat-aspd" class="stat-val">1.0</div></div>
    </div>
    <div id="area-quiz">
        <div id="q-text-container">
            <div id="q-text">ë¡œë”© ì¤‘...</div>
        </div>
        
        <div class="ox-btn-group" id="ox-buttons">
            <button class="btn-ox btn-o" onclick="submitAnswer('O')">O</button>
            <button class="btn-ox btn-x" onclick="submitAnswer('X')">X</button>
        </div>

        <div id="q-feedback"></div>
        <div id="q-desc-display"></div> 
        
        <button id="btn-next-quiz" onclick="manualNextQuiz()">ğŸ”œ ë‹¤ìŒ ë¬¸ì œ</button>
    </div>
    <div id="area-menu">
        <button class="small-btn" onclick="stopGame()">ğŸ  í™ˆ</button><span style="font-size:0.7rem; color:#888;">ìë™ ê³µê²© ì¤‘</span><button class="small-btn" onclick="toggleSound()">ğŸ”Š ì†Œë¦¬</button>
    </div>
</div>

<div id="screen-review" class="screen">
    <div class="review-header">
        <h2 style="color:#ef6c00;">ğŸ“• ì˜¤ë‹µ ë…¸íŠ¸</h2>
        <p id="review-status" style="font-size:0.9rem; color:#666;">ì´ 0ê°œì˜ ì˜¤ë‹µ ë¬¸ì œ</p>
    </div>
    
    <div class="review-card">
        <div style="text-align:center; margin-bottom:10px;">
            <span id="review-badge" class="wrong-badge">3ë²ˆ í‹€ë¦¼</span>
        </div>
        <div id="review-q-container" style="flex:1; overflow-y:auto; display:flex; align-items:center; justify-content:center; margin-bottom:15px; border-bottom:1px solid #eee;">
            <div id="review-q-text" style="font-size:1.1rem; font-weight:bold; text-align:center; line-height:1.5;">ë¬¸ì œ</div>
        </div>
        
        <div id="review-ox-btns" class="ox-btn-group" style="height:60px;">
            <button class="btn-ox btn-o" onclick="submitReview('O')">O</button>
            <button class="btn-ox btn-x" onclick="submitReview('X')">X</button>
        </div>
        
        <div id="review-feedback" style="text-align:center; font-weight:bold; height:24px; margin-bottom:5px;"></div>
        
        <div id="review-desc" style="display:none; height:100px; overflow-y:auto; background:#f5f5f5; padding:10px; border-radius:8px; font-size:0.9rem; margin-bottom:10px;">
        </div>

        <button id="btn-review-next" onclick="nextReview()" style="display:none; width:100%; padding:10px; background:#ef6c00; color:#fff; border:none; border-radius:8px; font-weight:bold;">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>

    <button class="menu-btn" style="background:#8d6e63;" onclick="stopReview()">ğŸ  í™ˆìœ¼ë¡œ ë‚˜ê°€ê¸°</button>
</div>

<div id="screen-manage" class="screen" style="padding:15px; overflow-y:auto;">
    <h2 style="margin-bottom:10px; color:var(--text); font-size:1.2rem;">ë¬¸ì œ ê´€ë¦¬ (OX ì „ìš©)</h2>
    
    <div id="add-text-box" class="add-box" style="background:#fff; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;">
        <textarea id="new-q" placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (íŒë¡€ ë“± ê¸´ í…ìŠ¤íŠ¸ ê°€ëŠ¥)" style="width:100%; height:60px; margin-bottom:5px; border-radius:5px; border:1px solid #ddd; padding:5px;"></textarea>
        
        <div style="display:flex; gap:10px; margin-bottom:5px; align-items:center;">
            <span style="font-weight:bold;">ì •ë‹µ:</span>
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="radio" name="new-a-radio" value="O" checked> <span style="color:var(--o-color); font-weight:bold;">O</span></label>
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="radio" name="new-a-radio" value="X"> <span style="color:var(--x-color); font-weight:bold;">X</span></label>
        </div>

        <textarea id="new-desc" placeholder="í•´ì„¤/ì„¤ëª… (ì„ íƒì‚¬í•­)" style="width:100%; height:50px; margin-bottom:5px; border-radius:5px; border:1px solid #ddd; padding:5px;"></textarea>
        
        <button onclick="addTextWord()" class="menu-btn btn-game" style="padding:8px; font-size:0.9rem;">ë“±ë¡</button>
        
        <button class="menu-btn" style="background:var(--excel); margin-top:10px; padding:8px; font-size:0.8rem;" onclick="toggleExcel()">ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°</button>
        <div id="excel-area">
            <p style="font-size:0.75rem; color:#555; margin-bottom:5px;">[ë¬¸ì œ] [O/X] [í•´ì„¤] ìˆœì„œë¡œ ë³µì‚¬ (íƒ­ ê°„ê²©)</p>
            <textarea id="excel-input" placeholder="ì‚¬ê³¼ëŠ” ê³¼ì¼ì´ë‹¤   O   ë‹¹ì—°í•˜ë‹¤" style="width:100%; height:60px; padding:5px; font-size:0.8rem;"></textarea>
            <button class="menu-btn btn-game" style="margin-top:5px; padding:6px; font-size:0.8rem;" onclick="parseExcel()">ì¼ê´„ ë“±ë¡</button>
        </div>
    </div>

    <div id="word-list" style="margin-top:15px;"></div>
    <div style="margin-top:15px; display:flex; gap:5px;">
        <button class="small-btn" style="flex:1;" onclick="selectAll()">âœ… ì „ì²´</button>
        <button class="small-btn" style="flex:1; color:var(--danger); border-color:var(--danger);" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>
    <div style="margin-top:5px; display:flex; gap:5px;">
        <button class="small-btn" style="flex:1;" onclick="exportJSON()">ğŸ’¾ ë°±ì—…</button>
        <button class="small-btn" style="flex:1;" onclick="document.getElementById('json-input').click()">ğŸ“‚ ë³µêµ¬</button>
    </div>
    <button class="menu-btn" style="background:#8d6e63; margin-top:20px;" onclick="showScreen('home')">ëŒì•„ê°€ê¸°</button>
</div>
<input type="file" id="json-input" style="display:none" accept=".json" onchange="handleJsonFile(event)">
<script>
// ============================================================
// [1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •]
// ============================================================
const DB_NAME = "HeroQuizDB_Final";
const DB_VERSION = 1; 
let db;
let vocabulary = [];

// í”Œë ˆì´ì–´ ìŠ¤íƒ¯ (ê¸°ë³¸ê°’)
let player = {
    atk: 10,       // ê³µê²©ë ¥
    crit: 0,       // ì¹˜ëª…íƒ€ìœ¨ (%)
    cdmg: 150,     // ì¹˜ëª…íƒ€ í”¼í•´ (%)
    aspd: 1.0,     // ê³µê²© ì†ë„
    maxStage: 1,   // ìµœê³  ìŠ¤í…Œì´ì§€
    killCount: 0,  // ì´ ì²˜ì¹˜ ìˆ˜
    totalTurns: 0  // [NEW] ì•± ì „ì²´ ëˆ„ì  í„´ (ë¼ì´íŠ¸ë„ˆ ì‹œìŠ¤í…œìš© ì‹œê°„ì¶•)
};

// ê²Œì„ ìƒíƒœ ë³€ìˆ˜
let gameRunning = false;
let lastTime = 0;
let attackTimer = 0;
let combo = 0;
let comboTimer = null; 
let currentStage = 1;
let subStage = 0; 
let stageTimeLeft = 30;
let mob = { hp: 100, maxHp: 100, isBoss: false };

// ì˜¤ë‹µ ë…¸íŠ¸ ê´€ë ¨ ë³€ìˆ˜
let reviewQueue = []; // ì˜¤ë‹µ ë¬¸ì œë“¤ë§Œ ëª¨ì•„ë‘˜ í
let currentReviewData = null;

// ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioCtx();
let isSoundOn = true;

// ============================================================
// [2. ë°ì´í„°ë² ì´ìŠ¤ & ì €ì¥ì†Œ ì´ˆê¸°í™”]
// ============================================================
window.onload = function() {
    initDB();
    loadPlayerStats();
    
    setTimeout(() => {
        const loader = document.getElementById('loading-overlay');
        if(loader && loader.style.display !== 'none') {
            loader.style.display = 'none';
            const btnStart = document.getElementById('btn-start');
            if(btnStart) {
                btnStart.disabled = false;
                btnStart.innerText = "ê²Œì„ ì‹œì‘";
            }
        }
    }, 2000);
};

function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = function(e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains('vocab')) {
            db.createObjectStore('vocab', { keyPath: 'id', autoIncrement: true });
        }
    };
    req.onsuccess = function(e) {
        db = e.target.result;
        loadVocabulary();
    };
}

function loadVocabulary() {
    if(!db) return;
    const tx = db.transaction(['vocab'], 'readonly');
    const store = tx.objectStore('vocab');
    store.getAll().onsuccess = function(e) {
        vocabulary = e.target.result || [];
        
        // ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ (í•„ë“œ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¸íŒ…)
        vocabulary.forEach(v => {
            if (typeof v.wrongCount === 'undefined') v.wrongCount = 0; // í‹€ë¦° íšŸìˆ˜
            if (typeof v.lv === 'undefined') v.lv = 0;       // ìˆ™ë ¨ë„
            if (typeof v.nextTurn === 'undefined') v.nextTurn = 0; // ë‹¤ìŒì— ë“±ì¥í•  í„´(Global Turn ê¸°ì¤€)
        });

        updateHomeUI();
        if(document.getElementById('screen-manage').classList.contains('active')) {
            renderWordList();
        }
    };
}

function savePlayerStats() {
    localStorage.setItem('hero_stats_ox_final', JSON.stringify(player));
}
function loadPlayerStats() {
    const data = localStorage.getItem('hero_stats_ox_final');
    if (data) player = { ...player, ...JSON.parse(data) };
    if (typeof player.totalTurns === 'undefined') player.totalTurns = 0; // êµ¬ë²„ì „ í˜¸í™˜
    updateHomeUI();
}

function updateHomeUI() {
    document.getElementById('home-best-stage').innerText = `${player.maxStage}-1`; 
    document.getElementById('home-kill-count').innerText = player.killCount;
}

// ============================================================
// [3. ì˜¤ë‹µ ë…¸íŠ¸ ì‹œìŠ¤í…œ (ë³„ë„ í™”ë©´)]
// ============================================================
function startReview() {
    if (vocabulary.length === 0) return showToast("ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.", 'error');

    // 1. í•œë²ˆì´ë¼ë„ í‹€ë¦° ì ì´ ìˆëŠ”(wrongCount > 0) ë¬¸ì œ í•„í„°ë§
    reviewQueue = vocabulary.filter(v => v.wrongCount > 0);

    if (reviewQueue.length === 0) {
        return showToast("ì•„ì§ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! í›Œë¥­í•´ìš”!", 'success');
    }

    // 2. ë§ì´ í‹€ë¦° ìˆœì„œ(ë‚´ë¦¼ì°¨ìˆœ)ë¡œ ì •ë ¬
    reviewQueue.sort((a, b) => b.wrongCount - a.wrongCount);

    // 3. í™”ë©´ ì „í™˜
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-review').classList.add('active');
    
    document.getElementById('review-status').innerText = `ì´ ${reviewQueue.length}ê°œì˜ ì˜¤ë‹µ ë¬¸ì œ`;
    
    // ì²« ë¬¸ì œ ì‹œì‘
    nextReview();
}

function stopReview() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-home').classList.add('active');
    updateHomeUI();
}

// ============================================================
// [4. ì „íˆ¬ ë©”ì¸ ë¡œì§]
// ============================================================
function startGame() {
    if (vocabulary.length < 1) return showToast("ë¬¸ì œê°€ ìµœì†Œ 1ê°œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤!", 'error');
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    // ê²Œì„ ì‹œì‘ ì‹œ ë± ì¤€ë¹„ (Global Turn ì‹œìŠ¤í…œ ì ìš©)
    // Part 3ì— ìˆëŠ” í•¨ìˆ˜ì§€ë§Œ, í˜¸ì¶œ ìˆœì„œìƒ ë¬¸ì œ ì—†ìŒ
    prepareDeck(); 

    document.getElementById('screen-home').classList.remove('active');
    document.getElementById('screen-game').classList.add('active');
    currentStage = player.maxStage; 
    startStage(currentStage);
    gameRunning = true;
    lastTime = performance.now();
    
    nextQuiz(); // í€´ì¦ˆ ì‹œì‘
    requestAnimationFrame(gameLoop);
}

function stopGame() {
    gameRunning = false;
    if (comboTimer) clearTimeout(comboTimer);
    combo = 0;
    updateBuffUI();
    savePlayerStats();
    document.getElementById('screen-game').classList.remove('active');
    document.getElementById('screen-home').classList.add('active');
    updateHomeUI();
}

function startStage(stg) {
    currentStage = stg;
    subStage = 0;
    stageTimeLeft = 30;
    spawnMob();
    updateStatUI();
}

function spawnMob() {
    const isBoss = subStage === 2;
    let hp = Math.floor(200 * Math.pow(1.07, currentStage - 1));
    if (isBoss) hp *= 3; 
    mob = { hp: hp, maxHp: hp, isBoss: isBoss };
    const sprite = document.getElementById('mob-sprite');
    sprite.innerText = isBoss ? "ğŸ‘¹" : "ğŸ‘¾";
    sprite.style.transform = isBoss ? "scale(1.5)" : "scale(1)";
    document.getElementById('stage-display').innerText = `STAGE ${currentStage}-${subStage + 1}`;
    updateMobHpUI();
}

function gameLoop(timestamp) {
    if (!gameRunning) return;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    stageTimeLeft -= dt;
    if (stageTimeLeft <= 0) handleStageFail();
    
    const pct = (stageTimeLeft / 30) * 100;
    const bar = document.getElementById('time-bar');
    bar.style.width = pct + "%";
    bar.style.background = stageTimeLeft < 5 ? "#e53935" : "#fff";
    
    const timeText = document.getElementById('time-text');
    if(timeText) {
        timeText.innerText = Math.max(0, stageTimeLeft).toFixed(1) + "s";
        timeText.style.color = stageTimeLeft < 5 ? "#ff5252" : "#fff";
    }

    let totalAspd = player.aspd + (combo * 0.1);
    let currentAspd = Math.min(2.5, totalAspd);
    document.getElementById('stat-aspd').innerText = currentAspd.toFixed(1);

    attackTimer += dt;
    if (attackTimer >= (1 / currentAspd)) {
        attackTimer = 0;
        heroAttack();
    }
    requestAnimationFrame(gameLoop);
}

function handleStageFail() {
    showToast("ì‹œê°„ ì´ˆê³¼! ìŠ¤í…Œì´ì§€ ê°•ë“±", 'error');
    playSound('fail');
    if (comboTimer) clearTimeout(comboTimer);
    combo = 0;
    updateBuffUI();
    currentStage = Math.max(1, currentStage - 1);
    startStage(currentStage);
}

function heroAttack() {
    const hero = document.querySelector('.sprite.hero');
    hero.classList.remove('attack');
    void hero.offsetWidth;
    hero.classList.add('attack');
    playSound('attack');
    const result = calculateInfiniteCrit(player.atk, player.crit, 0);
    mob.hp = Math.max(0, mob.hp - result.damage);
    createDamageText(result.damage, result.tier);
    updateMobHpUI();
    const mobEl = document.getElementById('mob-sprite');
    mobEl.classList.remove('hit');
    void mobEl.offsetWidth;
    mobEl.classList.add('hit');
    if (mob.hp <= 0) {
        player.killCount++;
        subStage++;
        if (subStage >= 3) { 
            playSound('clear');
            player.maxStage = Math.max(player.maxStage, currentStage + 1);
            startStage(currentStage + 1);
        } else {
            spawnMob();
        }
    }
}

function calculateInfiniteCrit(dmg, critRate, tier) {
    let currentTierCrit = false;
    let chance = critRate - (tier * 100);
    if (chance >= 100 || Math.random() * 100 < chance) currentTierCrit = true;
    if (currentTierCrit) {
        let multiplier = player.cdmg / 100; 
        if (chance >= 100) return calculateInfiniteCrit(Math.floor(dmg * multiplier), critRate, tier + 1);
        else return { damage: Math.floor(dmg * multiplier), tier: tier + 1 };
    } else return { damage: dmg, tier: tier };
}

function createDamageText(dmg, tier) {
    const field = document.querySelector('.battle-field');
    const el = document.createElement('div');
    el.className = 'dmg-text';
    el.innerText = dmg.toLocaleString();
    if (tier === 1) el.classList.add('crit-text');
    else if (tier > 1) el.classList.add('jin-crit-text');
    const x = 50 + (Math.random() * 40 - 20);
    const y = 40 + (Math.random() * 20 - 10);
    el.style.left = x + "%"; el.style.top = y + "%";
    field.appendChild(el);
    setTimeout(() => el.remove(), 800);
}

function updateMobHpUI() {
    document.getElementById('mob-hp').style.width = ((mob.hp / mob.maxHp) * 100) + "%";
}

function updateStatUI() {
    document.getElementById('stat-atk').innerText = player.atk;
    document.getElementById('stat-crit').innerText = player.crit.toFixed(1) + "%";
    document.getElementById('stat-cdmg').innerText = player.cdmg + "%";
    document.getElementById('stat-crit').style.color = player.crit >= 100 ? "#e040fb" : "#66bb6a";
}
/* [íŒŒíŠ¸ 2ì—ì„œ ì´ì–´ì§] */
// ============================================================
// [5. í€´ì¦ˆ ì‹œìŠ¤í…œ (Global Turn ë¼ì´íŠ¸ë„ˆ ì‹œìŠ¤í…œ)]
// ============================================================
let currentQuizData = null;

// ê²Œì„ ì‹œì‘ ì‹œ, í˜¹ì€ ë¬¸ì œê°€ ë„˜ì–´ê°ˆ ë•Œ ë± ìƒíƒœ ì ê²€
function prepareDeck() {
    // 1. í˜„ì¬ í„´(totalTurns)ë³´ë‹¤ nextTurnì´ ì‘ê±°ë‚˜ ê°™ì€(ì¿¨íƒ€ì„ ì°¬) ë¬¸ì œ ì°¾ê¸°
    let eligible = vocabulary.filter(v => v.nextTurn <= player.totalTurns);

    // 2. ë§Œì•½ í’€ ë¬¸ì œê°€ í•˜ë‚˜ë„ ì—†ë‹¤ë©´? (ë¯¸ë˜ì˜ ë¬¸ì œ ì¤‘ ê°€ì¥ ë¹¨ë¦¬ ëŒì•„ì˜¤ëŠ” ê²ƒ ë•¡ê²¨ì˜´)
    if (eligible.length === 0 && vocabulary.length > 0) {
        vocabulary.sort((a, b) => a.nextTurn - b.nextTurn);
        eligible.push(vocabulary[0]);
    }
    
    return eligible;
}

function nextQuiz() {
    const deck = prepareDeck();
    if (deck.length === 0) {
        document.getElementById('q-text').innerText = "ë¬¸ì œ ê´€ë¦¬ ë©”ë‰´ì—ì„œ\në¬¸ì œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!";
        return;
    }

    // ë± ì•ˆì—ì„œ ê°€ì¤‘ì¹˜ ëœë¤ ì„ íƒ (ë ˆë²¨ì´ ë‚®ì„ìˆ˜ë¡ ìì£¼ ë“±ì¥)
    const weightedPool = [];
    deck.forEach(v => {
        const weight = Math.max(1, 6 - v.lv); // Lv0=6ì¥, Lv5=1ì¥
        for(let i=0; i<weight; i++) weightedPool.push(v);
    });

    const idx = Math.floor(Math.random() * weightedPool.length);
    currentQuizData = weightedPool[idx];

    // UI ì´ˆê¸°í™”
    document.getElementById('ox-buttons').style.display = 'flex'; 
    document.getElementById('btn-next-quiz').style.display = 'none'; 
    document.getElementById('q-feedback').innerText = "";
    document.getElementById('q-desc-display').style.display = 'none';
    
    document.getElementById('q-text').innerText = currentQuizData.q;
}

function manualNextQuiz() {
    playSound('click'); 
    nextQuiz();
}

function submitAnswer(choice) {
    if (!currentQuizData) return;
    if (document.getElementById('btn-next-quiz').style.display === 'block') return;

    const realAns = currentQuizData.a.trim().toUpperCase();
    player.totalTurns++; // ì „ì²´ í„´ ì¦ê°€ (ì‹œê°„ íë¦„)

    if (choice === realAns) {
        // [ì •ë‹µ] ë ˆë²¨ UP, íœ´ì‹ í„´ ì¦ê°€
        handleCorrect();
        currentQuizData.lv = Math.min(5, currentQuizData.lv + 1);
        // ê³µì‹: í˜„ì¬í„´ + (ë ˆë²¨*3 + 2) -> ë‚˜ì¤‘ì— ë“±ì¥
        currentQuizData.nextTurn = player.totalTurns + (currentQuizData.lv * 3) + 2; 
    } else {
        // [ì˜¤ë‹µ] ë ˆë²¨ ì´ˆê¸°í™”, ì¦‰ì‹œ ë“±ì¥, ì˜¤ë‹µì¹´ìš´íŠ¸ ì¦ê°€
        handleWrong();
        currentQuizData.lv = 0;
        currentQuizData.nextTurn = player.totalTurns; // ë°”ë¡œ ë‹¤ì‹œ ë“±ì¥
        currentQuizData.wrongCount++; // ì˜¤ë‹µ íšŸìˆ˜ ê¸°ë¡
    }

    // ë³€ê²½ëœ ë‹¨ì–´ ì •ë³´ DB ì €ì¥
    updateWordStats(currentQuizData);
    savePlayerStats(); // totalTurns ì €ì¥
}

function updateWordStats(word) {
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    store.put(word); // ìˆ˜ì •ëœ ì •ë³´ ì—…ë°ì´íŠ¸
}

function showResultUI() {
    const descDisplay = document.getElementById('q-desc-display');
    if (currentQuizData.desc && currentQuizData.desc.trim() !== "") {
        descDisplay.style.display = 'block';
        descDisplay.innerText = "ğŸ’¡ í•´ì„¤:\n" + currentQuizData.desc;
    } else {
        descDisplay.style.display = 'none';
    }
    document.getElementById('ox-buttons').style.display = 'none';
    const nextBtn = document.getElementById('btn-next-quiz');
    nextBtn.style.display = 'block';
    nextBtn.focus(); 
}

function handleCorrect() {
    playSound('correct');
    combo++;
    updateBuffUI();
    resetComboTimer(); 

    const rand = Math.random();
    let msg = "";
    if (rand < 0.4) { player.atk += 2; msg = "âš”ï¸ê³µ +2"; } 
    else if (rand < 0.7) { player.crit += 0.1; msg = "âš¡ì¹˜ëª… +0.1%"; } 
    else { player.cdmg += 1; msg = "ğŸ’ªì¹˜í”¼ +1%"; }
    
    updateStatUI();
    heroAttack(); 

    const fb = document.getElementById('q-feedback');
    fb.style.color = "var(--p)";
    fb.innerText = `ì •ë‹µ! (${msg})`;
    
    showResultUI(); 
}

function handleWrong() {
    playSound('wrong');
    combo = 0;
    updateBuffUI();
    if (comboTimer) clearTimeout(comboTimer);

    const fb = document.getElementById('q-feedback');
    fb.style.color = "var(--danger)";
    fb.innerText = `ì˜¤ë‹µ! ì •ë‹µ: ${currentQuizData.a}`;
    
    showResultUI(); 
}

function updateBuffUI() {
    const badge = document.getElementById('buff-badge');
    if (combo > 0) {
        badge.style.display = 'block';
        let totalAspd = player.aspd + (combo * 0.1);
        let finalAspd = Math.min(2.5, totalAspd);
        badge.innerText = `${combo}ì½¤ë³´ (ê³µì† ${finalAspd.toFixed(1)})`;
    } else {
        badge.style.display = 'none';
    }
}

function resetComboTimer() {
    if (comboTimer) clearTimeout(comboTimer);
    comboTimer = setTimeout(() => {
        if (combo > 0) {
            showToast("ì½¤ë³´ ì¢…ë£Œ", 'info');
            combo = 0;
            updateBuffUI();
        }
    }, 7000); 
}

// ============================================================
// [6. ì˜¤ë‹µ ë…¸íŠ¸ ì „ìš© ë¡œì§]
// ============================================================
function nextReview() {
    if (reviewQueue.length === 0) {
        alert("ëª¨ë“  ì˜¤ë‹µ ë¬¸ì œë¥¼ ë³µìŠµí–ˆìŠµë‹ˆë‹¤!");
        stopReview();
        return;
    }

    // íì—ì„œ í•˜ë‚˜ êº¼ëƒ„ (ì´ë¯¸ ì •ë ¬ë˜ì–´ ìˆìŒ)
    currentReviewData = reviewQueue.shift();
    
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('review-q-text').innerText = currentReviewData.q;
    document.getElementById('review-badge').innerText = `${currentReviewData.wrongCount}ë²ˆ í‹€ë¦¼`;
    
    // ë²„íŠ¼ ì´ˆê¸°í™”
    document.getElementById('review-ox-btns').style.display = 'flex';
    document.getElementById('btn-review-next').style.display = 'none';
    document.getElementById('review-feedback').innerText = "";
    document.getElementById('review-desc').style.display = 'none';
}

function submitReview(choice) {
    if(!currentReviewData) return;
    
    const realAns = currentReviewData.a.trim().toUpperCase();
    const fb = document.getElementById('review-feedback');
    
    if (choice === realAns) {
        playSound('correct');
        fb.style.color = "var(--p)";
        fb.innerText = "ì •ë‹µì…ë‹ˆë‹¤!";
    } else {
        playSound('wrong');
        fb.style.color = "var(--danger)";
        fb.innerText = `ì˜¤ë‹µ! ì •ë‹µì€ [${realAns}] ì…ë‹ˆë‹¤.`;
        // ì˜¤ë‹µë…¸íŠ¸ì—ì„œ ë˜ í‹€ë¦¬ë©´ ì¹´ìš´íŠ¸ ì¦ê°€
        currentReviewData.wrongCount++;
        updateWordStats(currentReviewData);
    }
    
    // í•´ì„¤ í‘œì‹œ
    if (currentReviewData.desc) {
        const desc = document.getElementById('review-desc');
        desc.style.display = 'block';
        desc.innerText = "ğŸ’¡ " + currentReviewData.desc;
    }
    
    document.getElementById('review-ox-btns').style.display = 'none';
    document.getElementById('btn-review-next').style.display = 'block';
}

// ============================================================
// [7. ì˜¤ë””ì˜¤ ë° ìœ í‹¸]
// ============================================================
function toggleSound() {
    isSoundOn = !isSoundOn;
    showToast(isSoundOn ? "ì‚¬ìš´ë“œ ON" : "ì‚¬ìš´ë“œ OFF");
}

const snd = {
    click: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'triangle'; o.frequency.setValueAtTime(600, t);
        g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.05);
    },
    attack: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(0.01, t + 0.1);
        g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.1);
    },
    correct: (t) => {
        const g = audioCtx.createGain(); g.gain.value = 0.1; g.connect(audioCtx.destination);
        [523.25, 659.25, 783.99].forEach((f, i) => { 
            const o = audioCtx.createOscillator(); o.type = 'sine'; o.frequency.value = f;
            o.connect(g); o.start(t + i * 0.05); o.stop(t + i * 0.05 + 0.1);
        });
    },
    wrong: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(50, t + 0.3);
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.3);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.3);
    },
    fail: (t) => {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(100, t + 1);
        g.gain.value = 0.1; o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 1);
    },
    clear: (t) => {
        const g = audioCtx.createGain(); g.gain.value = 0.1; g.connect(audioCtx.destination);
        [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
            const o = audioCtx.createOscillator(); o.type = 'square'; o.frequency.value = f;
            o.connect(g); o.start(t + i * 0.1); o.stop(t + i * 0.1 + 0.3);
        });
    }
};

function playSound(type) {
    if (!isSoundOn || !audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const t = audioCtx.currentTime;
    if (snd[type]) snd[type](t);
}

// í‚¤ë³´ë“œ ì§€ì›
window.addEventListener('keydown', (e) => {
    // ê²Œì„ í™”ë©´ì¼ ë•Œ
    if (document.getElementById('screen-game').classList.contains('active')) {
        if (e.key === 'ArrowLeft') submitAnswer('O');
        else if (e.key === 'ArrowRight') submitAnswer('X');
        else if (e.key === 'Enter') {
            if (document.getElementById('btn-next-quiz').style.display === 'block') manualNextQuiz();
        }
    }
    // ì˜¤ë‹µë…¸íŠ¸ í™”ë©´ì¼ ë•Œ
    else if (document.getElementById('screen-review').classList.contains('active')) {
        if (e.key === 'ArrowLeft') submitReview('O');
        else if (e.key === 'ArrowRight') submitReview('X');
        else if (e.key === 'Enter') {
            if (document.getElementById('btn-review-next').style.display === 'block') nextReview();
        }
    }
});

// ============================================================
// [8. ê´€ë¦¬ì ê¸°ëŠ¥ & DB IO]
// ============================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    if (id === 'manage') loadVocabulary(); 
}

function toggleExcel() {
    const el = document.getElementById('excel-area');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
}

function addTextWord() {
    const q = document.getElementById('new-q').value.trim();
    const desc = document.getElementById('new-desc').value.trim();
    const radios = document.getElementsByName('new-a-radio');
    let a = 'O';
    for(let r of radios) { if(r.checked) a = r.value; }

    if (!q) return showToast("ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”", 'error');
    
    // DB ì €ì¥ (ì´ˆê¸°ê°’ ì„¤ì •)
    const newWord = { 
        type: 'text', q: escapeHtml(q), a: a, desc: escapeHtml(desc),
        lv: 0, nextTurn: 0, wrongCount: 0 
    };
    saveToDB(newWord);
    
    document.getElementById('new-q').value = "";
    document.getElementById('new-desc').value = "";
    radios[0].checked = true; 
}

function parseExcel() {
    const val = document.getElementById('excel-input').value.trim();
    if (!val) return showToast("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", 'error');
    
    const lines = val.split(/\r?\n/).filter(line => line.trim() !== "");
    let count = 0;
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    
    lines.forEach(line => {
        let parts = line.split('\t');
        if (parts.length < 2) parts = line.split(/ {2,}/); 
        
        if (parts.length >= 2) {
            const q = parts[0].trim();
            let rawA = parts[1].trim().toUpperCase();
            if (rawA === '0') rawA = 'X';
            if (rawA === '1') rawA = 'O';
            const desc = parts[2] ? parts[2].trim() : ""; 
            
            if (q && (rawA === 'O' || rawA === 'X')) {
                store.add({ 
                    type: 'text', q: escapeHtml(q), a: rawA, desc: escapeHtml(desc),
                    lv: 0, nextTurn: 0, wrongCount: 0 
                });
                count++;
            }
        }
    });
    
    tx.oncomplete = () => {
        showToast(`${count}ê°œ ë“±ë¡ ì™„ë£Œ!`, 'success');
        document.getElementById('excel-input').value = "";
        toggleExcel();
        loadVocabulary(); 
    };
}

function saveToDB(data) {
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    store.add(data);
    tx.oncomplete = () => { showToast("ë“±ë¡ ì™„ë£Œ!"); loadVocabulary(); };
}

function renderWordList() {
    const list = document.getElementById('word-list');
    list.innerHTML = "";
    if (vocabulary.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
    }
    vocabulary.forEach(v => {
        const div = document.createElement('div');
        div.style = "background:#fff; padding:10px; border-radius:8px; margin-bottom:8px; display:flex; align-items:center; gap:10px; border:1px solid #eee; box-shadow:0 1px 3px rgba(0,0,0,0.05);";
        const check = document.createElement('input');
        check.type = "checkbox"; check.className = "word-check"; check.dataset.id = v.id;
        
        const ansColor = v.a === 'O' ? 'var(--o-color)' : 'var(--x-color)';
        const info = document.createElement('div');
        info.style = "flex:1; font-size:0.85rem; overflow:hidden;";
        info.innerHTML = `
            <div style="margin-bottom:4px; font-weight:bold; line-height:1.3;"><span style="color:${ansColor}">[${v.a}]</span> ${v.q}</div>
            <div style="font-size:0.7rem; color:#888; display:flex; gap:10px;">
                <span>Lv.${v.lv}</span> <span>ì˜¤ë‹µ: ${v.wrongCount}íšŒ</span>
            </div>
            ${v.desc ? `<div style="color:#666; font-size:0.75rem; background:#f5f5f5; padding:3px 6px; border-radius:4px; margin-top:4px;">ğŸ’¡ ${v.desc}</div>` : ""}
        `;
        div.appendChild(check); div.appendChild(info); list.appendChild(div);
    });
}

function deleteSelected() {
    const checks = document.querySelectorAll('.word-check:checked');
    if (checks.length === 0) return showToast("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
    if (!confirm(`${checks.length}ê°œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    const tx = db.transaction(['vocab'], 'readwrite');
    const store = tx.objectStore('vocab');
    checks.forEach(c => store.delete(Number(c.dataset.id)));
    tx.oncomplete = () => { showToast("ì‚­ì œë¨"); loadVocabulary(); };
}

function selectAll() {
    const checks = document.querySelectorAll('.word-check');
    const isAllChecked = Array.from(checks).every(c => c.checked);
    checks.forEach(c => c.checked = !isAllChecked);
}

function exportJSON() {
    if (vocabulary.length === 0) return showToast("ë°ì´í„° ì—†ìŒ");
    const data = JSON.stringify(vocabulary);
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `hero_ox_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(url);
}

function handleJsonFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) throw new Error();
            if (!confirm(`${imported.length}ê°œ ë³µêµ¬? (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)`)) return;
            const tx = db.transaction(['vocab'], 'readwrite');
            const store = tx.objectStore('vocab');
            imported.forEach(item => { 
                const newItem = { ...item }; delete newItem.id; 
                // ê¸°ì¡´ ë°±ì—… íŒŒì¼ì— ìƒˆ í•„ë“œê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ˆê¸°í™”
                if(typeof newItem.lv === 'undefined') newItem.lv = 0;
                if(typeof newItem.nextTurn === 'undefined') newItem.nextTurn = 0;
                if(typeof newItem.wrongCount === 'undefined') newItem.wrongCount = 0;
                store.add(newItem); 
            });
            tx.oncomplete = () => { showToast("ë³µêµ¬ ì™„ë£Œ"); loadVocabulary(); };
        } catch(err) { showToast("íŒŒì¼ ì˜¤ë¥˜", 'error'); }
    };
    reader.readAsText(file); e.target.value = ""; 
}

function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerText = msg;
    if (type === 'error') toast.style.background = "var(--danger)";
    if (type === 'success') toast.style.background = "#43a047";
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2500);
}
</script>
</body>
</html>
